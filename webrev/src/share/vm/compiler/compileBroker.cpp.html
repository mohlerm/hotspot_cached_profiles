<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/share/vm/compiler/compileBroker.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1999, 2015, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/symbolTable.hpp"
  27 #include "classfile/systemDictionary.hpp"
  28 #include "ci/ciCacheProfiles.hpp"
  29 #include "classfile/vmSymbols.hpp"
  30 #include "code/codeCache.hpp"
  31 #include "code/dependencyContext.hpp"
  32 #include "compiler/compileBroker.hpp"
  33 #include "compiler/compileLog.hpp"
  34 #include "compiler/compilerOracle.hpp"
  35 #include "compiler/directivesParser.hpp"
  36 #include "interpreter/linkResolver.hpp"
  37 #include "memory/allocation.inline.hpp"
  38 #include "oops/methodData.hpp"
  39 #include "oops/method.hpp"
  40 #include "oops/oop.inline.hpp"
  41 #include "prims/nativeLookup.hpp"
  42 #include "prims/whitebox.hpp"
  43 #include "runtime/arguments.hpp"
  44 #include "runtime/atomic.inline.hpp"
  45 #include "runtime/compilationPolicy.hpp"
  46 #include "runtime/init.hpp"
  47 #include "runtime/interfaceSupport.hpp"
  48 #include "runtime/javaCalls.hpp"
  49 #include "runtime/os.hpp"
  50 #include "runtime/sharedRuntime.hpp"
  51 #include "runtime/sweeper.hpp"
  52 #include "trace/tracing.hpp"
  53 #include "utilities/dtrace.hpp"
  54 #include "utilities/events.hpp"
  55 #ifdef COMPILER1
  56 #include "c1/c1_Compiler.hpp"
  57 #endif
  58 #if INCLUDE_JVMCI
  59 #include "jvmci/jvmciCompiler.hpp"
  60 #include "jvmci/jvmciRuntime.hpp"
  61 #include "jvmci/jvmciJavaClasses.hpp"
  62 #include "runtime/vframe.hpp"
  63 #endif
  64 #ifdef COMPILER2
  65 #include "opto/c2compiler.hpp"
  66 #endif
  67 #ifdef SHARK
  68 #include "shark/sharkCompiler.hpp"
  69 #endif
  70 
  71 #ifdef DTRACE_ENABLED
  72 
  73 // Only bother with this argument setup if dtrace is available
  74 
  75 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)             \
  76   {                                                                      \
  77     Symbol* klass_name = (method)-&gt;klass_name();                         \
  78     Symbol* name = (method)-&gt;name();                                     \
  79     Symbol* signature = (method)-&gt;signature();                           \
  80     HOTSPOT_METHOD_COMPILE_BEGIN(                                        \
  81       (char *) comp_name, strlen(comp_name),                             \
  82       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  83       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  84       (char *) signature-&gt;bytes(), signature-&gt;utf8_length());            \
  85   }
  86 
  87 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)      \
  88   {                                                                      \
  89     Symbol* klass_name = (method)-&gt;klass_name();                         \
  90     Symbol* name = (method)-&gt;name();                                     \
  91     Symbol* signature = (method)-&gt;signature();                           \
  92     HOTSPOT_METHOD_COMPILE_END(                                          \
  93       (char *) comp_name, strlen(comp_name),                             \
  94       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  95       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  96       (char *) signature-&gt;bytes(), signature-&gt;utf8_length(), (success)); \
  97   }
  98 
  99 #else //  ndef DTRACE_ENABLED
 100 
 101 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)
 102 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)
 103 
 104 #endif // ndef DTRACE_ENABLED
 105 
 106 bool CompileBroker::_initialized = false;
 107 volatile bool CompileBroker::_should_block = false;
 108 volatile jint CompileBroker::_print_compilation_warning = 0;
 109 volatile jint CompileBroker::_should_compile_new_jobs = run_compilation;
 110 
 111 // The installed compiler(s)
 112 AbstractCompiler* CompileBroker::_compilers[2];
 113 
 114 // These counters are used to assign an unique ID to each compilation.
 115 volatile jint CompileBroker::_compilation_id     = 0;
 116 volatile jint CompileBroker::_osr_compilation_id = 0;
 117 
 118 // Debugging information
 119 int  CompileBroker::_last_compile_type     = no_compile;
 120 int  CompileBroker::_last_compile_level    = CompLevel_none;
 121 char CompileBroker::_last_method_compiled[CompileBroker::name_buffer_length];
 122 
 123 // Performance counters
 124 PerfCounter* CompileBroker::_perf_total_compilation = NULL;
 125 PerfCounter* CompileBroker::_perf_osr_compilation = NULL;
 126 PerfCounter* CompileBroker::_perf_standard_compilation = NULL;
 127 
 128 PerfCounter* CompileBroker::_perf_total_bailout_count = NULL;
 129 PerfCounter* CompileBroker::_perf_total_invalidated_count = NULL;
 130 PerfCounter* CompileBroker::_perf_total_compile_count = NULL;
 131 PerfCounter* CompileBroker::_perf_total_osr_compile_count = NULL;
 132 PerfCounter* CompileBroker::_perf_total_standard_compile_count = NULL;
 133 
 134 PerfCounter* CompileBroker::_perf_sum_osr_bytes_compiled = NULL;
 135 PerfCounter* CompileBroker::_perf_sum_standard_bytes_compiled = NULL;
 136 PerfCounter* CompileBroker::_perf_sum_nmethod_size = NULL;
 137 PerfCounter* CompileBroker::_perf_sum_nmethod_code_size = NULL;
 138 
 139 PerfStringVariable* CompileBroker::_perf_last_method = NULL;
 140 PerfStringVariable* CompileBroker::_perf_last_failed_method = NULL;
 141 PerfStringVariable* CompileBroker::_perf_last_invalidated_method = NULL;
 142 PerfVariable*       CompileBroker::_perf_last_compile_type = NULL;
 143 PerfVariable*       CompileBroker::_perf_last_compile_size = NULL;
 144 PerfVariable*       CompileBroker::_perf_last_failed_type = NULL;
 145 PerfVariable*       CompileBroker::_perf_last_invalidated_type = NULL;
 146 
 147 // Timers and counters for generating statistics
 148 elapsedTimer CompileBroker::_t_total_compilation;
 149 elapsedTimer CompileBroker::_t_osr_compilation;
 150 elapsedTimer CompileBroker::_t_standard_compilation;
 151 elapsedTimer CompileBroker::_t_invalidated_compilation;
 152 elapsedTimer CompileBroker::_t_bailedout_compilation;
 153 
 154 int CompileBroker::_total_bailout_count          = 0;
 155 int CompileBroker::_total_invalidated_count      = 0;
 156 int CompileBroker::_total_compile_count          = 0;
 157 int CompileBroker::_total_osr_compile_count      = 0;
 158 int CompileBroker::_total_standard_compile_count = 0;
 159 
 160 int CompileBroker::_sum_osr_bytes_compiled       = 0;
 161 int CompileBroker::_sum_standard_bytes_compiled  = 0;
 162 int CompileBroker::_sum_nmethod_size             = 0;
 163 int CompileBroker::_sum_nmethod_code_size        = 0;
 164 
 165 long CompileBroker::_peak_compilation_time       = 0;
 166 
 167 CompileQueue* CompileBroker::_c2_compile_queue   = NULL;
 168 CompileQueue* CompileBroker::_c1_compile_queue   = NULL;
 169 
 170 class CompilationLog : public StringEventLog {
 171  public:
 172   CompilationLog() : StringEventLog("Compilation events") {
 173   }
 174 
 175   void log_compile(JavaThread* thread, CompileTask* task) {
 176     StringLogMessage lm;
 177     stringStream sstr = lm.stream();
 178     // msg.time_stamp().update_to(tty-&gt;time_stamp().ticks());
 179     task-&gt;print(&amp;sstr, NULL, true, false);
 180     log(thread, "%s", (const char*)lm);
 181   }
 182 
 183   void log_nmethod(JavaThread* thread, nmethod* nm) {
 184     log(thread, "nmethod %d%s " INTPTR_FORMAT " code [" INTPTR_FORMAT ", " INTPTR_FORMAT "]",
 185         nm-&gt;compile_id(), nm-&gt;is_osr_method() ? "%" : "",
 186         p2i(nm), p2i(nm-&gt;code_begin()), p2i(nm-&gt;code_end()));
 187   }
 188 
 189   void log_failure(JavaThread* thread, CompileTask* task, const char* reason, const char* retry_message) {
 190     StringLogMessage lm;
 191     lm.print("%4d   COMPILE SKIPPED: %s", task-&gt;compile_id(), reason);
 192     if (retry_message != NULL) {
 193       lm.append(" (%s)", retry_message);
 194     }
 195     lm.print("\n");
 196     log(thread, "%s", (const char*)lm);
 197   }
 198 
 199   void log_metaspace_failure(const char* reason) {
 200     ResourceMark rm;
 201     StringLogMessage lm;
 202     lm.print("%4d   COMPILE PROFILING SKIPPED: %s", -1, reason);
 203     lm.print("\n");
 204     log(JavaThread::current(), "%s", (const char*)lm);
 205   }
 206 };
 207 
 208 static CompilationLog* _compilation_log = NULL;
 209 
 210 bool compileBroker_init() {
 211   if (LogEvents) {
 212     _compilation_log = new CompilationLog();
 213   }
 214 
 215   // init directives stack, adding default directive
 216   DirectivesStack::init();
 217 
 218   if (DirectivesParser::has_file()) {
 219     return DirectivesParser::parse_from_flag();
 220   } else if (CompilerDirectivesPrint) {
 221     // Print default directive even when no other was added
 222     DirectivesStack::print(tty);
 223   }
 224 
 225   return true;
 226 }
 227 
 228 CompileTaskWrapper::CompileTaskWrapper(CompileTask* task) {
 229   CompilerThread* thread = CompilerThread::current();
 230   thread-&gt;set_task(task);
 231 #if INCLUDE_JVMCI
 232   if (task-&gt;is_blocking() &amp;&amp; CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 233     task-&gt;set_jvmci_compiler_thread(thread);
 234   }
 235 #endif
 236   CompileLog*     log  = thread-&gt;log();
 237   if (log != NULL)  task-&gt;log_task_start(log);
 238 }
 239 
 240 CompileTaskWrapper::~CompileTaskWrapper() {
 241   CompilerThread* thread = CompilerThread::current();
 242   CompileTask* task = thread-&gt;task();
 243   CompileLog*  log  = thread-&gt;log();
 244   if (log != NULL)  task-&gt;log_task_done(log);
 245   thread-&gt;set_task(NULL);
 246   task-&gt;set_code_handle(NULL);
 247   thread-&gt;set_env(NULL);
 248   if (task-&gt;is_blocking()) {
 249     bool free_task = false;
 250     {
 251       MutexLocker notifier(task-&gt;lock(), thread);
 252       task-&gt;mark_complete();
 253 #if INCLUDE_JVMCI
 254       if (CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 255         if (!task-&gt;has_waiter()) {
 256           // The waiting thread timed out and thus did not free the task.
 257           free_task = true;
 258         }
 259         task-&gt;set_jvmci_compiler_thread(NULL);
 260       }
 261 #endif
 262       if (!free_task) {
 263         // Notify the waiting thread that the compilation has completed
 264         // so that it can free the task.
 265         task-&gt;lock()-&gt;notify_all();
 266       }
 267     }
 268     if (free_task) {
 269       // The task can only be freed once the task lock is released.
 270       CompileTask::free(task);
 271     }
 272   } else {
 273     task-&gt;mark_complete();
 274 
 275     // By convention, the compiling thread is responsible for
 276     // recycling a non-blocking CompileTask.
 277     CompileTask::free(task);
 278   }
 279 }
 280 
 281 /**
 282  * Add a CompileTask to a CompileQueue.
 283  */
 284 void CompileQueue::add(CompileTask* task) {
 285   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 286 
 287   task-&gt;set_next(NULL);
 288   task-&gt;set_prev(NULL);
 289 
 290   if (_last == NULL) {
 291     // The compile queue is empty.
 292     assert(_first == NULL, "queue is empty");
 293     _first = task;
 294     _last = task;
 295   } else {
 296     // Append the task to the queue.
 297     assert(_last-&gt;next() == NULL, "not last");
 298     _last-&gt;set_next(task);
 299     task-&gt;set_prev(_last);
 300     _last = task;
 301   }
 302   ++_size;
 303 
 304   // Mark the method as being in the compile queue.
 305   task-&gt;method()-&gt;set_queued_for_compilation();
 306 
 307   if (CIPrintCompileQueue) {
 308     print_tty();
 309   }
 310   if (PrintCompileQueueSize) {
 311     tty-&gt;print_cr("%d - Size of %s: %d", (int) tty-&gt;time_stamp().milliseconds(), name(),_size);
 312   }
 313 
 314   if (LogCompilation &amp;&amp; xtty != NULL) {
 315     task-&gt;log_task_queued();
 316   }
 317 
 318   // Notify CompilerThreads that a task is available.
 319   MethodCompileQueue_lock-&gt;notify_all();
 320 }
 321 
 322 /**
 323  * Empties compilation queue by putting all compilation tasks onto
 324  * a freelist. Furthermore, the method wakes up all threads that are
 325  * waiting on a compilation task to finish. This can happen if background
 326  * compilation is disabled.
 327  */
 328 void CompileQueue::free_all() {
 329   MutexLocker mu(MethodCompileQueue_lock);
 330   CompileTask* next = _first;
 331 
 332   // Iterate over all tasks in the compile queue
 333   while (next != NULL) {
 334     CompileTask* current = next;
 335     next = current-&gt;next();
 336     {
 337       // Wake up thread that blocks on the compile task.
 338       MutexLocker ct_lock(current-&gt;lock());
 339       current-&gt;lock()-&gt;notify();
 340     }
 341     // Put the task back on the freelist.
 342     CompileTask::free(current);
 343   }
 344   _first = NULL;
 345 
 346   // Wake up all threads that block on the queue.
 347   MethodCompileQueue_lock-&gt;notify_all();
 348 }
 349 
 350 /**
 351  * Get the next CompileTask from a CompileQueue
 352  */
 353 CompileTask* CompileQueue::get() {
 354   // save methods from RedefineClasses across safepoint
 355   // across MethodCompileQueue_lock below.
 356   methodHandle save_method;
 357   methodHandle save_hot_method;
 358 
 359   MutexLocker locker(MethodCompileQueue_lock);
 360   // If _first is NULL we have no more compile jobs. There are two reasons for
 361   // having no compile jobs: First, we compiled everything we wanted. Second,
 362   // we ran out of code cache so compilation has been disabled. In the latter
 363   // case we perform code cache sweeps to free memory such that we can re-enable
 364   // compilation.
 365   while (_first == NULL) {
 366     // Exit loop if compilation is disabled forever
 367     if (CompileBroker::is_compilation_disabled_forever()) {
 368       return NULL;
 369     }
 370 
 371     // If there are no compilation tasks and we can compile new jobs
 372     // (i.e., there is enough free space in the code cache) there is
 373     // no need to invoke the sweeper. As a result, the hotness of methods
 374     // remains unchanged. This behavior is desired, since we want to keep
 375     // the stable state, i.e., we do not want to evict methods from the
 376     // code cache if it is unnecessary.
 377     // We need a timed wait here, since compiler threads can exit if compilation
 378     // is disabled forever. We use 5 seconds wait time; the exiting of compiler threads
 379     // is not critical and we do not want idle compiler threads to wake up too often.
 380     MethodCompileQueue_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 5*1000);
 381   }
 382 
 383   if (CompileBroker::is_compilation_disabled_forever()) {
 384     return NULL;
 385   }
 386 
 387   CompileTask* task;
 388   {
 389     NoSafepointVerifier nsv;
 390     task = CompilationPolicy::policy()-&gt;select_task(this);
 391   }
 392 
 393   // Save method pointers across unlock safepoint.  The task is removed from
 394   // the compilation queue, which is walked during RedefineClasses.
 395   save_method = methodHandle(task-&gt;method());
 396   save_hot_method = methodHandle(task-&gt;hot_method());
 397 
 398   remove(task);
 399   purge_stale_tasks(); // may temporarily release MCQ lock
 400 
 401   return task;
 402 }
 403 
 404 // Clean &amp; deallocate stale compile tasks.
 405 // Temporarily releases MethodCompileQueue lock.
 406 void CompileQueue::purge_stale_tasks() {
 407   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 408   if (_first_stale != NULL) {
 409     // Stale tasks are purged when MCQ lock is released,
 410     // but _first_stale updates are protected by MCQ lock.
 411     // Once task processing starts and MCQ lock is released,
 412     // other compiler threads can reuse _first_stale.
 413     CompileTask* head = _first_stale;
 414     _first_stale = NULL;
 415     {
 416       MutexUnlocker ul(MethodCompileQueue_lock);
 417       for (CompileTask* task = head; task != NULL; ) {
 418         CompileTask* next_task = task-&gt;next();
 419         CompileTaskWrapper ctw(task); // Frees the task
 420         task-&gt;set_failure_reason("stale task");
 421         task = next_task;
 422       }
 423     }
 424   }
 425 }
 426 
 427 void CompileQueue::remove(CompileTask* task) {
 428    assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 429   if (task-&gt;prev() != NULL) {
 430     task-&gt;prev()-&gt;set_next(task-&gt;next());
 431   } else {
 432     // max is the first element
 433     assert(task == _first, "Sanity");
 434     _first = task-&gt;next();
 435   }
 436 
 437   if (task-&gt;next() != NULL) {
 438     task-&gt;next()-&gt;set_prev(task-&gt;prev());
 439   } else {
 440     // max is the last element
 441     assert(task == _last, "Sanity");
 442     _last = task-&gt;prev();
 443   }
 444   --_size;
 445 }
 446 
 447 void CompileQueue::remove_and_mark_stale(CompileTask* task) {
 448   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 449   remove(task);
 450 
 451   // Enqueue the task for reclamation (should be done outside MCQ lock)
 452   task-&gt;set_next(_first_stale);
 453   task-&gt;set_prev(NULL);
 454   _first_stale = task;
 455 }
 456 
 457 // methods in the compile queue need to be marked as used on the stack
 458 // so that they don't get reclaimed by Redefine Classes
 459 void CompileQueue::mark_on_stack() {
 460   CompileTask* task = _first;
 461   while (task != NULL) {
 462     task-&gt;mark_on_stack();
 463     task = task-&gt;next();
 464   }
 465 }
 466 
 467 
 468 CompileQueue* CompileBroker::compile_queue(int comp_level) {
 469   if (is_c2_compile(comp_level)) return _c2_compile_queue;
 470   if (is_c1_compile(comp_level)) return _c1_compile_queue;
 471   return NULL;
 472 }
 473 
 474 void CompileBroker::print_compile_queues(outputStream* st) {
 475   st-&gt;print_cr("Current compiles: ");
 476   MutexLocker locker(MethodCompileQueue_lock);
 477 
 478   char buf[2000];
 479   int buflen = sizeof(buf);
 480   Threads::print_threads_compiling(st, buf, buflen);
 481 
 482   st-&gt;cr();
 483   if (_c1_compile_queue != NULL) {
 484     _c1_compile_queue-&gt;print(st);
 485   }
 486   if (_c2_compile_queue != NULL) {
 487     _c2_compile_queue-&gt;print(st);
 488   }
 489 }
 490 
 491 void CompileQueue::print(outputStream* st) {
 492   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 493   st-&gt;print_cr("%s:", name());
 494   CompileTask* task = _first;
 495   if (task == NULL) {
 496     st-&gt;print_cr("Empty");
 497   } else {
 498     while (task != NULL) {
 499       task-&gt;print(st, NULL, true, true);
 500       task = task-&gt;next();
 501     }
 502   }
 503   st-&gt;cr();
 504 }
 505 
 506 void CompileQueue::print_tty() {
 507   ttyLocker ttyl;
 508   print(tty);
 509 }
 510 
 511 CompilerCounters::CompilerCounters() {
 512   _current_method[0] = '\0';
 513   _compile_type = CompileBroker::no_compile;
 514 }
 515 
 516 // ------------------------------------------------------------------
 517 // CompileBroker::compilation_init
 518 //
 519 // Initialize the Compilation object
 520 void CompileBroker::compilation_init(TRAPS) {
 521   _last_method_compiled[0] = '\0';
 522 
 523   // No need to initialize compilation system if we do not use it.
 524   if (!UseCompiler) {
 525     return;
 526   }
 527 #ifndef SHARK
 528   // Set the interface to the current compiler(s).
 529   int c1_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_simple);
 530   int c2_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_full_optimization);
 531 
 532 #if INCLUDE_JVMCI
 533   if (EnableJVMCI) {
 534     // This is creating a JVMCICompiler singleton.
 535     JVMCICompiler* jvmci = new JVMCICompiler();
 536 
 537     if (UseJVMCICompiler) {
 538       _compilers[1] = jvmci;
 539       if (FLAG_IS_DEFAULT(JVMCIThreads)) {
 540         if (BootstrapJVMCI) {
 541           // JVMCI will bootstrap so give it more threads
 542           c2_count = MIN2(32, os::active_processor_count());
 543         }
 544       } else {
 545         c2_count = JVMCIThreads;
 546       }
 547       if (FLAG_IS_DEFAULT(JVMCIHostThreads)) {
 548       } else {
 549         c1_count = JVMCIHostThreads;
 550       }
 551 
 552       if (!UseInterpreter || !BackgroundCompilation) {
 553         // Force initialization of JVMCI compiler otherwise JVMCI
 554         // compilations will not block until JVMCI is initialized
 555         ResourceMark rm;
 556         TempNewSymbol getCompiler = SymbolTable::new_symbol("getCompiler", CHECK);
 557         TempNewSymbol sig = SymbolTable::new_symbol("()Ljdk/vm/ci/runtime/JVMCICompiler;", CHECK);
 558         Handle jvmciRuntime = JVMCIRuntime::get_HotSpotJVMCIRuntime(CHECK);
 559         JavaValue result(T_OBJECT);
 560         JavaCalls::call_virtual(&amp;result, jvmciRuntime, HotSpotJVMCIRuntime::klass(), getCompiler, sig, CHECK);
 561       }
 562     }
 563   }
 564 #endif // INCLUDE_JVMCI
 565 
 566 #ifdef COMPILER1
 567   if (c1_count &gt; 0) {
 568     _compilers[0] = new Compiler();
 569   }
 570 #endif // COMPILER1
 571 
 572 #ifdef COMPILER2
 573   if (true JVMCI_ONLY( &amp;&amp; !UseJVMCICompiler)) {
 574     if (c2_count &gt; 0) {
 575       _compilers[1] = new C2Compiler();
 576     }
 577   }
 578 #endif // COMPILER2
 579 
 580 #else // SHARK
 581   int c1_count = 0;
 582   int c2_count = 1;
 583 
 584   _compilers[1] = new SharkCompiler();
 585 #endif // SHARK
 586 
 587   // Start the compiler thread(s) and the sweeper thread
 588   init_compiler_sweeper_threads(c1_count, c2_count);
 589   // totalTime performance counter is always created as it is required
 590   // by the implementation of java.lang.management.CompilationMBean.
 591   {
 592     EXCEPTION_MARK;
 593     _perf_total_compilation =
 594                  PerfDataManager::create_counter(JAVA_CI, "totalTime",
 595                                                  PerfData::U_Ticks, CHECK);
 596   }
 597 
 598   if (UsePerfData) {
 599 
 600     EXCEPTION_MARK;
 601 
 602     // create the jvmstat performance counters
 603     _perf_osr_compilation =
 604                  PerfDataManager::create_counter(SUN_CI, "osrTime",
 605                                                  PerfData::U_Ticks, CHECK);
 606 
 607     _perf_standard_compilation =
 608                  PerfDataManager::create_counter(SUN_CI, "standardTime",
 609                                                  PerfData::U_Ticks, CHECK);
 610 
 611     _perf_total_bailout_count =
 612                  PerfDataManager::create_counter(SUN_CI, "totalBailouts",
 613                                                  PerfData::U_Events, CHECK);
 614 
 615     _perf_total_invalidated_count =
 616                  PerfDataManager::create_counter(SUN_CI, "totalInvalidates",
 617                                                  PerfData::U_Events, CHECK);
 618 
 619     _perf_total_compile_count =
 620                  PerfDataManager::create_counter(SUN_CI, "totalCompiles",
 621                                                  PerfData::U_Events, CHECK);
 622     _perf_total_osr_compile_count =
 623                  PerfDataManager::create_counter(SUN_CI, "osrCompiles",
 624                                                  PerfData::U_Events, CHECK);
 625 
 626     _perf_total_standard_compile_count =
 627                  PerfDataManager::create_counter(SUN_CI, "standardCompiles",
 628                                                  PerfData::U_Events, CHECK);
 629 
 630     _perf_sum_osr_bytes_compiled =
 631                  PerfDataManager::create_counter(SUN_CI, "osrBytes",
 632                                                  PerfData::U_Bytes, CHECK);
 633 
 634     _perf_sum_standard_bytes_compiled =
 635                  PerfDataManager::create_counter(SUN_CI, "standardBytes",
 636                                                  PerfData::U_Bytes, CHECK);
 637 
 638     _perf_sum_nmethod_size =
 639                  PerfDataManager::create_counter(SUN_CI, "nmethodSize",
 640                                                  PerfData::U_Bytes, CHECK);
 641 
 642     _perf_sum_nmethod_code_size =
 643                  PerfDataManager::create_counter(SUN_CI, "nmethodCodeSize",
 644                                                  PerfData::U_Bytes, CHECK);
 645 
 646     _perf_last_method =
 647                  PerfDataManager::create_string_variable(SUN_CI, "lastMethod",
 648                                        CompilerCounters::cmname_buffer_length,
 649                                        "", CHECK);
 650 
 651     _perf_last_failed_method =
 652             PerfDataManager::create_string_variable(SUN_CI, "lastFailedMethod",
 653                                        CompilerCounters::cmname_buffer_length,
 654                                        "", CHECK);
 655 
 656     _perf_last_invalidated_method =
 657         PerfDataManager::create_string_variable(SUN_CI, "lastInvalidatedMethod",
 658                                      CompilerCounters::cmname_buffer_length,
 659                                      "", CHECK);
 660 
 661     _perf_last_compile_type =
 662              PerfDataManager::create_variable(SUN_CI, "lastType",
 663                                               PerfData::U_None,
 664                                               (jlong)CompileBroker::no_compile,
 665                                               CHECK);
 666 
 667     _perf_last_compile_size =
 668              PerfDataManager::create_variable(SUN_CI, "lastSize",
 669                                               PerfData::U_Bytes,
 670                                               (jlong)CompileBroker::no_compile,
 671                                               CHECK);
 672 
 673 
 674     _perf_last_failed_type =
 675              PerfDataManager::create_variable(SUN_CI, "lastFailedType",
 676                                               PerfData::U_None,
 677                                               (jlong)CompileBroker::no_compile,
 678                                               CHECK);
 679 
 680     _perf_last_invalidated_type =
 681          PerfDataManager::create_variable(SUN_CI, "lastInvalidatedType",
 682                                           PerfData::U_None,
 683                                           (jlong)CompileBroker::no_compile,
 684                                           CHECK);
 685   }
 686 
 687   _initialized = true;
 688 }
 689 
 690 
 691 JavaThread* CompileBroker::make_thread(const char* name, CompileQueue* queue, CompilerCounters* counters,
 692                                        AbstractCompiler* comp, bool compiler_thread, TRAPS) {
 693   JavaThread* thread = NULL;
 694   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK_0);
 695   instanceKlassHandle klass (THREAD, k);
 696   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK_0);
 697   Handle string = java_lang_String::create_from_str(name, CHECK_0);
 698 
 699   // Initialize thread_oop to put it into the system threadGroup
 700   Handle thread_group (THREAD,  Universe::system_thread_group());
 701   JavaValue result(T_VOID);
 702   JavaCalls::call_special(&amp;result, thread_oop,
 703                        klass,
 704                        vmSymbols::object_initializer_name(),
 705                        vmSymbols::threadgroup_string_void_signature(),
 706                        thread_group,
 707                        string,
 708                        CHECK_0);
 709 
 710   {
 711     MutexLocker mu(Threads_lock, THREAD);
 712     if (compiler_thread) {
 713       thread = new CompilerThread(queue, counters);
 714     } else {
 715       thread = new CodeCacheSweeperThread();
 716     }
 717     // At this point the new CompilerThread data-races with this startup
 718     // thread (which I believe is the primoridal thread and NOT the VM
 719     // thread).  This means Java bytecodes being executed at startup can
 720     // queue compile jobs which will run at whatever default priority the
 721     // newly created CompilerThread runs at.
 722 
 723 
 724     // At this point it may be possible that no osthread was created for the
 725     // JavaThread due to lack of memory. We would have to throw an exception
 726     // in that case. However, since this must work and we do not allow
 727     // exceptions anyway, check and abort if this fails.
 728 
 729     if (thread == NULL || thread-&gt;osthread() == NULL) {
 730       vm_exit_during_initialization("java.lang.OutOfMemoryError",
 731                                     os::native_thread_creation_failed_msg());
 732     }
 733 
 734     java_lang_Thread::set_thread(thread_oop(), thread);
 735 
 736     // Note that this only sets the JavaThread _priority field, which by
 737     // definition is limited to Java priorities and not OS priorities.
 738     // The os-priority is set in the CompilerThread startup code itself
 739 
 740     java_lang_Thread::set_priority(thread_oop(), NearMaxPriority);
 741 
 742     // Note that we cannot call os::set_priority because it expects Java
 743     // priorities and we are *explicitly* using OS priorities so that it's
 744     // possible to set the compiler thread priority higher than any Java
 745     // thread.
 746 
 747     int native_prio = CompilerThreadPriority;
 748     if (native_prio == -1) {
 749       if (UseCriticalCompilerThreadPriority) {
 750         native_prio = os::java_to_os_priority[CriticalPriority];
 751       } else {
 752         native_prio = os::java_to_os_priority[NearMaxPriority];
 753       }
 754     }
 755     os::set_native_priority(thread, native_prio);
 756 
 757     java_lang_Thread::set_daemon(thread_oop());
 758 
 759     thread-&gt;set_threadObj(thread_oop());
 760     if (compiler_thread) {
 761       thread-&gt;as_CompilerThread()-&gt;set_compiler(comp);
 762     }
 763     Threads::add(thread);
 764     Thread::start(thread);
 765   }
 766 
 767   // Let go of Threads_lock before yielding
 768   os::naked_yield(); // make sure that the compiler thread is started early (especially helpful on SOLARIS)
 769 
 770   return thread;
 771 }
 772 
 773 
 774 void CompileBroker::init_compiler_sweeper_threads(int c1_compiler_count, int c2_compiler_count) {
 775   EXCEPTION_MARK;
 776 #if !defined(ZERO) &amp;&amp; !defined(SHARK)
 777   assert(c2_compiler_count &gt; 0 || c1_compiler_count &gt; 0, "No compilers?");
 778 #endif // !ZERO &amp;&amp; !SHARK
 779   // Initialize the compilation queue
 780   if (c2_compiler_count &gt; 0) {
 781     _c2_compile_queue  = new CompileQueue("C2 compile queue");
 782     _compilers[1]-&gt;set_num_compiler_threads(c2_compiler_count);
 783   }
 784   if (c1_compiler_count &gt; 0) {
 785     _c1_compile_queue  = new CompileQueue("C1 compile queue");
 786     _compilers[0]-&gt;set_num_compiler_threads(c1_compiler_count);
 787   }
 788 
 789   int compiler_count = c1_compiler_count + c2_compiler_count;
 790 
 791   char name_buffer[256];
 792   const bool compiler_thread = true;
 793   for (int i = 0; i &lt; c2_compiler_count; i++) {
 794     // Create a name for our thread.
 795     sprintf(name_buffer, "%s CompilerThread%d", _compilers[1]-&gt;name(), i);
 796     CompilerCounters* counters = new CompilerCounters();
 797     // Shark and C2
 798     make_thread(name_buffer, _c2_compile_queue, counters, _compilers[1], compiler_thread, CHECK);
 799   }
 800 
 801   for (int i = c2_compiler_count; i &lt; compiler_count; i++) {
 802     // Create a name for our thread.
 803     sprintf(name_buffer, "C1 CompilerThread%d", i);
 804     CompilerCounters* counters = new CompilerCounters();
 805     // C1
 806     make_thread(name_buffer, _c1_compile_queue, counters, _compilers[0], compiler_thread, CHECK);
 807   }
 808 
 809   if (UsePerfData) {
 810     PerfDataManager::create_constant(SUN_CI, "threads", PerfData::U_Bytes, compiler_count, CHECK);
 811   }
 812 
 813   if (MethodFlushing) {
 814     // Initialize the sweeper thread
 815     make_thread("Sweeper thread", NULL, NULL, NULL, false, CHECK);
 816   }
 817 }
 818 
 819 
 820 /**
 821  * Set the methods on the stack as on_stack so that redefine classes doesn't
 822  * reclaim them. This method is executed at a safepoint.
 823  */
 824 void CompileBroker::mark_on_stack() {
 825   assert(SafepointSynchronize::is_at_safepoint(), "sanity check");
 826   // Since we are at a safepoint, we do not need a lock to access
 827   // the compile queues.
 828   if (_c2_compile_queue != NULL) {
 829     _c2_compile_queue-&gt;mark_on_stack();
 830   }
 831   if (_c1_compile_queue != NULL) {
 832     _c1_compile_queue-&gt;mark_on_stack();
 833   }
 834 }
 835 
 836 // ------------------------------------------------------------------
 837 // CompileBroker::compile_method
 838 //
 839 // Request compilation of a method.
 840 void CompileBroker::compile_method_base(const methodHandle&amp; method,
 841                                         int osr_bci,
 842                                         int comp_level,
 843                                         const methodHandle&amp; hot_method,
 844                                         int hot_count,
 845                                         const char* comment,
 846                                         Thread* thread) {
 847   // do nothing if compiler thread(s) is not available
 848   if (!_initialized) {
 849     return;
 850   }
 851 
 852   guarantee(!method-&gt;is_abstract(), "cannot compile abstract methods");
 853   assert(method-&gt;method_holder()-&gt;is_instance_klass(),
 854          "sanity check");
 855   assert(!method-&gt;method_holder()-&gt;is_not_initialized(),
 856          "method holder must be initialized");
 857   assert(!method-&gt;is_method_handle_intrinsic(), "do not enqueue these guys");
 858 
 859   if (CIPrintRequests) {
 860     tty-&gt;print("request: ");
 861     method-&gt;print_short_name(tty);
 862     if (osr_bci != InvocationEntryBci) {
 863       tty-&gt;print(" osr_bci: %d", osr_bci);
 864     }
 865     tty-&gt;print(" level: %d comment: %s count: %d", comp_level, comment, hot_count);
 866     if (!hot_method.is_null()) {
 867       tty-&gt;print(" hot: ");
 868       if (hot_method() != method()) {
 869           hot_method-&gt;print_short_name(tty);
 870       } else {
 871         tty-&gt;print("yes");
 872       }
 873     }
 874     tty-&gt;cr();
 875   }
 876 
 877   // A request has been made for compilation.  Before we do any
 878   // real work, check to see if the method has been compiled
 879   // in the meantime with a definitive result.
 880   if (compilation_is_complete(method, osr_bci, comp_level)) {
 881     return;
 882   }
 883 
 884 #ifndef PRODUCT
 885   if (osr_bci != -1 &amp;&amp; !FLAG_IS_DEFAULT(OSROnlyBCI)) {
 886     if ((OSROnlyBCI &gt; 0) ? (OSROnlyBCI != osr_bci) : (-OSROnlyBCI == osr_bci)) {
 887       // Positive OSROnlyBCI means only compile that bci.  Negative means don't compile that BCI.
 888       return;
 889     }
 890   }
 891 #endif
 892 
 893   // If this method is already in the compile queue, then
 894   // we do not block the current thread.
 895   if (compilation_is_in_queue(method)) {
 896     // We may want to decay our counter a bit here to prevent
 897     // multiple denied requests for compilation.  This is an
 898     // open compilation policy issue. Note: The other possibility,
 899     // in the case that this is a blocking compile request, is to have
 900     // all subsequent blocking requesters wait for completion of
 901     // ongoing compiles. Note that in this case we'll need a protocol
 902     // for freeing the associated compile tasks. [Or we could have
 903     // a single static monitor on which all these waiters sleep.]
 904     return;
 905   }
 906 
 907   // If the requesting thread is holding the pending list lock
 908   // then we just return. We can't risk blocking while holding
 909   // the pending list lock or a 3-way deadlock may occur
 910   // between the reference handler thread, a GC (instigated
 911   // by a compiler thread), and compiled method registration.
 912   if (InstanceRefKlass::owns_pending_list_lock(JavaThread::current())) {
 913     return;
 914   }
 915 
 916   if (TieredCompilation) {
 917     // Tiered policy requires MethodCounters to exist before adding a method to
 918     // the queue. Create if we don't have them yet.
 919     method-&gt;get_method_counters(thread);
 920   }
 921 
 922   // Outputs from the following MutexLocker block:
 923   CompileTask* task     = NULL;
 924   bool         blocking = false;
 925   CompileQueue* queue  = compile_queue(comp_level);
 926 
 927   // Acquire our lock.
 928   {
 929     MutexLocker locker(MethodCompileQueue_lock, thread);
 930 
 931     // Make sure the method has not slipped into the queues since
 932     // last we checked; note that those checks were "fast bail-outs".
 933     // Here we need to be more careful, see 14012000 below.
 934     if (compilation_is_in_queue(method)) {
 935       return;
 936     }
 937 
 938     // We need to check again to see if the compilation has
 939     // completed.  A previous compilation may have registered
 940     // some result.
 941     if (compilation_is_complete(method, osr_bci, comp_level)) {
 942       return;
 943     }
 944 
 945     // We now know that this compilation is not pending, complete,
 946     // or prohibited.  Assign a compile_id to this compilation
 947     // and check to see if it is in our [Start..Stop) range.
 948     int compile_id = assign_compile_id(method, osr_bci);
 949     if (compile_id == 0) {
 950       // The compilation falls outside the allowed range.
 951       return;
 952     }
 953 
 954     // Should this thread wait for completion of the compile?
 955     blocking = is_compile_blocking();
 956 
 957 #if INCLUDE_JVMCI
 958     if (UseJVMCICompiler) {
 959       if (blocking) {
 960         // Don't allow blocking compiles for requests triggered by JVMCI.
 961         if (thread-&gt;is_Compiler_thread()) {
 962           blocking = false;
 963         }
 964 
 965         // Don't allow blocking compiles if inside a class initializer or while performing class loading
 966         vframeStream vfst((JavaThread*) thread);
 967         for (; !vfst.at_end(); vfst.next()) {
 968           if (vfst.method()-&gt;is_static_initializer() ||
 969               (vfst.method()-&gt;method_holder()-&gt;is_subclass_of(SystemDictionary::ClassLoader_klass()) &amp;&amp;
 970                   vfst.method()-&gt;name() == vmSymbols::loadClass_name())) {
 971             blocking = false;
 972             break;
 973           }
 974         }
 975 
 976         // Don't allow blocking compilation requests to JVMCI
 977         // if JVMCI itself is not yet initialized
 978         if (!JVMCIRuntime::is_HotSpotJVMCIRuntime_initialized() &amp;&amp; compiler(comp_level)-&gt;is_jvmci()) {
 979           blocking = false;
 980         }
 981 
 982         // Don't allow blocking compilation requests if we are in JVMCIRuntime::shutdown
 983         // to avoid deadlock between compiler thread(s) and threads run at shutdown
 984         // such as the DestroyJavaVM thread.
 985         if (JVMCIRuntime::shutdown_called()) {
 986           blocking = false;
 987         }
 988       }
 989     }
 990 #endif // INCLUDE_JVMCI
 991 
 992     // We will enter the compilation in the queue.
 993     // 14012000: Note that this sets the queued_for_compile bits in
 994     // the target method. We can now reason that a method cannot be
 995     // queued for compilation more than once, as follows:
 996     // Before a thread queues a task for compilation, it first acquires
 997     // the compile queue lock, then checks if the method's queued bits
 998     // are set or it has already been compiled. Thus there can not be two
 999     // instances of a compilation task for the same method on the
1000     // compilation queue. Consider now the case where the compilation
1001     // thread has already removed a task for that method from the queue
1002     // and is in the midst of compiling it. In this case, the
1003     // queued_for_compile bits must be set in the method (and these
1004     // will be visible to the current thread, since the bits were set
1005     // under protection of the compile queue lock, which we hold now.
1006     // When the compilation completes, the compiler thread first sets
1007     // the compilation result and then clears the queued_for_compile
1008     // bits. Neither of these actions are protected by a barrier (or done
1009     // under the protection of a lock), so the only guarantee we have
1010     // (on machines with TSO (Total Store Order)) is that these values
1011     // will update in that order. As a result, the only combinations of
1012     // these bits that the current thread will see are, in temporal order:
1013     // &lt;RESULT, QUEUE&gt; :
1014     //     &lt;0, 1&gt; : in compile queue, but not yet compiled
1015     //     &lt;1, 1&gt; : compiled but queue bit not cleared
1016     //     &lt;1, 0&gt; : compiled and queue bit cleared
1017     // Because we first check the queue bits then check the result bits,
1018     // we are assured that we cannot introduce a duplicate task.
1019     // Note that if we did the tests in the reverse order (i.e. check
1020     // result then check queued bit), we could get the result bit before
1021     // the compilation completed, and the queue bit after the compilation
1022     // completed, and end up introducing a "duplicate" (redundant) task.
1023     // In that case, the compiler thread should first check if a method
1024     // has already been compiled before trying to compile it.
1025     // NOTE: in the event that there are multiple compiler threads and
1026     // there is de-optimization/recompilation, things will get hairy,
1027     // and in that case it's best to protect both the testing (here) of
1028     // these bits, and their updating (here and elsewhere) under a
1029     // common lock.
1030     task = create_compile_task(queue,
1031                                compile_id, method,
1032                                osr_bci, comp_level,
1033                                hot_method, hot_count, comment,
1034                                blocking);
1035   }
1036 
1037   if (blocking) {
1038     wait_for_completion(task);
1039   }
1040 }
1041 
1042 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1043                                        int comp_level,
1044                                        const methodHandle&amp; hot_method, int hot_count,
1045                                        const char* comment, Thread* THREAD) {
1046 
1047   // make sure arguments make sense
1048   assert(method-&gt;method_holder()-&gt;is_instance_klass(), "not an instance method");
1049   assert(osr_bci == InvocationEntryBci || (0 &lt;= osr_bci &amp;&amp; osr_bci &lt; method-&gt;code_size()), "bci out of range");
1050   assert(!method-&gt;is_abstract() &amp;&amp; (osr_bci == InvocationEntryBci || !method-&gt;is_native()), "cannot compile abstract/native methods");
1051   assert(!method-&gt;method_holder()-&gt;is_not_initialized(), "method holder must be initialized");
1052   // allow any levels for WhiteBox
1053   assert(WhiteBoxAPI || TieredCompilation || comp_level == CompLevel_highest_tier, "only CompLevel_highest_tier must be used in non-tiered");
1054   // return quickly if possible
1055 
1056  // start by figuring out the new compile level in case the method is cached
1057  int cached_comp_level = 0;
1058  if(CacheProfiles &amp;&amp; ciCacheProfiles::is_initialized()) {
1059    // if it's set trigger replayCompilation in case it's a cached method
1060    cached_comp_level = ciCacheProfiles::is_cached(method());
1061    // we only use cached profiles for Level 3 or 4
1062    // because 1 and 2 are used in special cases (i.e. compile queue full)
1063    // and we don't want to mess with that
1064    // also check if decompile count is less than 10 since we don't want to
1065    // recompile a lot using a bad profile
1066    if(cached_comp_level &gt; CompLevel_limited_profile &amp;&amp; comp_level &gt; CompLevel_limited_profile
1067            &amp;&amp; (method-&gt;method_data() == NULL || (method-&gt;method_data() != NULL &amp;&amp; method-&gt;method_data()-&gt;decompile_count() &lt; 10)))
1068    {
1069          // now both compile level and cache level are always &gt;= 3
1070          //
1071          // if we're in cacheprofilemode 2 AND compile level 3 and have a cache level 4
1072          // always set compile level to 2 to remove profiling from C1
1073          if(CacheProfilesMode==2 &amp;&amp; (comp_level == CompLevel_full_profile &amp;&amp; cached_comp_level == CompLevel_full_optimization)) {
1074            comp_level = CompLevel_limited_profile;
1075            if(PrintCacheProfiles) {
1076                  tty-&gt;print("CacheProfiles: Force Compilationlevel to %d, Hotcount: %d, OSR_BCI: %d :: ", comp_level,hot_count,osr_bci);
1077                  method-&gt;print_name(tty);
1078                  tty-&gt;print_cr(" &lt;");
1079            }
1080          // as long as we're not in mode 2
1081          // OR in mode 2 and a level 3 (with no level 4 profile available) or level 4 compilation (with either profiles)
1082          } else {
1083            // fix compile level to the one of the cached profile
1084            // this can result in promotion of level 3 compilations to level 4
1085            // (not the other way around)
1086            if(comp_level &lt; cached_comp_level) {
1087                  if(PrintCacheProfiles) {
1088                    tty-&gt;print("CacheProfiles: Promote Compilationlevel from %d to %d, Hotcount: %d, OSR_BCI: %d :: ",comp_level, cached_comp_level, hot_count,osr_bci);
1089                    method-&gt;print_name(tty);
1090                    tty-&gt;print_cr(" &lt;");
1091                  }
1092                  comp_level = cached_comp_level;
1093            }
1094          }
1095    }
1096  }
1097 
1098   // lock, make sure that the compilation
1099   // isn't prohibited in a straightforward way.
1100   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1101   if (comp == NULL || !comp-&gt;can_compile_method(method) ||
1102       compilation_is_prohibited(method, osr_bci, comp_level)) {
1103     return NULL;
1104   }
1105 
1106   if (osr_bci == InvocationEntryBci) {
1107     // standard compilation
1108     nmethod* method_code = method-&gt;code();
1109     if (method_code != NULL) {
1110       if (compilation_is_complete(method, osr_bci, comp_level)) {
1111         return method_code;
1112       }
1113     }
1114     if (method-&gt;is_not_compilable(comp_level)) {
1115       return NULL;
1116     }
1117   } else {
1118     // osr compilation
1119 #ifndef TIERED
1120     // seems like an assert of dubious value
1121     assert(comp_level == CompLevel_highest_tier,
1122            "all OSR compiles are assumed to be at a single compilation level");
1123 #endif // TIERED
1124     // We accept a higher level osr method
1125     nmethod* nm = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1126     if (nm != NULL) return nm;
1127     if (method-&gt;is_not_osr_compilable(comp_level)) return NULL;
1128   }
1129 
1130   assert(!HAS_PENDING_EXCEPTION, "No exception should be present");
1131   // some prerequisites that are compiler specific
1132   if (comp-&gt;is_c2() || comp-&gt;is_shark()) {
1133     method-&gt;constants()-&gt;resolve_string_constants(CHECK_AND_CLEAR_NULL);
1134     // Resolve all classes seen in the signature of the method
1135     // we are compiling.
1136     Method::load_signature_classes(method, CHECK_AND_CLEAR_NULL);
1137   }
1138 
1139   // If the method is native, do the lookup in the thread requesting
1140   // the compilation. Native lookups can load code, which is not
1141   // permitted during compilation.
1142   //
1143   // Note: A native method implies non-osr compilation which is
1144   //       checked with an assertion at the entry of this method.
1145   if (method-&gt;is_native() &amp;&amp; !method-&gt;is_method_handle_intrinsic()) {
1146     bool in_base_library;
1147     address adr = NativeLookup::lookup(method, in_base_library, THREAD);
1148     if (HAS_PENDING_EXCEPTION) {
1149       // In case of an exception looking up the method, we just forget
1150       // about it. The interpreter will kick-in and throw the exception.
1151       method-&gt;set_not_compilable(); // implies is_not_osr_compilable()
1152       CLEAR_PENDING_EXCEPTION;
1153       return NULL;
1154     }
1155     assert(method-&gt;has_native_function(), "must have native code by now");
1156   }
1157 
1158   // RedefineClasses() has replaced this method; just return
1159   if (method-&gt;is_old()) {
1160     return NULL;
1161   }
1162 
1163   // JVMTI -- post_compile_event requires jmethod_id() that may require
1164   // a lock the compiling thread can not acquire. Prefetch it here.
1165   if (JvmtiExport::should_post_compiled_method_load()) {
1166     method-&gt;jmethod_id();
1167   }
1168 
1169   // do the compilation
1170   if (method-&gt;is_native()) {
1171     if (!PreferInterpreterNativeStubs || method-&gt;is_method_handle_intrinsic()) {
1172       // The following native methods:
1173       //
1174       // java.lang.Float.intBitsToFloat
1175       // java.lang.Float.floatToRawIntBits
1176       // java.lang.Double.longBitsToDouble
1177       // java.lang.Double.doubleToRawLongBits
1178       //
1179       // are called through the interpreter even if interpreter native stubs
1180       // are not preferred (i.e., calling through adapter handlers is preferred).
1181       // The reason is that on x86_32 signaling NaNs (sNaNs) are not preserved
1182       // if the version of the methods from the native libraries is called.
1183       // As the interpreter and the C2-intrinsified version of the methods preserves
1184       // sNaNs, that would result in an inconsistent way of handling of sNaNs.
1185       if ((UseSSE &gt;= 1 &amp;&amp;
1186           (method-&gt;intrinsic_id() == vmIntrinsics::_intBitsToFloat ||
1187            method-&gt;intrinsic_id() == vmIntrinsics::_floatToRawIntBits)) ||
1188           (UseSSE &gt;= 2 &amp;&amp;
1189            (method-&gt;intrinsic_id() == vmIntrinsics::_longBitsToDouble ||
1190             method-&gt;intrinsic_id() == vmIntrinsics::_doubleToRawLongBits))) {
1191         return NULL;
1192       }
1193 
1194       // To properly handle the appendix argument for out-of-line calls we are using a small trampoline that
1195       // pops off the appendix argument and jumps to the target (see gen_special_dispatch in SharedRuntime).
1196       //
1197       // Since normal compiled-to-compiled calls are not able to handle such a thing we MUST generate an adapter
1198       // in this case.  If we can't generate one and use it we can not execute the out-of-line method handle calls.
1199       AdapterHandlerLibrary::create_native_wrapper(method);
1200     } else {
1201       return NULL;
1202     }
1203   } else {
1204     // If the compiler is shut off due to code cache getting full
1205     // fail out now so blocking compiles dont hang the java thread
1206     if (!should_compile_new_jobs()) {
1207       CompilationPolicy::policy()-&gt;delay_compilation(method());
1208       return NULL;
1209     }
1210  // first, check whether the CacheProfiles flag is set, if not continue as usual
1211  if(CacheProfiles &amp;&amp; ciCacheProfiles::is_initialized()) {
1212    // if it's set trigger replayCompilation in case it's a cached method
1213    // continue if method is cached and of level 3 or 4
1214    // AND our compile level actually matches cache level (we can not use a LVL3 profile for LVL4 compilations)
1215    // AND finally check if method has not been compiled more than 10 time already (using the cached profile)
1216    // Note: this is independent of the cacheprofilesmode since it will lower the level to 2 if it
1217    //       does not want to use cached profiles
1218    if(cached_comp_level &gt; CompLevel_limited_profile &amp;&amp;  comp_level &gt; CompLevel_limited_profile
1219            &amp;&amp; comp_level == cached_comp_level
1220            &amp;&amp; (method-&gt;method_data() == NULL || (method-&gt;method_data() != NULL &amp;&amp; method-&gt;method_data()-&gt;decompile_count() &lt; 10)))
1221    {
1222          if(PrintCacheProfiles) {
1223            tty-&gt;print("CacheProfiles: Use level %d profile for level %d compilation, Hotcount: %d, OSR_BCI: %d :: ",cached_comp_level, comp_level, hot_count,osr_bci);
1224            method-&gt;print_name(tty);
1225            tty-&gt;print_cr(" &lt;");
1226          }
1227          ciCacheProfiles::replay(THREAD,method(),osr_bci,false);
1228          return osr_bci  == InvocationEntryBci ? method-&gt;code() : method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1229    }
1230  }
1231  // if it's not in the cache or if we're using CacheProfileMode=2, just compile method base
1232  if(PrintCacheProfiles) {
1233    //tty-&gt;print("CacheProfiles: Not use profile for level %d compilation, Hotcount: %d, OSR_BCI: %d :: ",comp_level, hot_count,osr_bci);
1234    //method-&gt;print_name(tty);
1235    //tty-&gt;print_cr(" &lt;");
1236  }
1237     //bool is_blocking = !directive-&gt;BackgroundCompilationOption || CompileTheWorld || ReplayCompiles;
1238     compile_method_base(method, osr_bci, comp_level, hot_method, hot_count, comment, THREAD);
1239   }
1240 
1241   // return requested nmethod
1242   // We accept a higher level osr method
1243   if (osr_bci == InvocationEntryBci) {
1244     return method-&gt;code();
1245   }
1246   return method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1247 }
1248 
1249 
1250 // ------------------------------------------------------------------
1251 // CompileBroker::compilation_is_complete
1252 //
1253 // See if compilation of this method is already complete.
1254 bool CompileBroker::compilation_is_complete(const methodHandle&amp; method,
1255                                             int                 osr_bci,
1256                                             int                 comp_level) {
1257   bool is_osr = (osr_bci != standard_entry_bci);
1258   if (is_osr) {
1259     if (method-&gt;is_not_osr_compilable(comp_level)) {
1260       return true;
1261     } else {
1262       nmethod* result = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, true);
1263       return (result != NULL);
1264     }
1265   } else {
1266     if (method-&gt;is_not_compilable(comp_level)) {
1267       return true;
1268     } else {
1269       nmethod* result = method-&gt;code();
1270       if (result == NULL) return false;
1271       return comp_level == result-&gt;comp_level();
1272     }
1273   }
1274 }
1275 
1276 
1277 /**
1278  * See if this compilation is already requested.
1279  *
1280  * Implementation note: there is only a single "is in queue" bit
1281  * for each method.  This means that the check below is overly
1282  * conservative in the sense that an osr compilation in the queue
1283  * will block a normal compilation from entering the queue (and vice
1284  * versa).  This can be remedied by a full queue search to disambiguate
1285  * cases.  If it is deemed profitable, this may be done.
1286  */
1287 bool CompileBroker::compilation_is_in_queue(const methodHandle&amp; method) {
1288   return method-&gt;queued_for_compilation();
1289 }
1290 
1291 // ------------------------------------------------------------------
1292 // CompileBroker::compilation_is_prohibited
1293 //
1294 // See if this compilation is not allowed.
1295 bool CompileBroker::compilation_is_prohibited(const methodHandle&amp; method, int osr_bci, int comp_level) {
1296   bool is_native = method-&gt;is_native();
1297   // Some compilers may not support the compilation of natives.
1298   AbstractCompiler *comp = compiler(comp_level);
1299   if (is_native &amp;&amp;
1300       (!CICompileNatives || comp == NULL || !comp-&gt;supports_native())) {
1301     method-&gt;set_not_compilable_quietly(comp_level);
1302     return true;
1303   }
1304 
1305   bool is_osr = (osr_bci != standard_entry_bci);
1306   // Some compilers may not support on stack replacement.
1307   if (is_osr &amp;&amp;
1308       (!CICompileOSR || comp == NULL || !comp-&gt;supports_osr())) {
1309     method-&gt;set_not_osr_compilable(comp_level);
1310     return true;
1311   }
1312 
1313   // Breaking the abstraction - directives are only used inside a compilation otherwise.
1314   DirectiveSet* directive = DirectivesStack::getMatchingDirective(method, comp);
1315   bool excluded = directive-&gt;ExcludeOption;
1316   DirectivesStack::release(directive);
1317 
1318   // The method may be explicitly excluded by the user.
1319   double scale;
1320   if (excluded || (CompilerOracle::has_option_value(method, "CompileThresholdScaling", scale) &amp;&amp; scale == 0)) {
1321     bool quietly = CompilerOracle::should_exclude_quietly();
1322     if (PrintCompilation &amp;&amp; !quietly) {
1323       // This does not happen quietly...
1324       ResourceMark rm;
1325       tty-&gt;print("### Excluding %s:%s",
1326                  method-&gt;is_native() ? "generation of native wrapper" : "compile",
1327                  (method-&gt;is_static() ? " static" : ""));
1328       method-&gt;print_short_name(tty);
1329       tty-&gt;cr();
1330     }
1331     method-&gt;set_not_compilable(comp_level, !quietly, "excluded by CompileCommand");
1332   }
1333 
1334   return false;
1335 }
1336 
1337 /**
1338  * Generate serialized IDs for compilation requests. If certain debugging flags are used
1339  * and the ID is not within the specified range, the method is not compiled and 0 is returned.
1340  * The function also allows to generate separate compilation IDs for OSR compilations.
1341  */
1342 int CompileBroker::assign_compile_id(const methodHandle&amp; method, int osr_bci) {
1343 #ifdef ASSERT
1344   bool is_osr = (osr_bci != standard_entry_bci);
1345   int id;
1346   if (method-&gt;is_native()) {
1347     assert(!is_osr, "can't be osr");
1348     // Adapters, native wrappers and method handle intrinsics
1349     // should be generated always.
1350     return Atomic::add(1, &amp;_compilation_id);
1351   } else if (CICountOSR &amp;&amp; is_osr) {
1352     id = Atomic::add(1, &amp;_osr_compilation_id);
1353     if (CIStartOSR &lt;= id &amp;&amp; id &lt; CIStopOSR) {
1354       return id;
1355     }
1356   } else {
1357     id = Atomic::add(1, &amp;_compilation_id);
1358     if (CIStart &lt;= id &amp;&amp; id &lt; CIStop) {
1359       return id;
1360     }
1361   }
1362 
1363   // Method was not in the appropriate compilation range.
1364   method-&gt;set_not_compilable_quietly();
1365   return 0;
1366 #else
1367   // CICountOSR is a develop flag and set to 'false' by default. In a product built,
1368   // only _compilation_id is incremented.
1369   return Atomic::add(1, &amp;_compilation_id);
1370 #endif
1371 }
1372 
1373 // ------------------------------------------------------------------
1374 // CompileBroker::assign_compile_id_unlocked
1375 //
1376 // Public wrapper for assign_compile_id that acquires the needed locks
1377 uint CompileBroker::assign_compile_id_unlocked(Thread* thread, const methodHandle&amp; method, int osr_bci) {
1378   MutexLocker locker(MethodCompileQueue_lock, thread);
1379   return assign_compile_id(method, osr_bci);
1380 }
1381 
1382 /**
1383  * Should the current thread block until this compilation request
1384  * has been fulfilled?
1385  */
1386 bool CompileBroker::is_compile_blocking() {
1387   assert(!InstanceRefKlass::owns_pending_list_lock(JavaThread::current()), "possible deadlock");
1388   return !BackgroundCompilation;
1389 }
1390 
1391 // ------------------------------------------------------------------
1392 // CompileBroker::preload_classes
1393 void CompileBroker::preload_classes(const methodHandle&amp; method, TRAPS) {
1394   // Move this code over from c1_Compiler.cpp
1395   ShouldNotReachHere();
1396 }
1397 
1398 
1399 // ------------------------------------------------------------------
1400 // CompileBroker::create_compile_task
1401 //
1402 // Create a CompileTask object representing the current request for
1403 // compilation.  Add this task to the queue.
1404 CompileTask* CompileBroker::create_compile_task(CompileQueue*       queue,
1405                                                 int                 compile_id,
1406                                                 const methodHandle&amp; method,
1407                                                 int                 osr_bci,
1408                                                 int                 comp_level,
1409                                                 const methodHandle&amp; hot_method,
1410                                                 int                 hot_count,
1411                                                 const char*         comment,
1412                                                 bool                blocking) {
1413   CompileTask* new_task = CompileTask::allocate();
1414   new_task-&gt;initialize(compile_id, method, osr_bci, comp_level,
1415                        hot_method, hot_count, comment,
1416                        blocking);
1417   queue-&gt;add(new_task);
1418   return new_task;
1419 }
1420 
1421 #if INCLUDE_JVMCI
1422 // The number of milliseconds to wait before checking if
1423 // JVMCI compilation has made progress.
1424 static const long JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE = 500;
1425 
1426 // The number of JVMCI compilation progress checks that must fail
1427 // before unblocking a thread waiting for a blocking compilation.
1428 static const int JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS = 5;
1429 
1430 /**
1431  * Waits for a JVMCI compiler to complete a given task. This thread
1432  * waits until either the task completes or it sees no JVMCI compilation
1433  * progress for N consecutive milliseconds where N is
1434  * JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE *
1435  * JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS.
1436  *
1437  * @return true if this thread needs to free/recycle the task
1438  */
1439 bool CompileBroker::wait_for_jvmci_completion(JVMCICompiler* jvmci, CompileTask* task, JavaThread* thread) {
1440   MutexLocker waiter(task-&gt;lock(), thread);
1441   int progress_wait_attempts = 0;
1442   int methods_compiled = jvmci-&gt;methods_compiled();
1443   while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever() &amp;&amp;
1444          task-&gt;lock()-&gt;wait(!Mutex::_no_safepoint_check_flag, JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE)) {
1445     CompilerThread* jvmci_compiler_thread = task-&gt;jvmci_compiler_thread();
1446 
1447     bool progress;
1448     if (jvmci_compiler_thread != NULL) {
1449       // If the JVMCI compiler thread is not blocked, we deem it to be making progress.
1450       progress = jvmci_compiler_thread-&gt;thread_state() != _thread_blocked;
1451     } else {
1452       // Still waiting on JVMCI compiler queue. This thread may be holding a lock
1453       // that all JVMCI compiler threads are blocked on. We use the counter for
1454       // successful JVMCI compilations to determine whether JVMCI compilation
1455       // is still making progress through the JVMCI compiler queue.
1456       progress = jvmci-&gt;methods_compiled() != methods_compiled;
1457     }
1458 
1459     if (!progress) {
1460       if (++progress_wait_attempts == JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS) {
1461         if (PrintCompilation) {
1462           task-&gt;print(tty, "wait for blocking compilation timed out");
1463         }
1464         break;
1465       }
1466     } else {
1467       progress_wait_attempts = 0;
1468       if (jvmci_compiler_thread == NULL) {
1469         methods_compiled = jvmci-&gt;methods_compiled();
1470       }
1471     }
1472   }
1473   task-&gt;clear_waiter();
1474   return task-&gt;is_complete();
1475 }
1476 #endif
1477 
1478 /**
1479  *  Wait for the compilation task to complete.
1480  */
1481 void CompileBroker::wait_for_completion(CompileTask* task) {
1482   if (CIPrintCompileQueue) {
1483     ttyLocker ttyl;
1484     tty-&gt;print_cr("BLOCKING FOR COMPILE");
1485   }
1486 
1487   assert(task-&gt;is_blocking(), "can only wait on blocking task");
1488 
1489   JavaThread* thread = JavaThread::current();
1490   thread-&gt;set_blocked_on_compilation(true);
1491 
1492   methodHandle method(thread, task-&gt;method());
1493   bool free_task;
1494 #if INCLUDE_JVMCI
1495   AbstractCompiler* comp = compiler(task-&gt;comp_level());
1496   if (comp-&gt;is_jvmci()) {
1497     free_task = wait_for_jvmci_completion((JVMCICompiler*) comp, task, thread);
1498   } else
1499 #endif
1500   {
1501     MutexLocker waiter(task-&gt;lock(), thread);
1502     free_task = true;
1503     while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever()) {
1504       task-&gt;lock()-&gt;wait();
1505     }
1506   }
1507 
1508   thread-&gt;set_blocked_on_compilation(false);
1509   if (free_task) {
1510     if (is_compilation_disabled_forever()) {
1511       CompileTask::free(task);
1512       return;
1513     }
1514 
1515     // It is harmless to check this status without the lock, because
1516     // completion is a stable property (until the task object is recycled).
1517     assert(task-&gt;is_complete(), "Compilation should have completed");
1518     assert(task-&gt;code_handle() == NULL, "must be reset");
1519 
1520     // By convention, the waiter is responsible for recycling a
1521     // blocking CompileTask. Since there is only one waiter ever
1522     // waiting on a CompileTask, we know that no one else will
1523     // be using this CompileTask; we can free it.
1524     CompileTask::free(task);
1525   }
1526 }
1527 
1528 /**
1529  * Initialize compiler thread(s) + compiler object(s). The postcondition
1530  * of this function is that the compiler runtimes are initialized and that
1531  * compiler threads can start compiling.
1532  */
1533 bool CompileBroker::init_compiler_runtime() {
1534   CompilerThread* thread = CompilerThread::current();
1535   AbstractCompiler* comp = thread-&gt;compiler();
1536   // Final sanity check - the compiler object must exist
1537   guarantee(comp != NULL, "Compiler object must exist");
1538 
1539   int system_dictionary_modification_counter;
1540   {
1541     MutexLocker locker(Compile_lock, thread);
1542     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1543   }
1544 
1545   {
1546     // Must switch to native to allocate ci_env
1547     ThreadToNativeFromVM ttn(thread);
1548     ciEnv ci_env(NULL, system_dictionary_modification_counter);
1549     // Cache Jvmti state
1550     ci_env.cache_jvmti_state();
1551     // Cache DTrace flags
1552     ci_env.cache_dtrace_flags();
1553 
1554     // Switch back to VM state to do compiler initialization
1555     ThreadInVMfromNative tv(thread);
1556     ResetNoHandleMark rnhm;
1557 
1558     if (!comp-&gt;is_shark()) {
1559       // Perform per-thread and global initializations
1560       comp-&gt;initialize();
1561     }
1562   }
1563 
1564   if (comp-&gt;is_failed()) {
1565     disable_compilation_forever();
1566     // If compiler initialization failed, no compiler thread that is specific to a
1567     // particular compiler runtime will ever start to compile methods.
1568     shutdown_compiler_runtime(comp, thread);
1569     return false;
1570   }
1571 
1572   // C1 specific check
1573   if (comp-&gt;is_c1() &amp;&amp; (thread-&gt;get_buffer_blob() == NULL)) {
1574     warning("Initialization of %s thread failed (no space to run compilers)", thread-&gt;name());
1575     return false;
1576   }
1577 
1578   return true;
1579 }
1580 
1581 /**
1582  * If C1 and/or C2 initialization failed, we shut down all compilation.
1583  * We do this to keep things simple. This can be changed if it ever turns
1584  * out to be a problem.
1585  */
1586 void CompileBroker::shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread) {
1587   // Free buffer blob, if allocated
1588   if (thread-&gt;get_buffer_blob() != NULL) {
1589     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1590     CodeCache::free(thread-&gt;get_buffer_blob());
1591   }
1592 
1593   if (comp-&gt;should_perform_shutdown()) {
1594     // There are two reasons for shutting down the compiler
1595     // 1) compiler runtime initialization failed
1596     // 2) The code cache is full and the following flag is set: -XX:-UseCodeCacheFlushing
1597     warning("%s initialization failed. Shutting down all compilers", comp-&gt;name());
1598 
1599     // Only one thread per compiler runtime object enters here
1600     // Set state to shut down
1601     comp-&gt;set_shut_down();
1602 
1603     // Delete all queued compilation tasks to make compiler threads exit faster.
1604     if (_c1_compile_queue != NULL) {
1605       _c1_compile_queue-&gt;free_all();
1606     }
1607 
1608     if (_c2_compile_queue != NULL) {
1609       _c2_compile_queue-&gt;free_all();
1610     }
1611 
1612     // Set flags so that we continue execution with using interpreter only.
1613     UseCompiler    = false;
1614     UseInterpreter = true;
1615 
1616     // We could delete compiler runtimes also. However, there are references to
1617     // the compiler runtime(s) (e.g.,  nmethod::is_compiled_by_c1()) which then
1618     // fail. This can be done later if necessary.
1619   }
1620 }
1621 
1622 // ------------------------------------------------------------------
1623 // CompileBroker::compiler_thread_loop
1624 //
1625 // The main loop run by a CompilerThread.
1626 void CompileBroker::compiler_thread_loop() {
1627   CompilerThread* thread = CompilerThread::current();
1628   CompileQueue* queue = thread-&gt;queue();
1629   // For the thread that initializes the ciObjectFactory
1630   // this resource mark holds all the shared objects
1631   ResourceMark rm;
1632 
1633   // First thread to get here will initialize the compiler interface
1634 
1635   if (!ciObjectFactory::is_initialized()) {
1636     ASSERT_IN_VM;
1637     MutexLocker only_one (CompileThread_lock, thread);
1638     if (!ciObjectFactory::is_initialized()) {
1639       ciObjectFactory::initialize();
1640     }
1641   }
1642 
1643   // Open a log.
1644   if (LogCompilation) {
1645     init_compiler_thread_log();
1646   }
1647   CompileLog* log = thread-&gt;log();
1648   if (log != NULL) {
1649     log-&gt;begin_elem("start_compile_thread name='%s' thread='" UINTX_FORMAT "' process='%d'",
1650                     thread-&gt;name(),
1651                     os::current_thread_id(),
1652                     os::current_process_id());
1653     log-&gt;stamp();
1654     log-&gt;end_elem();
1655   }
1656 
1657   // If compiler thread/runtime initialization fails, exit the compiler thread
1658   if (!init_compiler_runtime()) {
1659     return;
1660   }
1661 
1662   // Poll for new compilation tasks as long as the JVM runs. Compilation
1663   // should only be disabled if something went wrong while initializing the
1664   // compiler runtimes. This, in turn, should not happen. The only known case
1665   // when compiler runtime initialization fails is if there is not enough free
1666   // space in the code cache to generate the necessary stubs, etc.
1667   while (!is_compilation_disabled_forever()) {
1668     // We need this HandleMark to avoid leaking VM handles.
1669     HandleMark hm(thread);
1670 
1671     CompileTask* task = queue-&gt;get();
1672     if (task == NULL) {
1673       continue;
1674     }
1675 
1676     // Give compiler threads an extra quanta.  They tend to be bursty and
1677     // this helps the compiler to finish up the job.
1678     if (CompilerThreadHintNoPreempt) {
1679       os::hint_no_preempt();
1680     }
1681 
1682     // Assign the task to the current thread.  Mark this compilation
1683     // thread as active for the profiler.
1684     CompileTaskWrapper ctw(task);
1685     nmethodLocker result_handle;  // (handle for the nmethod produced by this task)
1686     task-&gt;set_code_handle(&amp;result_handle);
1687     methodHandle method(thread, task-&gt;method());
1688 
1689     // Never compile a method if breakpoints are present in it
1690     if (method()-&gt;number_of_breakpoints() == 0) {
1691       // Compile the method.
1692       if ((UseCompiler || AlwaysCompileLoopMethods) &amp;&amp; CompileBroker::should_compile_new_jobs()) {
1693         invoke_compiler_on_method(task);
1694       } else {
1695         // After compilation is disabled, remove remaining methods from queue
1696         method-&gt;clear_queued_for_compilation();
1697         task-&gt;set_failure_reason("compilation is disabled");
1698       }
1699     }
1700   }
1701 
1702   // Shut down compiler runtime
1703   shutdown_compiler_runtime(thread-&gt;compiler(), thread);
1704 }
1705 
1706 // ------------------------------------------------------------------
1707 // CompileBroker::init_compiler_thread_log
1708 //
1709 // Set up state required by +LogCompilation.
1710 void CompileBroker::init_compiler_thread_log() {
1711     CompilerThread* thread = CompilerThread::current();
1712     char  file_name[4*K];
1713     FILE* fp = NULL;
1714     intx thread_id = os::current_thread_id();
1715     for (int try_temp_dir = 1; try_temp_dir &gt;= 0; try_temp_dir--) {
1716       const char* dir = (try_temp_dir ? os::get_temp_directory() : NULL);
1717       if (dir == NULL) {
1718         jio_snprintf(file_name, sizeof(file_name), "hs_c" UINTX_FORMAT "_pid%u.log",
1719                      thread_id, os::current_process_id());
1720       } else {
1721         jio_snprintf(file_name, sizeof(file_name),
1722                      "%s%shs_c" UINTX_FORMAT "_pid%u.log", dir,
1723                      os::file_separator(), thread_id, os::current_process_id());
1724       }
1725 
1726       fp = fopen(file_name, "wt");
1727       if (fp != NULL) {
1728         if (LogCompilation &amp;&amp; Verbose) {
1729           tty-&gt;print_cr("Opening compilation log %s", file_name);
1730         }
1731         CompileLog* log = new(ResourceObj::C_HEAP, mtCompiler) CompileLog(file_name, fp, thread_id);
1732         thread-&gt;init_log(log);
1733 
1734         if (xtty != NULL) {
1735           ttyLocker ttyl;
1736           // Record any per thread log files
1737           xtty-&gt;elem("thread_logfile thread='" INTX_FORMAT "' filename='%s'", thread_id, file_name);
1738         }
1739         return;
1740       }
1741     }
1742     warning("Cannot open log file: %s", file_name);
1743 }
1744 
1745 void CompileBroker::log_metaspace_failure() {
1746   const char* message = "some methods may not be compiled because metaspace "
1747                         "is out of memory";
1748   if (_compilation_log != NULL) {
1749     _compilation_log-&gt;log_metaspace_failure(message);
1750   }
1751   if (PrintCompilation) {
1752     tty-&gt;print_cr("COMPILE PROFILING SKIPPED: %s", message);
1753   }
1754 }
1755 
1756 
1757 // ------------------------------------------------------------------
1758 // CompileBroker::set_should_block
1759 //
1760 // Set _should_block.
1761 // Call this from the VM, with Threads_lock held and a safepoint requested.
1762 void CompileBroker::set_should_block() {
1763   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
1764   assert(SafepointSynchronize::is_at_safepoint(), "must be at a safepoint already");
1765 #ifndef PRODUCT
1766   if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1767     tty-&gt;print_cr("notifying compiler thread pool to block");
1768 #endif
1769   _should_block = true;
1770 }
1771 
1772 // ------------------------------------------------------------------
1773 // CompileBroker::maybe_block
1774 //
1775 // Call this from the compiler at convenient points, to poll for _should_block.
1776 void CompileBroker::maybe_block() {
1777   if (_should_block) {
1778 #ifndef PRODUCT
1779     if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1780       tty-&gt;print_cr("compiler thread " INTPTR_FORMAT " poll detects block request", p2i(Thread::current()));
1781 #endif
1782     ThreadInVMfromNative tivfn(JavaThread::current());
1783   }
1784 }
1785 
1786 // wrapper for CodeCache::print_summary()
1787 static void codecache_print(bool detailed)
1788 {
1789   ResourceMark rm;
1790   stringStream s;
1791   // Dump code cache  into a buffer before locking the tty,
1792   {
1793     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1794     CodeCache::print_summary(&amp;s, detailed);
1795   }
1796   ttyLocker ttyl;
1797   tty-&gt;print("%s", s.as_string());
1798 }
1799 
1800 void CompileBroker::post_compile(CompilerThread* thread, CompileTask* task, EventCompilation&amp; event, bool success, ciEnv* ci_env) {
1801 
1802   if (success) {
1803     task-&gt;mark_success();
1804     if (ci_env != NULL) {
1805       task-&gt;set_num_inlined_bytecodes(ci_env-&gt;num_inlined_bytecodes());
1806     }
1807     if (_compilation_log != NULL) {
1808       nmethod* code = task-&gt;code();
1809       if (code != NULL) {
1810         _compilation_log-&gt;log_nmethod(thread, code);
1811       }
1812     }
1813   }
1814 
1815   // simulate crash during compilation
1816   assert(task-&gt;compile_id() != CICrashAt, "just as planned");
1817   if (event.should_commit()) {
1818     event.set_method(task-&gt;method());
1819     event.set_compileID(task-&gt;compile_id());
1820     event.set_compileLevel(task-&gt;comp_level());
1821     event.set_succeded(task-&gt;is_success());
1822     event.set_isOsr(task-&gt;osr_bci() != CompileBroker::standard_entry_bci);
1823     event.set_codeSize((task-&gt;code() == NULL) ? 0 : task-&gt;code()-&gt;total_size());
1824     event.set_inlinedBytes(task-&gt;num_inlined_bytecodes());
1825     event.commit();
1826   }
1827 }
1828 
1829 int DirectivesStack::_depth = 0;
1830 CompilerDirectives* DirectivesStack::_top = NULL;
1831 CompilerDirectives* DirectivesStack::_bottom = NULL;
1832 
1833 // ------------------------------------------------------------------
1834 // CompileBroker::invoke_compiler_on_method
1835 //
1836 // Compile a method.
1837 //
1838 void CompileBroker::invoke_compiler_on_method(CompileTask* task) {
1839   if (PrintCompilation) {
1840     ResourceMark rm;
1841     task-&gt;print_tty();
1842   }
1843   elapsedTimer time;
1844 
1845   CompilerThread* thread = CompilerThread::current();
1846   ResourceMark rm(thread);
1847 
1848   if (LogEvents) {
1849     _compilation_log-&gt;log_compile(thread, task);
1850   }
1851 
1852   // Common flags.
1853   uint compile_id = task-&gt;compile_id();
1854   int osr_bci = task-&gt;osr_bci();
1855   bool is_osr = (osr_bci != standard_entry_bci);
1856   bool should_log = (thread-&gt;log() != NULL);
1857   bool should_break = false;
1858   int task_level = task-&gt;comp_level();
1859 
1860   DirectiveSet* directive;
1861   {
1862     // create the handle inside it's own block so it can't
1863     // accidentally be referenced once the thread transitions to
1864     // native.  The NoHandleMark before the transition should catch
1865     // any cases where this occurs in the future.
1866     methodHandle method(thread, task-&gt;method());
1867     assert(!method-&gt;is_native(), "no longer compile natives");
1868 
1869     // Look up matching directives
1870     directive = DirectivesStack::getMatchingDirective(method, compiler(task_level));
1871 
1872     // Save information about this method in case of failure.
1873     set_last_compile(thread, method, is_osr, task_level);
1874 
1875     DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, compiler_name(task_level));
1876   }
1877 
1878   should_break = directive-&gt;BreakAtExecuteOption || task-&gt;check_break_at_flags();
1879   if (should_log &amp;&amp; !directive-&gt;LogOption) {
1880     should_log = false;
1881   }
1882 
1883   // Allocate a new set of JNI handles.
1884   push_jni_handle_block();
1885   Method* target_handle = task-&gt;method();
1886   int compilable = ciEnv::MethodCompilable;
1887   const char* failure_reason = NULL;
1888   const char* retry_message = NULL;
1889   AbstractCompiler *comp = compiler(task_level);
1890 
1891   int system_dictionary_modification_counter;
1892   {
1893     MutexLocker locker(Compile_lock, thread);
1894     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1895   }
1896 #if INCLUDE_JVMCI
1897   if (UseJVMCICompiler &amp;&amp; comp != NULL &amp;&amp; comp-&gt;is_jvmci()) {
1898     JVMCICompiler* jvmci = (JVMCICompiler*) comp;
1899 
1900     TraceTime t1("compilation", &amp;time);
1901     EventCompilation event;
1902 
1903     JVMCIEnv env(task, system_dictionary_modification_counter);
1904     methodHandle method(thread, target_handle);
1905     jvmci-&gt;compile_method(method, osr_bci, &amp;env);
1906 
1907     post_compile(thread, task, event, task-&gt;code() != NULL, NULL);
1908 
1909     failure_reason = env.failure_reason();
1910     if (!env.retryable()) {
1911       retry_message = "not retryable";
1912       compilable = ciEnv::MethodCompilable_not_at_tier;
1913     }
1914 
1915   } else
1916 #endif // INCLUDE_JVMCI
1917   {
1918     NoHandleMark  nhm;
1919     ThreadToNativeFromVM ttn(thread);
1920 
1921     ciEnv ci_env(task, system_dictionary_modification_counter);
1922     if (should_break) {
1923       ci_env.set_break_at_compile(true);
1924     }
1925     if (should_log) {
1926       ci_env.set_log(thread-&gt;log());
1927     }
1928     assert(thread-&gt;env() == &amp;ci_env, "set by ci_env");
1929     // The thread-env() field is cleared in ~CompileTaskWrapper.
1930 
1931     // Cache Jvmti state
1932     ci_env.cache_jvmti_state();
1933 
1934     // Cache DTrace flags
1935     ci_env.cache_dtrace_flags();
1936 
1937     ciMethod* target = ci_env.get_method_from_handle(target_handle);
1938 
1939     TraceTime t1("compilation", &amp;time);
1940     EventCompilation event;
1941 
1942     if (comp == NULL) {
1943       ci_env.record_method_not_compilable("no compiler", !TieredCompilation);
1944     } else {
1945       if (WhiteBoxAPI &amp;&amp; WhiteBox::compilation_locked) {
1946         MonitorLockerEx locker(Compilation_lock, Mutex::_no_safepoint_check_flag);
1947         while (WhiteBox::compilation_locked) {
1948           locker.wait(Mutex::_no_safepoint_check_flag);
1949         }
1950       }
1951       comp-&gt;compile_method(&amp;ci_env, target, osr_bci, directive);
1952     }
1953 
1954     if (!ci_env.failing() &amp;&amp; task-&gt;code() == NULL) {
1955       //assert(false, "compiler should always document failure");
1956       // The compiler elected, without comment, not to register a result.
1957       // Do not attempt further compilations of this method.
1958       ci_env.record_method_not_compilable("compile failed", !TieredCompilation);
1959     }
1960 
1961     // Copy this bit to the enclosing block:
1962     compilable = ci_env.compilable();
1963 
1964     if (ci_env.failing()) {
1965       failure_reason = ci_env.failure_reason();
1966       retry_message = ci_env.retry_message();
1967       ci_env.report_failure(failure_reason);
1968     }
1969 
1970     post_compile(thread, task, event, !ci_env.failing(), &amp;ci_env);
1971   }
1972   // Remove the JNI handle block after the ciEnv destructor has run in
1973   // the previous block.
1974   pop_jni_handle_block();
1975 
1976   if (failure_reason != NULL) {
1977     task-&gt;set_failure_reason(failure_reason);
1978     if (_compilation_log != NULL) {
1979       _compilation_log-&gt;log_failure(thread, task, failure_reason, retry_message);
1980     }
1981     if (PrintCompilation) {
1982       FormatBufferResource msg = retry_message != NULL ?
1983         FormatBufferResource("COMPILE SKIPPED: %s (%s)", failure_reason, retry_message) :
1984         FormatBufferResource("COMPILE SKIPPED: %s",      failure_reason);
1985       task-&gt;print(tty, msg);
1986     }
1987   }
1988 
1989   methodHandle method(thread, task-&gt;method());
1990 
1991   DTRACE_METHOD_COMPILE_END_PROBE(method, compiler_name(task_level), task-&gt;is_success());
1992 
1993   collect_statistics(thread, time, task);
1994 
1995   nmethod* nm = task-&gt;code();
1996   if (nm != NULL) {
1997     nm-&gt;maybe_print_nmethod(directive);
1998   }
1999   DirectivesStack::release(directive);
2000 
2001   if (PrintCompilation &amp;&amp; PrintCompilation2) {
2002     tty-&gt;print("%7d ", (int) tty-&gt;time_stamp().milliseconds());  // print timestamp
2003     tty-&gt;print("%4d ", compile_id);    // print compilation number
2004     tty-&gt;print("%s ", (is_osr ? "%" : " "));
2005     if (task-&gt;code() != NULL) {
2006       tty-&gt;print("size: %d(%d) ", task-&gt;code()-&gt;total_size(), task-&gt;code()-&gt;insts_size());
2007     }
2008     tty-&gt;print_cr("time: %d inlined: %d bytes", (int)time.milliseconds(), task-&gt;num_inlined_bytecodes());
2009   }
2010 
2011   if (PrintCodeCacheOnCompilation)
2012     codecache_print(/* detailed= */ false);
2013 
2014   // Disable compilation, if required.
2015   switch (compilable) {
2016   case ciEnv::MethodCompilable_never:
2017     if (is_osr)
2018       method-&gt;set_not_osr_compilable_quietly();
2019     else
2020       method-&gt;set_not_compilable_quietly();
2021     break;
2022   case ciEnv::MethodCompilable_not_at_tier:
2023     if (is_osr)
2024       method-&gt;set_not_osr_compilable_quietly(task_level);
2025     else
2026       method-&gt;set_not_compilable_quietly(task_level);
2027     break;
2028   }
2029 
2030   // Note that the queued_for_compilation bits are cleared without
2031   // protection of a mutex. [They were set by the requester thread,
2032   // when adding the task to the compile queue -- at which time the
2033   // compile queue lock was held. Subsequently, we acquired the compile
2034   // queue lock to get this task off the compile queue; thus (to belabour
2035   // the point somewhat) our clearing of the bits must be occurring
2036   // only after the setting of the bits. See also 14012000 above.
2037   method-&gt;clear_queued_for_compilation();
2038 
2039 #ifdef ASSERT
2040   if (CollectedHeap::fired_fake_oom()) {
2041     // The current compile received a fake OOM during compilation so
2042     // go ahead and exit the VM since the test apparently succeeded
2043     tty-&gt;print_cr("*** Shutting down VM after successful fake OOM");
2044     vm_exit(0);
2045   }
2046 #endif
2047 }
2048 
2049 /**
2050  * The CodeCache is full. Print warning and disable compilation.
2051  * Schedule code cache cleaning so compilation can continue later.
2052  * This function needs to be called only from CodeCache::allocate(),
2053  * since we currently handle a full code cache uniformly.
2054  */
2055 void CompileBroker::handle_full_code_cache(int code_blob_type) {
2056   UseInterpreter = true;
2057   if (UseCompiler || AlwaysCompileLoopMethods ) {
2058     if (xtty != NULL) {
2059       ResourceMark rm;
2060       stringStream s;
2061       // Dump code cache state into a buffer before locking the tty,
2062       // because log_state() will use locks causing lock conflicts.
2063       CodeCache::log_state(&amp;s);
2064       // Lock to prevent tearing
2065       ttyLocker ttyl;
2066       xtty-&gt;begin_elem("code_cache_full");
2067       xtty-&gt;print("%s", s.as_string());
2068       xtty-&gt;stamp();
2069       xtty-&gt;end_elem();
2070     }
2071 
2072 #ifndef PRODUCT
2073     if (CompileTheWorld || ExitOnFullCodeCache) {
2074       codecache_print(/* detailed= */ true);
2075       before_exit(JavaThread::current());
2076       exit_globals(); // will delete tty
2077       vm_direct_exit(CompileTheWorld ? 0 : 1);
2078     }
2079 #endif
2080     if (UseCodeCacheFlushing) {
2081       // Since code cache is full, immediately stop new compiles
2082       if (CompileBroker::set_should_compile_new_jobs(CompileBroker::stop_compilation)) {
2083         NMethodSweeper::log_sweep("disable_compiler");
2084       }
2085     } else {
2086       disable_compilation_forever();
2087     }
2088 
2089     CodeCache::report_codemem_full(code_blob_type, should_print_compiler_warning());
2090   }
2091 }
2092 
2093 // ------------------------------------------------------------------
2094 // CompileBroker::set_last_compile
2095 //
2096 // Record this compilation for debugging purposes.
2097 void CompileBroker::set_last_compile(CompilerThread* thread, const methodHandle&amp; method, bool is_osr, int comp_level) {
2098   ResourceMark rm;
2099   char* method_name = method-&gt;name()-&gt;as_C_string();
2100   strncpy(_last_method_compiled, method_name, CompileBroker::name_buffer_length);
2101   _last_method_compiled[CompileBroker::name_buffer_length - 1] = '\0'; // ensure null terminated
2102   char current_method[CompilerCounters::cmname_buffer_length];
2103   size_t maxLen = CompilerCounters::cmname_buffer_length;
2104 
2105   if (UsePerfData) {
2106     const char* class_name = method-&gt;method_holder()-&gt;name()-&gt;as_C_string();
2107 
2108     size_t s1len = strlen(class_name);
2109     size_t s2len = strlen(method_name);
2110 
2111     // check if we need to truncate the string
2112     if (s1len + s2len + 2 &gt; maxLen) {
2113 
2114       // the strategy is to lop off the leading characters of the
2115       // class name and the trailing characters of the method name.
2116 
2117       if (s2len + 2 &gt; maxLen) {
2118         // lop of the entire class name string, let snprintf handle
2119         // truncation of the method name.
2120         class_name += s1len; // null string
2121       }
2122       else {
2123         // lop off the extra characters from the front of the class name
2124         class_name += ((s1len + s2len + 2) - maxLen);
2125       }
2126     }
2127 
2128     jio_snprintf(current_method, maxLen, "%s %s", class_name, method_name);
2129   }
2130 
2131   if (CICountOSR &amp;&amp; is_osr) {
2132     _last_compile_type = osr_compile;
2133   } else {
2134     _last_compile_type = normal_compile;
2135   }
2136   _last_compile_level = comp_level;
2137 
2138   if (UsePerfData) {
2139     CompilerCounters* counters = thread-&gt;counters();
2140     counters-&gt;set_current_method(current_method);
2141     counters-&gt;set_compile_type((jlong)_last_compile_type);
2142   }
2143 }
2144 
2145 
2146 // ------------------------------------------------------------------
2147 // CompileBroker::push_jni_handle_block
2148 //
2149 // Push on a new block of JNI handles.
2150 void CompileBroker::push_jni_handle_block() {
2151   JavaThread* thread = JavaThread::current();
2152 
2153   // Allocate a new block for JNI handles.
2154   // Inlined code from jni_PushLocalFrame()
2155   JNIHandleBlock* java_handles = thread-&gt;active_handles();
2156   JNIHandleBlock* compile_handles = JNIHandleBlock::allocate_block(thread);
2157   assert(compile_handles != NULL &amp;&amp; java_handles != NULL, "should not be NULL");
2158   compile_handles-&gt;set_pop_frame_link(java_handles);  // make sure java handles get gc'd.
2159   thread-&gt;set_active_handles(compile_handles);
2160 }
2161 
2162 
2163 // ------------------------------------------------------------------
2164 // CompileBroker::pop_jni_handle_block
2165 //
2166 // Pop off the current block of JNI handles.
2167 void CompileBroker::pop_jni_handle_block() {
2168   JavaThread* thread = JavaThread::current();
2169 
2170   // Release our JNI handle block
2171   JNIHandleBlock* compile_handles = thread-&gt;active_handles();
2172   JNIHandleBlock* java_handles = compile_handles-&gt;pop_frame_link();
2173   thread-&gt;set_active_handles(java_handles);
2174   compile_handles-&gt;set_pop_frame_link(NULL);
2175   JNIHandleBlock::release_block(compile_handles, thread); // may block
2176 }
2177 
2178 // ------------------------------------------------------------------
2179 // CompileBroker::collect_statistics
2180 //
2181 // Collect statistics about the compilation.
2182 
2183 void CompileBroker::collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task) {
2184   bool success = task-&gt;is_success();
2185   methodHandle method (thread, task-&gt;method());
2186   uint compile_id = task-&gt;compile_id();
2187   bool is_osr = (task-&gt;osr_bci() != standard_entry_bci);
2188   nmethod* code = task-&gt;code();
2189   CompilerCounters* counters = thread-&gt;counters();
2190 
2191   assert(code == NULL || code-&gt;is_locked_by_vm(), "will survive the MutexLocker");
2192   MutexLocker locker(CompileStatistics_lock);
2193 
2194   // _perf variables are production performance counters which are
2195   // updated regardless of the setting of the CITime and CITimeEach flags
2196   //
2197 
2198   // account all time, including bailouts and failures in this counter;
2199   // C1 and C2 counters are counting both successful and unsuccessful compiles
2200   _t_total_compilation.add(time);
2201 
2202   if (!success) {
2203     _total_bailout_count++;
2204     if (UsePerfData) {
2205       _perf_last_failed_method-&gt;set_value(counters-&gt;current_method());
2206       _perf_last_failed_type-&gt;set_value(counters-&gt;compile_type());
2207       _perf_total_bailout_count-&gt;inc();
2208     }
2209     _t_bailedout_compilation.add(time);
2210   } else if (code == NULL) {
2211     if (UsePerfData) {
2212       _perf_last_invalidated_method-&gt;set_value(counters-&gt;current_method());
2213       _perf_last_invalidated_type-&gt;set_value(counters-&gt;compile_type());
2214       _perf_total_invalidated_count-&gt;inc();
2215     }
2216     _total_invalidated_count++;
2217     _t_invalidated_compilation.add(time);
2218   } else {
2219     // Compilation succeeded
2220 
2221     // update compilation ticks - used by the implementation of
2222     // java.lang.management.CompilationMBean
2223     _perf_total_compilation-&gt;inc(time.ticks());
2224     _peak_compilation_time = time.milliseconds() &gt; _peak_compilation_time ? time.milliseconds() : _peak_compilation_time;
2225 
2226     if (CITime) {
2227       int bytes_compiled = method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2228       if (is_osr) {
2229         _t_osr_compilation.add(time);
2230         _sum_osr_bytes_compiled += bytes_compiled;
2231       } else {
2232         _t_standard_compilation.add(time);
2233         _sum_standard_bytes_compiled += method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2234       }
2235 
2236 #if INCLUDE_JVMCI
2237       AbstractCompiler* comp = compiler(task-&gt;comp_level());
2238       if (comp) {
2239         CompilerStatistics* stats = comp-&gt;stats();
2240         if (stats) {
2241           if (is_osr) {
2242             stats-&gt;_osr.update(time, bytes_compiled);
2243           } else {
2244             stats-&gt;_standard.update(time, bytes_compiled);
2245           }
2246           stats-&gt;_nmethods_size += code-&gt;total_size();
2247           stats-&gt;_nmethods_code_size += code-&gt;insts_size();
2248         } else { // if (!stats)
2249           assert(false, "Compiler statistics object must exist");
2250         }
2251       } else { // if (!comp)
2252         assert(false, "Compiler object must exist");
2253       }
2254 #endif // INCLUDE_JVMCI
2255     }
2256 
2257     if (UsePerfData) {
2258       // save the name of the last method compiled
2259       _perf_last_method-&gt;set_value(counters-&gt;current_method());
2260       _perf_last_compile_type-&gt;set_value(counters-&gt;compile_type());
2261       _perf_last_compile_size-&gt;set_value(method-&gt;code_size() +
2262                                          task-&gt;num_inlined_bytecodes());
2263       if (is_osr) {
2264         _perf_osr_compilation-&gt;inc(time.ticks());
2265         _perf_sum_osr_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2266       } else {
2267         _perf_standard_compilation-&gt;inc(time.ticks());
2268         _perf_sum_standard_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2269       }
2270     }
2271 
2272     if (CITimeEach) {
2273       float bytes_per_sec = 1.0 * (method-&gt;code_size() + task-&gt;num_inlined_bytecodes()) / time.seconds();
2274       tty-&gt;print_cr("%3d   seconds: %f bytes/sec : %f (bytes %d + %d inlined)",
2275                     compile_id, time.seconds(), bytes_per_sec, method-&gt;code_size(), task-&gt;num_inlined_bytecodes());
2276     }
2277 
2278     // Collect counts of successful compilations
2279     _sum_nmethod_size      += code-&gt;total_size();
2280     _sum_nmethod_code_size += code-&gt;insts_size();
2281     _total_compile_count++;
2282 
2283     if (UsePerfData) {
2284       _perf_sum_nmethod_size-&gt;inc(     code-&gt;total_size());
2285       _perf_sum_nmethod_code_size-&gt;inc(code-&gt;insts_size());
2286       _perf_total_compile_count-&gt;inc();
2287     }
2288 
2289     if (is_osr) {
2290       if (UsePerfData) _perf_total_osr_compile_count-&gt;inc();
2291       _total_osr_compile_count++;
2292     } else {
2293       if (UsePerfData) _perf_total_standard_compile_count-&gt;inc();
2294       _total_standard_compile_count++;
2295     }
2296   }
2297   // set the current method for the thread to null
2298   if (UsePerfData) counters-&gt;set_current_method("");
2299 }
2300 
2301 const char* CompileBroker::compiler_name(int comp_level) {
2302   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
2303   if (comp == NULL) {
2304     return "no compiler";
2305   } else {
2306     return (comp-&gt;name());
2307   }
2308 }
2309 
2310 #if INCLUDE_JVMCI
2311 void CompileBroker::print_times(AbstractCompiler* comp) {
2312   CompilerStatistics* stats = comp-&gt;stats();
2313   if (stats) {
2314     tty-&gt;print_cr("  %s {speed: %d bytes/s; standard: %6.3f s, %d bytes, %d methods; osr: %6.3f s, %d bytes, %d methods; nmethods_size: %d bytes; nmethods_code_size: %d bytes}",
2315                 comp-&gt;name(), stats-&gt;bytes_per_second(),
2316                 stats-&gt;_standard._time.seconds(), stats-&gt;_standard._bytes, stats-&gt;_standard._count,
2317                 stats-&gt;_osr._time.seconds(), stats-&gt;_osr._bytes, stats-&gt;_osr._count,
2318                 stats-&gt;_nmethods_size, stats-&gt;_nmethods_code_size);
2319   } else { // if (!stats)
2320     assert(false, "Compiler statistics object must exist");
2321   }
2322   comp-&gt;print_timers();
2323 }
2324 #endif // INCLUDE_JVMCI
2325 
2326 void CompileBroker::print_times(bool per_compiler, bool aggregate) {
2327 #if INCLUDE_JVMCI
2328   elapsedTimer standard_compilation;
2329   elapsedTimer total_compilation;
2330   elapsedTimer osr_compilation;
2331 
2332   int standard_bytes_compiled = 0;
2333   int osr_bytes_compiled = 0;
2334 
2335   int standard_compile_count = 0;
2336   int osr_compile_count = 0;
2337   int total_compile_count = 0;
2338 
2339   int nmethods_size = 0;
2340   int nmethods_code_size = 0;
2341   bool printedHeader = false;
2342 
2343   for (unsigned int i = 0; i &lt; sizeof(_compilers) / sizeof(AbstractCompiler*); i++) {
2344     AbstractCompiler* comp = _compilers[i];
2345     if (comp != NULL) {
2346       if (per_compiler &amp;&amp; aggregate &amp;&amp; !printedHeader) {
2347         printedHeader = true;
2348         tty-&gt;cr();
2349         tty-&gt;print_cr("Individual compiler times (for compiled methods only)");
2350         tty-&gt;print_cr("------------------------------------------------");
2351         tty-&gt;cr();
2352       }
2353       CompilerStatistics* stats = comp-&gt;stats();
2354 
2355       if (stats) {
2356         standard_compilation.add(stats-&gt;_standard._time);
2357         osr_compilation.add(stats-&gt;_osr._time);
2358 
2359         standard_bytes_compiled += stats-&gt;_standard._bytes;
2360         osr_bytes_compiled += stats-&gt;_osr._bytes;
2361 
2362         standard_compile_count += stats-&gt;_standard._count;
2363         osr_compile_count += stats-&gt;_osr._count;
2364 
2365         nmethods_size += stats-&gt;_nmethods_size;
2366         nmethods_code_size += stats-&gt;_nmethods_code_size;
2367       } else { // if (!stats)
2368         assert(false, "Compiler statistics object must exist");
2369       }
2370 
2371       if (per_compiler) {
2372         print_times(comp);
2373       }
2374     }
2375   }
2376   total_compile_count = osr_compile_count + standard_compile_count;
2377   total_compilation.add(osr_compilation);
2378   total_compilation.add(standard_compilation);
2379 
2380   // In hosted mode, print the JVMCI compiler specific counters manually.
2381   if (!UseJVMCICompiler) {
2382     JVMCICompiler::print_compilation_timers();
2383   }
2384 #else // INCLUDE_JVMCI
2385   elapsedTimer standard_compilation = CompileBroker::_t_standard_compilation;
2386   elapsedTimer osr_compilation = CompileBroker::_t_osr_compilation;
2387   elapsedTimer total_compilation = CompileBroker::_t_total_compilation;
2388 
2389   int standard_bytes_compiled = CompileBroker::_sum_standard_bytes_compiled;
2390   int osr_bytes_compiled = CompileBroker::_sum_osr_bytes_compiled;
2391 
2392   int standard_compile_count = CompileBroker::_total_standard_compile_count;
2393   int osr_compile_count = CompileBroker::_total_osr_compile_count;
2394   int total_compile_count = CompileBroker::_total_compile_count;
2395 
2396   int nmethods_size = CompileBroker::_sum_nmethod_code_size;
2397   int nmethods_code_size = CompileBroker::_sum_nmethod_size;
2398 #endif // INCLUDE_JVMCI
2399 
2400   if (!aggregate) {
2401     return;
2402   }
2403   tty-&gt;cr();
2404   tty-&gt;print_cr("Accumulated compiler times");
2405   tty-&gt;print_cr("----------------------------------------------------------");
2406                //0000000000111111111122222222223333333333444444444455555555556666666666
2407                //0123456789012345678901234567890123456789012345678901234567890123456789
2408   tty-&gt;print_cr("  Total compilation time   : %7.3f s", total_compilation.seconds());
2409   tty-&gt;print_cr("    Standard compilation   : %7.3f s, Average : %2.3f s",
2410                 standard_compilation.seconds(),
2411                 standard_compilation.seconds() / standard_compile_count);
2412   tty-&gt;print_cr("    Bailed out compilation : %7.3f s, Average : %2.3f s",
2413                 CompileBroker::_t_bailedout_compilation.seconds(),
2414                 CompileBroker::_t_bailedout_compilation.seconds() / CompileBroker::_total_bailout_count);
2415   tty-&gt;print_cr("    On stack replacement   : %7.3f s, Average : %2.3f s",
2416                 osr_compilation.seconds(),
2417                 osr_compilation.seconds() / osr_compile_count);
2418   tty-&gt;print_cr("    Invalidated            : %7.3f s, Average : %2.3f s",
2419                 CompileBroker::_t_invalidated_compilation.seconds(),
2420                 CompileBroker::_t_invalidated_compilation.seconds() / CompileBroker::_total_invalidated_count);
2421 
2422   AbstractCompiler *comp = compiler(CompLevel_simple);
2423   if (comp != NULL) {
2424     tty-&gt;cr();
2425     comp-&gt;print_timers();
2426   }
2427   comp = compiler(CompLevel_full_optimization);
2428   if (comp != NULL) {
2429     tty-&gt;cr();
2430     comp-&gt;print_timers();
2431   }
2432   tty-&gt;cr();
2433   tty-&gt;print_cr("  Total compiled methods    : %8d methods", total_compile_count);
2434   tty-&gt;print_cr("    Standard compilation    : %8d methods", standard_compile_count);
2435   tty-&gt;print_cr("    On stack replacement    : %8d methods", osr_compile_count);
2436   int tcb = osr_bytes_compiled + standard_bytes_compiled;
2437   tty-&gt;print_cr("  Total compiled bytecodes  : %8d bytes", tcb);
2438   tty-&gt;print_cr("    Standard compilation    : %8d bytes", standard_bytes_compiled);
2439   tty-&gt;print_cr("    On stack replacement    : %8d bytes", osr_bytes_compiled);
2440   double tcs = total_compilation.seconds();
2441   int bps = tcs == 0.0 ? 0 : (int)(tcb / tcs);
2442   tty-&gt;print_cr("  Average compilation speed : %8d bytes/s", bps);
2443   tty-&gt;cr();
2444   tty-&gt;print_cr("  nmethod code size         : %8d bytes", nmethods_code_size);
2445   tty-&gt;print_cr("  nmethod total size        : %8d bytes", nmethods_size);
2446 }
2447 
2448 // Debugging output for failure
2449 void CompileBroker::print_last_compile() {
2450   if ( _last_compile_level != CompLevel_none &amp;&amp;
2451        compiler(_last_compile_level) != NULL &amp;&amp;
2452        _last_method_compiled != NULL &amp;&amp;
2453        _last_compile_type != no_compile) {
2454     if (_last_compile_type == osr_compile) {
2455       tty-&gt;print_cr("Last parse:  [osr]%d+++(%d) %s",
2456                     _osr_compilation_id, _last_compile_level, _last_method_compiled);
2457     } else {
2458       tty-&gt;print_cr("Last parse:  %d+++(%d) %s",
2459                     _compilation_id, _last_compile_level, _last_method_compiled);
2460     }
2461   }
2462 }
2463 
</pre></body></html>
