<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/share/vm/compiler/compileBroker.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1999, 2015, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/symbolTable.hpp"
  27 #include "classfile/systemDictionary.hpp"
  28 #include "ci/ciCacheProfiles.hpp"
  29 #include "classfile/vmSymbols.hpp"
  30 #include "code/codeCache.hpp"
  31 #include "code/dependencyContext.hpp"
  32 #include "compiler/compileBroker.hpp"
  33 #include "compiler/compileLog.hpp"
  34 #include "compiler/compilerOracle.hpp"
  35 #include "compiler/directivesParser.hpp"
  36 #include "interpreter/linkResolver.hpp"
  37 #include "memory/allocation.inline.hpp"
  38 #include "oops/methodData.hpp"
  39 #include "oops/method.hpp"
  40 #include "oops/oop.inline.hpp"
  41 #include "prims/nativeLookup.hpp"
  42 #include "prims/whitebox.hpp"
  43 #include "runtime/arguments.hpp"
  44 #include "runtime/atomic.inline.hpp"
  45 #include "runtime/compilationPolicy.hpp"
  46 #include "runtime/init.hpp"
  47 #include "runtime/interfaceSupport.hpp"
  48 #include "runtime/javaCalls.hpp"
  49 #include "runtime/os.hpp"
  50 #include "runtime/sharedRuntime.hpp"
  51 #include "runtime/sweeper.hpp"
  52 #include "trace/tracing.hpp"
  53 #include "utilities/dtrace.hpp"
  54 #include "utilities/events.hpp"
  55 #ifdef COMPILER1
  56 #include "c1/c1_Compiler.hpp"
  57 #endif
  58 #if INCLUDE_JVMCI
  59 #include "jvmci/jvmciCompiler.hpp"
  60 #include "jvmci/jvmciRuntime.hpp"
  61 #include "jvmci/jvmciJavaClasses.hpp"
  62 #include "runtime/vframe.hpp"
  63 #endif
  64 #ifdef COMPILER2
  65 #include "opto/c2compiler.hpp"
  66 #endif
  67 #ifdef SHARK
  68 #include "shark/sharkCompiler.hpp"
  69 #endif
  70 
  71 #ifdef DTRACE_ENABLED
  72 
  73 // Only bother with this argument setup if dtrace is available
  74 
  75 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)             \
  76   {                                                                      \
  77     Symbol* klass_name = (method)-&gt;klass_name();                         \
  78     Symbol* name = (method)-&gt;name();                                     \
  79     Symbol* signature = (method)-&gt;signature();                           \
  80     HOTSPOT_METHOD_COMPILE_BEGIN(                                        \
  81       (char *) comp_name, strlen(comp_name),                             \
  82       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  83       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  84       (char *) signature-&gt;bytes(), signature-&gt;utf8_length());            \
  85   }
  86 
  87 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)      \
  88   {                                                                      \
  89     Symbol* klass_name = (method)-&gt;klass_name();                         \
  90     Symbol* name = (method)-&gt;name();                                     \
  91     Symbol* signature = (method)-&gt;signature();                           \
  92     HOTSPOT_METHOD_COMPILE_END(                                          \
  93       (char *) comp_name, strlen(comp_name),                             \
  94       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  95       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  96       (char *) signature-&gt;bytes(), signature-&gt;utf8_length(), (success)); \
  97   }
  98 
  99 #else //  ndef DTRACE_ENABLED
 100 
 101 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)
 102 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)
 103 
 104 #endif // ndef DTRACE_ENABLED
 105 
 106 bool CompileBroker::_initialized = false;
 107 volatile bool CompileBroker::_should_block = false;
 108 volatile jint CompileBroker::_print_compilation_warning = 0;
 109 volatile jint CompileBroker::_should_compile_new_jobs = run_compilation;
 110 
 111 // The installed compiler(s)
 112 AbstractCompiler* CompileBroker::_compilers[2];
 113 
 114 // These counters are used to assign an unique ID to each compilation.
 115 volatile jint CompileBroker::_compilation_id     = 0;
 116 volatile jint CompileBroker::_osr_compilation_id = 0;
 117 
 118 // Debugging information
 119 int  CompileBroker::_last_compile_type     = no_compile;
 120 int  CompileBroker::_last_compile_level    = CompLevel_none;
 121 char CompileBroker::_last_method_compiled[CompileBroker::name_buffer_length];
 122 
 123 // Performance counters
 124 PerfCounter* CompileBroker::_perf_total_compilation = NULL;
 125 PerfCounter* CompileBroker::_perf_osr_compilation = NULL;
 126 PerfCounter* CompileBroker::_perf_standard_compilation = NULL;
 127 
 128 PerfCounter* CompileBroker::_perf_total_bailout_count = NULL;
 129 PerfCounter* CompileBroker::_perf_total_invalidated_count = NULL;
 130 PerfCounter* CompileBroker::_perf_total_compile_count = NULL;
 131 PerfCounter* CompileBroker::_perf_total_osr_compile_count = NULL;
 132 PerfCounter* CompileBroker::_perf_total_standard_compile_count = NULL;
 133 
 134 PerfCounter* CompileBroker::_perf_sum_osr_bytes_compiled = NULL;
 135 PerfCounter* CompileBroker::_perf_sum_standard_bytes_compiled = NULL;
 136 PerfCounter* CompileBroker::_perf_sum_nmethod_size = NULL;
 137 PerfCounter* CompileBroker::_perf_sum_nmethod_code_size = NULL;
 138 
 139 PerfStringVariable* CompileBroker::_perf_last_method = NULL;
 140 PerfStringVariable* CompileBroker::_perf_last_failed_method = NULL;
 141 PerfStringVariable* CompileBroker::_perf_last_invalidated_method = NULL;
 142 PerfVariable*       CompileBroker::_perf_last_compile_type = NULL;
 143 PerfVariable*       CompileBroker::_perf_last_compile_size = NULL;
 144 PerfVariable*       CompileBroker::_perf_last_failed_type = NULL;
 145 PerfVariable*       CompileBroker::_perf_last_invalidated_type = NULL;
 146 
 147 // Timers and counters for generating statistics
 148 elapsedTimer CompileBroker::_t_total_compilation;
 149 elapsedTimer CompileBroker::_t_osr_compilation;
 150 elapsedTimer CompileBroker::_t_standard_compilation;
 151 elapsedTimer CompileBroker::_t_invalidated_compilation;
 152 elapsedTimer CompileBroker::_t_bailedout_compilation;
 153 
 154 int CompileBroker::_total_bailout_count          = 0;
 155 int CompileBroker::_total_invalidated_count      = 0;
 156 int CompileBroker::_total_compile_count          = 0;
 157 int CompileBroker::_total_osr_compile_count      = 0;
 158 int CompileBroker::_total_standard_compile_count = 0;
 159 
 160 int CompileBroker::_sum_osr_bytes_compiled       = 0;
 161 int CompileBroker::_sum_standard_bytes_compiled  = 0;
 162 int CompileBroker::_sum_nmethod_size             = 0;
 163 int CompileBroker::_sum_nmethod_code_size        = 0;
 164 
 165 long CompileBroker::_peak_compilation_time       = 0;
 166 
 167 CompileQueue* CompileBroker::_c2_compile_queue   = NULL;
 168 CompileQueue* CompileBroker::_c1_compile_queue   = NULL;
 169 
 170 class CompilationLog : public StringEventLog {
 171  public:
 172   CompilationLog() : StringEventLog("Compilation events") {
 173   }
 174 
 175   void log_compile(JavaThread* thread, CompileTask* task) {
 176     StringLogMessage lm;
 177     stringStream sstr = lm.stream();
 178     // msg.time_stamp().update_to(tty-&gt;time_stamp().ticks());
 179     task-&gt;print(&amp;sstr, NULL, true, false);
 180     log(thread, "%s", (const char*)lm);
 181   }
 182 
 183   void log_nmethod(JavaThread* thread, nmethod* nm) {
 184     log(thread, "nmethod %d%s " INTPTR_FORMAT " code [" INTPTR_FORMAT ", " INTPTR_FORMAT "]",
 185         nm-&gt;compile_id(), nm-&gt;is_osr_method() ? "%" : "",
 186         p2i(nm), p2i(nm-&gt;code_begin()), p2i(nm-&gt;code_end()));
 187   }
 188 
 189   void log_failure(JavaThread* thread, CompileTask* task, const char* reason, const char* retry_message) {
 190     StringLogMessage lm;
 191     lm.print("%4d   COMPILE SKIPPED: %s", task-&gt;compile_id(), reason);
 192     if (retry_message != NULL) {
 193       lm.append(" (%s)", retry_message);
 194     }
 195     lm.print("\n");
 196     log(thread, "%s", (const char*)lm);
 197   }
 198 
 199   void log_metaspace_failure(const char* reason) {
 200     ResourceMark rm;
 201     StringLogMessage lm;
 202     lm.print("%4d   COMPILE PROFILING SKIPPED: %s", -1, reason);
 203     lm.print("\n");
 204     log(JavaThread::current(), "%s", (const char*)lm);
 205   }
 206 };
 207 
 208 static CompilationLog* _compilation_log = NULL;
 209 
 210 bool compileBroker_init() {
 211   if (LogEvents) {
 212     _compilation_log = new CompilationLog();
 213   }
 214 
 215   // init directives stack, adding default directive
 216   DirectivesStack::init();
 217 
 218   if (DirectivesParser::has_file()) {
 219     return DirectivesParser::parse_from_flag();
 220   } else if (CompilerDirectivesPrint) {
 221     // Print default directive even when no other was added
 222     DirectivesStack::print(tty);
 223   }
 224 
 225   return true;
 226 }
 227 
 228 CompileTaskWrapper::CompileTaskWrapper(CompileTask* task) {
 229   CompilerThread* thread = CompilerThread::current();
 230   thread-&gt;set_task(task);
 231 #if INCLUDE_JVMCI
 232   if (task-&gt;is_blocking() &amp;&amp; CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 233     task-&gt;set_jvmci_compiler_thread(thread);
 234   }
 235 #endif
 236   CompileLog*     log  = thread-&gt;log();
 237   if (log != NULL)  task-&gt;log_task_start(log);
 238 }
 239 
 240 CompileTaskWrapper::~CompileTaskWrapper() {
 241   CompilerThread* thread = CompilerThread::current();
 242   CompileTask* task = thread-&gt;task();
 243   CompileLog*  log  = thread-&gt;log();
 244   if (log != NULL)  task-&gt;log_task_done(log);
 245   thread-&gt;set_task(NULL);
 246   task-&gt;set_code_handle(NULL);
 247   thread-&gt;set_env(NULL);
 248   if (task-&gt;is_blocking()) {
 249     bool free_task = false;
 250     {
 251       MutexLocker notifier(task-&gt;lock(), thread);
 252       task-&gt;mark_complete();
 253 #if INCLUDE_JVMCI
 254       if (CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 255         if (!task-&gt;has_waiter()) {
 256           // The waiting thread timed out and thus did not free the task.
 257           free_task = true;
 258         }
 259         task-&gt;set_jvmci_compiler_thread(NULL);
 260       }
 261 #endif
 262       if (!free_task) {
 263         // Notify the waiting thread that the compilation has completed
 264         // so that it can free the task.
 265         task-&gt;lock()-&gt;notify_all();
 266       }
 267     }
 268     if (free_task) {
 269       // The task can only be freed once the task lock is released.
 270       CompileTask::free(task);
 271     }
 272   } else {
 273     task-&gt;mark_complete();
 274 
 275     // By convention, the compiling thread is responsible for
 276     // recycling a non-blocking CompileTask.
 277     CompileTask::free(task);
 278   }
 279 }
 280 
 281 /**
 282  * Add a CompileTask to a CompileQueue.
 283  */
 284 void CompileQueue::add(CompileTask* task) {
 285   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 286 
 287   task-&gt;set_next(NULL);
 288   task-&gt;set_prev(NULL);
 289 
 290   if (_last == NULL) {
 291     // The compile queue is empty.
 292     assert(_first == NULL, "queue is empty");
 293     _first = task;
 294     _last = task;
 295   } else {
 296     // Append the task to the queue.
 297     assert(_last-&gt;next() == NULL, "not last");
 298     _last-&gt;set_next(task);
 299     task-&gt;set_prev(_last);
 300     _last = task;
 301   }
 302   ++_size;
 303 
 304   // Mark the method as being in the compile queue.
 305   task-&gt;method()-&gt;set_queued_for_compilation();
 306 
 307   if (CIPrintCompileQueue) {
 308     print_tty();
 309   }
 310   if (PrintCompileQueueSize) {
 311     tty-&gt;print_cr("%d - Size of %s: %d", (int) tty-&gt;time_stamp().milliseconds(), name(),_size);
 312   }
 313 
 314   if (LogCompilation &amp;&amp; xtty != NULL) {
 315     task-&gt;log_task_queued();
 316   }
 317 
 318   // Notify CompilerThreads that a task is available.
 319   MethodCompileQueue_lock-&gt;notify_all();
 320 }
 321 
 322 /**
 323  * Empties compilation queue by putting all compilation tasks onto
 324  * a freelist. Furthermore, the method wakes up all threads that are
 325  * waiting on a compilation task to finish. This can happen if background
 326  * compilation is disabled.
 327  */
 328 void CompileQueue::free_all() {
 329   MutexLocker mu(MethodCompileQueue_lock);
 330   CompileTask* next = _first;
 331 
 332   // Iterate over all tasks in the compile queue
 333   while (next != NULL) {
 334     CompileTask* current = next;
 335     next = current-&gt;next();
 336     {
 337       // Wake up thread that blocks on the compile task.
 338       MutexLocker ct_lock(current-&gt;lock());
 339       current-&gt;lock()-&gt;notify();
 340     }
 341     // Put the task back on the freelist.
 342     CompileTask::free(current);
 343   }
 344   _first = NULL;
 345 
 346   // Wake up all threads that block on the queue.
 347   MethodCompileQueue_lock-&gt;notify_all();
 348 }
 349 
 350 /**
 351  * Get the next CompileTask from a CompileQueue
 352  */
 353 CompileTask* CompileQueue::get() {
 354   // save methods from RedefineClasses across safepoint
 355   // across MethodCompileQueue_lock below.
 356   methodHandle save_method;
 357   methodHandle save_hot_method;
 358 
 359   MutexLocker locker(MethodCompileQueue_lock);
 360   // If _first is NULL we have no more compile jobs. There are two reasons for
 361   // having no compile jobs: First, we compiled everything we wanted. Second,
 362   // we ran out of code cache so compilation has been disabled. In the latter
 363   // case we perform code cache sweeps to free memory such that we can re-enable
 364   // compilation.
 365   while (_first == NULL) {
 366     // Exit loop if compilation is disabled forever
 367     if (CompileBroker::is_compilation_disabled_forever()) {
 368       return NULL;
 369     }
 370 
 371     // If there are no compilation tasks and we can compile new jobs
 372     // (i.e., there is enough free space in the code cache) there is
 373     // no need to invoke the sweeper. As a result, the hotness of methods
 374     // remains unchanged. This behavior is desired, since we want to keep
 375     // the stable state, i.e., we do not want to evict methods from the
 376     // code cache if it is unnecessary.
 377     // We need a timed wait here, since compiler threads can exit if compilation
 378     // is disabled forever. We use 5 seconds wait time; the exiting of compiler threads
 379     // is not critical and we do not want idle compiler threads to wake up too often.
 380     MethodCompileQueue_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 5*1000);
 381   }
 382 
 383   if (CompileBroker::is_compilation_disabled_forever()) {
 384     return NULL;
 385   }
 386 
 387   CompileTask* task;
 388   {
 389     NoSafepointVerifier nsv;
 390     task = CompilationPolicy::policy()-&gt;select_task(this);
 391   }
 392 
 393   // Save method pointers across unlock safepoint.  The task is removed from
 394   // the compilation queue, which is walked during RedefineClasses.
 395   save_method = methodHandle(task-&gt;method());
 396   save_hot_method = methodHandle(task-&gt;hot_method());
 397 
 398   remove(task);
 399   purge_stale_tasks(); // may temporarily release MCQ lock
 400 
 401   return task;
 402 }
 403 
 404 // Clean &amp; deallocate stale compile tasks.
 405 // Temporarily releases MethodCompileQueue lock.
 406 void CompileQueue::purge_stale_tasks() {
 407   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 408   if (_first_stale != NULL) {
 409     // Stale tasks are purged when MCQ lock is released,
 410     // but _first_stale updates are protected by MCQ lock.
 411     // Once task processing starts and MCQ lock is released,
 412     // other compiler threads can reuse _first_stale.
 413     CompileTask* head = _first_stale;
 414     _first_stale = NULL;
 415     {
 416       MutexUnlocker ul(MethodCompileQueue_lock);
 417       for (CompileTask* task = head; task != NULL; ) {
 418         CompileTask* next_task = task-&gt;next();
 419         CompileTaskWrapper ctw(task); // Frees the task
 420         task-&gt;set_failure_reason("stale task");
 421         task = next_task;
 422       }
 423     }
 424   }
 425 }
 426 
 427 void CompileQueue::remove(CompileTask* task) {
 428    assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 429   if (task-&gt;prev() != NULL) {
 430     task-&gt;prev()-&gt;set_next(task-&gt;next());
 431   } else {
 432     // max is the first element
 433     assert(task == _first, "Sanity");
 434     _first = task-&gt;next();
 435   }
 436 
 437   if (task-&gt;next() != NULL) {
 438     task-&gt;next()-&gt;set_prev(task-&gt;prev());
 439   } else {
 440     // max is the last element
 441     assert(task == _last, "Sanity");
 442     _last = task-&gt;prev();
 443   }
 444   --_size;
 445 }
 446 
 447 void CompileQueue::remove_and_mark_stale(CompileTask* task) {
 448   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 449   remove(task);
 450 
 451   // Enqueue the task for reclamation (should be done outside MCQ lock)
 452   task-&gt;set_next(_first_stale);
 453   task-&gt;set_prev(NULL);
 454   _first_stale = task;
 455 }
 456 
 457 // methods in the compile queue need to be marked as used on the stack
 458 // so that they don't get reclaimed by Redefine Classes
 459 void CompileQueue::mark_on_stack() {
 460   CompileTask* task = _first;
 461   while (task != NULL) {
 462     task-&gt;mark_on_stack();
 463     task = task-&gt;next();
 464   }
 465 }
 466 
 467 
 468 CompileQueue* CompileBroker::compile_queue(int comp_level) {
 469   if (is_c2_compile(comp_level)) return _c2_compile_queue;
 470   if (is_c1_compile(comp_level)) return _c1_compile_queue;
 471   return NULL;
 472 }
 473 
 474 void CompileBroker::print_compile_queues(outputStream* st) {
 475   st-&gt;print_cr("Current compiles: ");
 476   MutexLocker locker(MethodCompileQueue_lock);
 477 
 478   char buf[2000];
 479   int buflen = sizeof(buf);
 480   Threads::print_threads_compiling(st, buf, buflen);
 481 
 482   st-&gt;cr();
 483   if (_c1_compile_queue != NULL) {
 484     _c1_compile_queue-&gt;print(st);
 485   }
 486   if (_c2_compile_queue != NULL) {
 487     _c2_compile_queue-&gt;print(st);
 488   }
 489 }
 490 
 491 void CompileQueue::print(outputStream* st) {
 492   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 493   st-&gt;print_cr("%s:", name());
 494   CompileTask* task = _first;
 495   if (task == NULL) {
 496     st-&gt;print_cr("Empty");
 497   } else {
 498     while (task != NULL) {
 499       task-&gt;print(st, NULL, true, true);
 500       task = task-&gt;next();
 501     }
 502   }
 503   st-&gt;cr();
 504 }
 505 
 506 void CompileQueue::print_tty() {
 507   ttyLocker ttyl;
 508   print(tty);
 509 }
 510 
 511 CompilerCounters::CompilerCounters() {
 512   _current_method[0] = '\0';
 513   _compile_type = CompileBroker::no_compile;
 514 }
 515 
 516 // ------------------------------------------------------------------
 517 // CompileBroker::compilation_init
 518 //
 519 // Initialize the Compilation object
 520 void CompileBroker::compilation_init(TRAPS) {
 521   _last_method_compiled[0] = '\0';
 522 
 523   // No need to initialize compilation system if we do not use it.
 524   if (!UseCompiler) {
 525     return;
 526   }
 527 #ifndef SHARK
 528   // Set the interface to the current compiler(s).
 529   int c1_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_simple);
 530   int c2_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_full_optimization);
 531 
 532 #if INCLUDE_JVMCI
 533   if (EnableJVMCI) {
 534     // This is creating a JVMCICompiler singleton.
 535     JVMCICompiler* jvmci = new JVMCICompiler();
 536 
 537     if (UseJVMCICompiler) {
 538       _compilers[1] = jvmci;
 539       if (FLAG_IS_DEFAULT(JVMCIThreads)) {
 540         if (BootstrapJVMCI) {
 541           // JVMCI will bootstrap so give it more threads
 542           c2_count = MIN2(32, os::active_processor_count());
 543         }
 544       } else {
 545         c2_count = JVMCIThreads;
 546       }
 547       if (FLAG_IS_DEFAULT(JVMCIHostThreads)) {
 548       } else {
 549         c1_count = JVMCIHostThreads;
 550       }
 551 
 552       if (!UseInterpreter || !BackgroundCompilation) {
 553         // Force initialization of JVMCI compiler otherwise JVMCI
 554         // compilations will not block until JVMCI is initialized
 555         ResourceMark rm;
 556         TempNewSymbol getCompiler = SymbolTable::new_symbol("getCompiler", CHECK);
 557         TempNewSymbol sig = SymbolTable::new_symbol("()Ljdk/vm/ci/runtime/JVMCICompiler;", CHECK);
 558         Handle jvmciRuntime = JVMCIRuntime::get_HotSpotJVMCIRuntime(CHECK);
 559         JavaValue result(T_OBJECT);
 560         JavaCalls::call_virtual(&amp;result, jvmciRuntime, HotSpotJVMCIRuntime::klass(), getCompiler, sig, CHECK);
 561       }
 562     }
 563   }
 564 #endif // INCLUDE_JVMCI
 565 
 566 #ifdef COMPILER1
 567   if (c1_count &gt; 0) {
 568     _compilers[0] = new Compiler();
 569   }
 570 #endif // COMPILER1
 571 
 572 #ifdef COMPILER2
 573   if (true JVMCI_ONLY( &amp;&amp; !UseJVMCICompiler)) {
 574     if (c2_count &gt; 0) {
 575       _compilers[1] = new C2Compiler();
 576     }
 577   }
 578 #endif // COMPILER2
 579 
 580 #else // SHARK
 581   int c1_count = 0;
 582   int c2_count = 1;
 583 
 584   _compilers[1] = new SharkCompiler();
 585 #endif // SHARK
 586 
 587   // Start the compiler thread(s) and the sweeper thread
 588   init_compiler_sweeper_threads(c1_count, c2_count);
 589   // totalTime performance counter is always created as it is required
 590   // by the implementation of java.lang.management.CompilationMBean.
 591   {
 592     EXCEPTION_MARK;
 593     _perf_total_compilation =
 594                  PerfDataManager::create_counter(JAVA_CI, "totalTime",
 595                                                  PerfData::U_Ticks, CHECK);
 596   }
 597 
 598   if (UsePerfData) {
 599 
 600     EXCEPTION_MARK;
 601 
 602     // create the jvmstat performance counters
 603     _perf_osr_compilation =
 604                  PerfDataManager::create_counter(SUN_CI, "osrTime",
 605                                                  PerfData::U_Ticks, CHECK);
 606 
 607     _perf_standard_compilation =
 608                  PerfDataManager::create_counter(SUN_CI, "standardTime",
 609                                                  PerfData::U_Ticks, CHECK);
 610 
 611     _perf_total_bailout_count =
 612                  PerfDataManager::create_counter(SUN_CI, "totalBailouts",
 613                                                  PerfData::U_Events, CHECK);
 614 
 615     _perf_total_invalidated_count =
 616                  PerfDataManager::create_counter(SUN_CI, "totalInvalidates",
 617                                                  PerfData::U_Events, CHECK);
 618 
 619     _perf_total_compile_count =
 620                  PerfDataManager::create_counter(SUN_CI, "totalCompiles",
 621                                                  PerfData::U_Events, CHECK);
 622     _perf_total_osr_compile_count =
 623                  PerfDataManager::create_counter(SUN_CI, "osrCompiles",
 624                                                  PerfData::U_Events, CHECK);
 625 
 626     _perf_total_standard_compile_count =
 627                  PerfDataManager::create_counter(SUN_CI, "standardCompiles",
 628                                                  PerfData::U_Events, CHECK);
 629 
 630     _perf_sum_osr_bytes_compiled =
 631                  PerfDataManager::create_counter(SUN_CI, "osrBytes",
 632                                                  PerfData::U_Bytes, CHECK);
 633 
 634     _perf_sum_standard_bytes_compiled =
 635                  PerfDataManager::create_counter(SUN_CI, "standardBytes",
 636                                                  PerfData::U_Bytes, CHECK);
 637 
 638     _perf_sum_nmethod_size =
 639                  PerfDataManager::create_counter(SUN_CI, "nmethodSize",
 640                                                  PerfData::U_Bytes, CHECK);
 641 
 642     _perf_sum_nmethod_code_size =
 643                  PerfDataManager::create_counter(SUN_CI, "nmethodCodeSize",
 644                                                  PerfData::U_Bytes, CHECK);
 645 
 646     _perf_last_method =
 647                  PerfDataManager::create_string_variable(SUN_CI, "lastMethod",
 648                                        CompilerCounters::cmname_buffer_length,
 649                                        "", CHECK);
 650 
 651     _perf_last_failed_method =
 652             PerfDataManager::create_string_variable(SUN_CI, "lastFailedMethod",
 653                                        CompilerCounters::cmname_buffer_length,
 654                                        "", CHECK);
 655 
 656     _perf_last_invalidated_method =
 657         PerfDataManager::create_string_variable(SUN_CI, "lastInvalidatedMethod",
 658                                      CompilerCounters::cmname_buffer_length,
 659                                      "", CHECK);
 660 
 661     _perf_last_compile_type =
 662              PerfDataManager::create_variable(SUN_CI, "lastType",
 663                                               PerfData::U_None,
 664                                               (jlong)CompileBroker::no_compile,
 665                                               CHECK);
 666 
 667     _perf_last_compile_size =
 668              PerfDataManager::create_variable(SUN_CI, "lastSize",
 669                                               PerfData::U_Bytes,
 670                                               (jlong)CompileBroker::no_compile,
 671                                               CHECK);
 672 
 673 
 674     _perf_last_failed_type =
 675              PerfDataManager::create_variable(SUN_CI, "lastFailedType",
 676                                               PerfData::U_None,
 677                                               (jlong)CompileBroker::no_compile,
 678                                               CHECK);
 679 
 680     _perf_last_invalidated_type =
 681          PerfDataManager::create_variable(SUN_CI, "lastInvalidatedType",
 682                                           PerfData::U_None,
 683                                           (jlong)CompileBroker::no_compile,
 684                                           CHECK);
 685   }
 686 
 687   _initialized = true;
 688 }
 689 
 690 
 691 JavaThread* CompileBroker::make_thread(const char* name, CompileQueue* queue, CompilerCounters* counters,
 692                                        AbstractCompiler* comp, bool compiler_thread, TRAPS) {
 693   JavaThread* thread = NULL;
 694   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK_0);
 695   instanceKlassHandle klass (THREAD, k);
 696   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK_0);
 697   Handle string = java_lang_String::create_from_str(name, CHECK_0);
 698 
 699   // Initialize thread_oop to put it into the system threadGroup
 700   Handle thread_group (THREAD,  Universe::system_thread_group());
 701   JavaValue result(T_VOID);
 702   JavaCalls::call_special(&amp;result, thread_oop,
 703                        klass,
 704                        vmSymbols::object_initializer_name(),
 705                        vmSymbols::threadgroup_string_void_signature(),
 706                        thread_group,
 707                        string,
 708                        CHECK_0);
 709 
 710   {
 711     MutexLocker mu(Threads_lock, THREAD);
 712     if (compiler_thread) {
 713       thread = new CompilerThread(queue, counters);
 714     } else {
 715       thread = new CodeCacheSweeperThread();
 716     }
 717     // At this point the new CompilerThread data-races with this startup
 718     // thread (which I believe is the primoridal thread and NOT the VM
 719     // thread).  This means Java bytecodes being executed at startup can
 720     // queue compile jobs which will run at whatever default priority the
 721     // newly created CompilerThread runs at.
 722 
 723 
 724     // At this point it may be possible that no osthread was created for the
 725     // JavaThread due to lack of memory. We would have to throw an exception
 726     // in that case. However, since this must work and we do not allow
 727     // exceptions anyway, check and abort if this fails.
 728 
 729     if (thread == NULL || thread-&gt;osthread() == NULL) {
 730       vm_exit_during_initialization("java.lang.OutOfMemoryError",
 731                                     os::native_thread_creation_failed_msg());
 732     }
 733 
 734     java_lang_Thread::set_thread(thread_oop(), thread);
 735 
 736     // Note that this only sets the JavaThread _priority field, which by
 737     // definition is limited to Java priorities and not OS priorities.
 738     // The os-priority is set in the CompilerThread startup code itself
 739 
 740     java_lang_Thread::set_priority(thread_oop(), NearMaxPriority);
 741 
 742     // Note that we cannot call os::set_priority because it expects Java
 743     // priorities and we are *explicitly* using OS priorities so that it's
 744     // possible to set the compiler thread priority higher than any Java
 745     // thread.
 746 
 747     int native_prio = CompilerThreadPriority;
 748     if (native_prio == -1) {
 749       if (UseCriticalCompilerThreadPriority) {
 750         native_prio = os::java_to_os_priority[CriticalPriority];
 751       } else {
 752         native_prio = os::java_to_os_priority[NearMaxPriority];
 753       }
 754     }
 755     os::set_native_priority(thread, native_prio);
 756 
 757     java_lang_Thread::set_daemon(thread_oop());
 758 
 759     thread-&gt;set_threadObj(thread_oop());
 760     if (compiler_thread) {
 761       thread-&gt;as_CompilerThread()-&gt;set_compiler(comp);
 762     }
 763     Threads::add(thread);
 764     Thread::start(thread);
 765   }
 766 
 767   // Let go of Threads_lock before yielding
 768   os::naked_yield(); // make sure that the compiler thread is started early (especially helpful on SOLARIS)
 769 
 770   return thread;
 771 }
 772 
 773 
 774 void CompileBroker::init_compiler_sweeper_threads(int c1_compiler_count, int c2_compiler_count) {
 775   EXCEPTION_MARK;
 776 #if !defined(ZERO) &amp;&amp; !defined(SHARK)
 777   assert(c2_compiler_count &gt; 0 || c1_compiler_count &gt; 0, "No compilers?");
 778 #endif // !ZERO &amp;&amp; !SHARK
 779   // Initialize the compilation queue
 780   if (c2_compiler_count &gt; 0) {
 781     _c2_compile_queue  = new CompileQueue("C2 compile queue");
 782     _compilers[1]-&gt;set_num_compiler_threads(c2_compiler_count);
 783   }
 784   if (c1_compiler_count &gt; 0) {
 785     _c1_compile_queue  = new CompileQueue("C1 compile queue");
 786     _compilers[0]-&gt;set_num_compiler_threads(c1_compiler_count);
 787   }
 788 
 789   int compiler_count = c1_compiler_count + c2_compiler_count;
 790 
 791   char name_buffer[256];
 792   const bool compiler_thread = true;
 793   for (int i = 0; i &lt; c2_compiler_count; i++) {
 794     // Create a name for our thread.
 795     sprintf(name_buffer, "%s CompilerThread%d", _compilers[1]-&gt;name(), i);
 796     CompilerCounters* counters = new CompilerCounters();
 797     // Shark and C2
 798     make_thread(name_buffer, _c2_compile_queue, counters, _compilers[1], compiler_thread, CHECK);
 799   }
 800 
 801   for (int i = c2_compiler_count; i &lt; compiler_count; i++) {
 802     // Create a name for our thread.
 803     sprintf(name_buffer, "C1 CompilerThread%d", i);
 804     CompilerCounters* counters = new CompilerCounters();
 805     // C1
 806     make_thread(name_buffer, _c1_compile_queue, counters, _compilers[0], compiler_thread, CHECK);
 807   }
 808 
 809   if (UsePerfData) {
 810     PerfDataManager::create_constant(SUN_CI, "threads", PerfData::U_Bytes, compiler_count, CHECK);
 811   }
 812 
 813   if (MethodFlushing) {
 814     // Initialize the sweeper thread
 815     make_thread("Sweeper thread", NULL, NULL, NULL, false, CHECK);
 816   }
 817 }
 818 
 819 
 820 /**
 821  * Set the methods on the stack as on_stack so that redefine classes doesn't
 822  * reclaim them. This method is executed at a safepoint.
 823  */
 824 void CompileBroker::mark_on_stack() {
 825   assert(SafepointSynchronize::is_at_safepoint(), "sanity check");
 826   // Since we are at a safepoint, we do not need a lock to access
 827   // the compile queues.
 828   if (_c2_compile_queue != NULL) {
 829     _c2_compile_queue-&gt;mark_on_stack();
 830   }
 831   if (_c1_compile_queue != NULL) {
 832     _c1_compile_queue-&gt;mark_on_stack();
 833   }
 834 }
 835 
 836 // ------------------------------------------------------------------
 837 // CompileBroker::compile_method
 838 //
 839 // Request compilation of a method.
 840 void CompileBroker::compile_method_base(const methodHandle&amp; method,
 841                                         int osr_bci,
 842                                         int comp_level,
 843                                         const methodHandle&amp; hot_method,
 844                                         int hot_count,
 845                                         const char* comment,
 846                                         Thread* thread) {
 847   // do nothing if compiler thread(s) is not available
 848   if (!_initialized) {
 849     return;
 850   }
 851 
 852   guarantee(!method-&gt;is_abstract(), "cannot compile abstract methods");
 853   assert(method-&gt;method_holder()-&gt;is_instance_klass(),
 854          "sanity check");
 855   assert(!method-&gt;method_holder()-&gt;is_not_initialized(),
 856          "method holder must be initialized");
 857   assert(!method-&gt;is_method_handle_intrinsic(), "do not enqueue these guys");
 858 
 859   if (CIPrintRequests) {
 860     tty-&gt;print("request: ");
 861     method-&gt;print_short_name(tty);
 862     if (osr_bci != InvocationEntryBci) {
 863       tty-&gt;print(" osr_bci: %d", osr_bci);
 864     }
 865     tty-&gt;print(" level: %d comment: %s count: %d", comp_level, comment, hot_count);
 866     if (!hot_method.is_null()) {
 867       tty-&gt;print(" hot: ");
 868       if (hot_method() != method()) {
 869           hot_method-&gt;print_short_name(tty);
 870       } else {
 871         tty-&gt;print("yes");
 872       }
 873     }
 874     tty-&gt;cr();
 875   }
 876 
 877   // A request has been made for compilation.  Before we do any
 878   // real work, check to see if the method has been compiled
 879   // in the meantime with a definitive result.
 880   if (compilation_is_complete(method, osr_bci, comp_level)) {
 881     return;
 882   }
 883 
 884 #ifndef PRODUCT
 885   if (osr_bci != -1 &amp;&amp; !FLAG_IS_DEFAULT(OSROnlyBCI)) {
 886     if ((OSROnlyBCI &gt; 0) ? (OSROnlyBCI != osr_bci) : (-OSROnlyBCI == osr_bci)) {
 887       // Positive OSROnlyBCI means only compile that bci.  Negative means don't compile that BCI.
 888       return;
 889     }
 890   }
 891 #endif
 892 
 893   // If this method is already in the compile queue, then
 894   // we do not block the current thread.
 895   if (compilation_is_in_queue(method)) {
 896     // We may want to decay our counter a bit here to prevent
 897     // multiple denied requests for compilation.  This is an
 898     // open compilation policy issue. Note: The other possibility,
 899     // in the case that this is a blocking compile request, is to have
 900     // all subsequent blocking requesters wait for completion of
 901     // ongoing compiles. Note that in this case we'll need a protocol
 902     // for freeing the associated compile tasks. [Or we could have
 903     // a single static monitor on which all these waiters sleep.]
 904     return;
 905   }
 906 
 907   // If the requesting thread is holding the pending list lock
 908   // then we just return. We can't risk blocking while holding
 909   // the pending list lock or a 3-way deadlock may occur
 910   // between the reference handler thread, a GC (instigated
 911   // by a compiler thread), and compiled method registration.
 912   if (InstanceRefKlass::owns_pending_list_lock(JavaThread::current())) {
 913     return;
 914   }
 915 
 916   if (TieredCompilation) {
 917     // Tiered policy requires MethodCounters to exist before adding a method to
 918     // the queue. Create if we don't have them yet.
 919     method-&gt;get_method_counters(thread);
 920   }
 921 
 922   // Outputs from the following MutexLocker block:
 923   CompileTask* task     = NULL;
 924   bool         blocking = false;
 925   CompileQueue* queue  = compile_queue(comp_level);
 926 
 927   // Acquire our lock.
 928   {
 929     MutexLocker locker(MethodCompileQueue_lock, thread);
 930 
 931     // Make sure the method has not slipped into the queues since
 932     // last we checked; note that those checks were "fast bail-outs".
 933     // Here we need to be more careful, see 14012000 below.
 934     if (compilation_is_in_queue(method)) {
 935       return;
 936     }
 937 
 938     // We need to check again to see if the compilation has
 939     // completed.  A previous compilation may have registered
 940     // some result.
 941     if (compilation_is_complete(method, osr_bci, comp_level)) {
 942       return;
 943     }
 944 
 945     // We now know that this compilation is not pending, complete,
 946     // or prohibited.  Assign a compile_id to this compilation
 947     // and check to see if it is in our [Start..Stop) range.
 948     int compile_id = assign_compile_id(method, osr_bci);
 949     if (compile_id == 0) {
 950       // The compilation falls outside the allowed range.
 951       return;
 952     }
 953 
 954     // Should this thread wait for completion of the compile?
 955     blocking = is_compile_blocking();
 956 
 957 #if INCLUDE_JVMCI
 958     if (UseJVMCICompiler) {
 959       if (blocking) {
 960         // Don't allow blocking compiles for requests triggered by JVMCI.
 961         if (thread-&gt;is_Compiler_thread()) {
 962           blocking = false;
 963         }
 964 
 965         // Don't allow blocking compiles if inside a class initializer or while performing class loading
 966         vframeStream vfst((JavaThread*) thread);
 967         for (; !vfst.at_end(); vfst.next()) {
 968           if (vfst.method()-&gt;is_static_initializer() ||
 969               (vfst.method()-&gt;method_holder()-&gt;is_subclass_of(SystemDictionary::ClassLoader_klass()) &amp;&amp;
 970                   vfst.method()-&gt;name() == vmSymbols::loadClass_name())) {
 971             blocking = false;
 972             break;
 973           }
 974         }
 975 
 976         // Don't allow blocking compilation requests to JVMCI
 977         // if JVMCI itself is not yet initialized
 978         if (!JVMCIRuntime::is_HotSpotJVMCIRuntime_initialized() &amp;&amp; compiler(comp_level)-&gt;is_jvmci()) {
 979           blocking = false;
 980         }
 981 
 982         // Don't allow blocking compilation requests if we are in JVMCIRuntime::shutdown
 983         // to avoid deadlock between compiler thread(s) and threads run at shutdown
 984         // such as the DestroyJavaVM thread.
 985         if (JVMCIRuntime::shutdown_called()) {
 986           blocking = false;
 987         }
 988       }
 989     }
 990 #endif // INCLUDE_JVMCI
 991 
 992     // We will enter the compilation in the queue.
 993     // 14012000: Note that this sets the queued_for_compile bits in
 994     // the target method. We can now reason that a method cannot be
 995     // queued for compilation more than once, as follows:
 996     // Before a thread queues a task for compilation, it first acquires
 997     // the compile queue lock, then checks if the method's queued bits
 998     // are set or it has already been compiled. Thus there can not be two
 999     // instances of a compilation task for the same method on the
1000     // compilation queue. Consider now the case where the compilation
1001     // thread has already removed a task for that method from the queue
1002     // and is in the midst of compiling it. In this case, the
1003     // queued_for_compile bits must be set in the method (and these
1004     // will be visible to the current thread, since the bits were set
1005     // under protection of the compile queue lock, which we hold now.
1006     // When the compilation completes, the compiler thread first sets
1007     // the compilation result and then clears the queued_for_compile
1008     // bits. Neither of these actions are protected by a barrier (or done
1009     // under the protection of a lock), so the only guarantee we have
1010     // (on machines with TSO (Total Store Order)) is that these values
1011     // will update in that order. As a result, the only combinations of
1012     // these bits that the current thread will see are, in temporal order:
1013     // &lt;RESULT, QUEUE&gt; :
1014     //     &lt;0, 1&gt; : in compile queue, but not yet compiled
1015     //     &lt;1, 1&gt; : compiled but queue bit not cleared
1016     //     &lt;1, 0&gt; : compiled and queue bit cleared
1017     // Because we first check the queue bits then check the result bits,
1018     // we are assured that we cannot introduce a duplicate task.
1019     // Note that if we did the tests in the reverse order (i.e. check
1020     // result then check queued bit), we could get the result bit before
1021     // the compilation completed, and the queue bit after the compilation
1022     // completed, and end up introducing a "duplicate" (redundant) task.
1023     // In that case, the compiler thread should first check if a method
1024     // has already been compiled before trying to compile it.
1025     // NOTE: in the event that there are multiple compiler threads and
1026     // there is de-optimization/recompilation, things will get hairy,
1027     // and in that case it's best to protect both the testing (here) of
1028     // these bits, and their updating (here and elsewhere) under a
1029     // common lock.
1030     task = create_compile_task(queue,
1031                                compile_id, method,
1032                                osr_bci, comp_level,
1033                                hot_method, hot_count, comment,
1034                                blocking);
1035   }
1036 
1037   if (blocking) {
1038     wait_for_completion(task);
1039   }
1040 }
1041 
1042 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1043                                        int comp_level,
1044                                        const methodHandle&amp; hot_method, int hot_count,
1045                                        const char* comment, Thread* THREAD) {
1046 
1047   // make sure arguments make sense
1048   assert(method-&gt;method_holder()-&gt;is_instance_klass(), "not an instance method");
1049   assert(osr_bci == InvocationEntryBci || (0 &lt;= osr_bci &amp;&amp; osr_bci &lt; method-&gt;code_size()), "bci out of range");
1050   assert(!method-&gt;is_abstract() &amp;&amp; (osr_bci == InvocationEntryBci || !method-&gt;is_native()), "cannot compile abstract/native methods");
1051   assert(!method-&gt;method_holder()-&gt;is_not_initialized(), "method holder must be initialized");
1052   // allow any levels for WhiteBox
1053   assert(WhiteBoxAPI || TieredCompilation || comp_level == CompLevel_highest_tier, "only CompLevel_highest_tier must be used in non-tiered");
1054   // return quickly if possible
1055 
1056  // start by figuring out the new compile level in case the method is cached
1057  int cached_comp_level = 0;
1058  if(CacheProfiles &amp;&amp; ciCacheProfiles::is_initialized()) {
1059    // if it's set trigger replayCompilation in case it's a cached method
1060    cached_comp_level = ciCacheProfiles::is_cached(method());
1061    // we only use cached profiles for Level 3 or 4
1062    // because 1 and 2 are used in special cases (i.e. compile queue full)
1063    // and we don't want to mess with that
1064    // also check if decompile count is less than 10 since we don't want to
1065    // recompile a lot using a bad profile
1066    if(cached_comp_level &gt; CompLevel_limited_profile &amp;&amp; comp_level &gt; CompLevel_limited_profile
1067            &amp;&amp; (method-&gt;method_data() == NULL || (method-&gt;method_data() != NULL &amp;&amp; method-&gt;method_data()-&gt;decompile_count() &lt; 10)))
1068    {
1069          // now both compile level and cache level are always &gt;= 3
1070          //
1071          // if we're in cacheprofilemode 2 AND compile level 3 and have a cache level 4
1072          // always set compile level to 2 to remove profiling from C1
1073          if(CacheProfilesMode==2 &amp;&amp; (comp_level == CompLevel_full_profile &amp;&amp; cached_comp_level == CompLevel_full_optimization)) {
1074            comp_level = CompLevel_limited_profile;
1075            if(PrintCacheProfiles) {
1076                  tty-&gt;print("CacheProfiles: Force Compilationlevel to %d, Hotcount: %d, OSR_BCI: %d :: ", comp_level,hot_count,osr_bci);
1077                  method-&gt;print_name(tty);
1078                  tty-&gt;print_cr(" &lt;");
1079            }
1080          // as long as we're not in mode 2
1081          // OR in mode 2 and a level 3 (with no level 4 profile available) or level 4 compilation (with either profiles)
1082          } else {
1083            // fix compile level to the one of the cached profile
1084            // this can result in promotion of level 3 compilations to level 4
1085            // (not the other way around)
1086            if(comp_level &lt; cached_comp_level) {
1087                  if(PrintCacheProfiles) {
1088                    tty-&gt;print("CacheProfiles: Promote Compilationlevel from %d to %d, Hotcount: %d, OSR_BCI: %d :: ",comp_level, cached_comp_level, hot_count,osr_bci);
1089                    method-&gt;print_name(tty);
1090                    tty-&gt;print_cr(" &lt;");
1091                  }
1092                  comp_level = cached_comp_level;
1093            }
1094          }
1095    }
1096  }
1097 
1098   // lock, make sure that the compilation
1099   // isn't prohibited in a straightforward way.
1100   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1101   if (comp == NULL || !comp-&gt;can_compile_method(method) ||
1102       compilation_is_prohibited(method, osr_bci, comp_level)) {
1103     return NULL;
1104   }
1105 
1106   if (osr_bci == InvocationEntryBci) {
1107     // standard compilation
1108     nmethod* method_code = method-&gt;code();
1109     if (method_code != NULL) {
1110       if (compilation_is_complete(method, osr_bci, comp_level)) {
1111         return method_code;
1112       }
1113     }
1114     if (method-&gt;is_not_compilable(comp_level)) {
1115       return NULL;
1116     }
1117   } else {
1118     // osr compilation
1119 #ifndef TIERED
1120     // seems like an assert of dubious value
1121     assert(comp_level == CompLevel_highest_tier,
1122            "all OSR compiles are assumed to be at a single compilation level");
1123 #endif // TIERED
1124     // We accept a higher level osr method
1125     nmethod* nm = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1126     if (nm != NULL) return nm;
1127     if (method-&gt;is_not_osr_compilable(comp_level)) return NULL;
1128   }
1129 
1130   assert(!HAS_PENDING_EXCEPTION, "No exception should be present");
1131   // some prerequisites that are compiler specific
1132   if (comp-&gt;is_c2() || comp-&gt;is_shark()) {
1133     method-&gt;constants()-&gt;resolve_string_constants(CHECK_AND_CLEAR_NULL);
1134     // Resolve all classes seen in the signature of the method
1135     // we are compiling.
1136     Method::load_signature_classes(method, CHECK_AND_CLEAR_NULL);
1137   }
1138 
1139   // If the method is native, do the lookup in the thread requesting
1140   // the compilation. Native lookups can load code, which is not
1141   // permitted during compilation.
1142   //
1143   // Note: A native method implies non-osr compilation which is
1144   //       checked with an assertion at the entry of this method.
1145   if (method-&gt;is_native() &amp;&amp; !method-&gt;is_method_handle_intrinsic()) {
1146     bool in_base_library;
1147     address adr = NativeLookup::lookup(method, in_base_library, THREAD);
1148     if (HAS_PENDING_EXCEPTION) {
1149       // In case of an exception looking up the method, we just forget
1150       // about it. The interpreter will kick-in and throw the exception.
1151       method-&gt;set_not_compilable(); // implies is_not_osr_compilable()
1152       CLEAR_PENDING_EXCEPTION;
1153       return NULL;
1154     }
1155     assert(method-&gt;has_native_function(), "must have native code by now");
1156   }
1157 
1158   // RedefineClasses() has replaced this method; just return
1159   if (method-&gt;is_old()) {
1160     return NULL;
1161   }
1162 
1163   // JVMTI -- post_compile_event requires jmethod_id() that may require
1164   // a lock the compiling thread can not acquire. Prefetch it here.
1165   if (JvmtiExport::should_post_compiled_method_load()) {
1166     method-&gt;jmethod_id();
1167   }
1168 
1169   // do the compilation
1170   if (method-&gt;is_native()) {
1171     if (!PreferInterpreterNativeStubs || method-&gt;is_method_handle_intrinsic()) {
1172       // The following native methods:
1173       //
1174       // java.lang.Float.intBitsToFloat
1175       // java.lang.Float.floatToRawIntBits
1176       // java.lang.Double.longBitsToDouble
1177       // java.lang.Double.doubleToRawLongBits
1178       //
1179       // are called through the interpreter even if interpreter native stubs
1180       // are not preferred (i.e., calling through adapter handlers is preferred).
1181       // The reason is that on x86_32 signaling NaNs (sNaNs) are not preserved
1182       // if the version of the methods from the native libraries is called.
1183       // As the interpreter and the C2-intrinsified version of the methods preserves
1184       // sNaNs, that would result in an inconsistent way of handling of sNaNs.
1185       if ((UseSSE &gt;= 1 &amp;&amp;
1186           (method-&gt;intrinsic_id() == vmIntrinsics::_intBitsToFloat ||
1187            method-&gt;intrinsic_id() == vmIntrinsics::_floatToRawIntBits)) ||
1188           (UseSSE &gt;= 2 &amp;&amp;
1189            (method-&gt;intrinsic_id() == vmIntrinsics::_longBitsToDouble ||
1190             method-&gt;intrinsic_id() == vmIntrinsics::_doubleToRawLongBits))) {
1191         return NULL;
1192       }
1193 
1194       // To properly handle the appendix argument for out-of-line calls we are using a small trampoline that
1195       // pops off the appendix argument and jumps to the target (see gen_special_dispatch in SharedRuntime).
1196       //
1197       // Since normal compiled-to-compiled calls are not able to handle such a thing we MUST generate an adapter
1198       // in this case.  If we can't generate one and use it we can not execute the out-of-line method handle calls.
1199       AdapterHandlerLibrary::create_native_wrapper(method);
1200     } else {
1201       return NULL;
1202     }
1203   } else {
1204     // If the compiler is shut off due to code cache getting full
1205     // fail out now so blocking compiles dont hang the java thread
1206     if (!should_compile_new_jobs()) {
1207       CompilationPolicy::policy()-&gt;delay_compilation(method());
1208       return NULL;
1209     }
1210  // first, check whether the CacheProfiles flag is set, if not continue as usual
1211  if(CacheProfiles &amp;&amp; ciCacheProfiles::is_initialized()) {
1212    // if it's set trigger replayCompilation in case it's a cached method
1213    // continue if method is cached and of level 3 or 4
1214    // AND our compile level actually matches cache level (we can not use a LVL3 profile for LVL4 compilations)
1215    // AND finally check if method has not been compiled more than 10 time already (using the cached profile)
1216    // Note: this is independent of the cacheprofilesmode since it will lower the level to 2 if it
1217    //       does not want to use cached profiles
1218    if(cached_comp_level &gt; CompLevel_limited_profile &amp;&amp;  comp_level &gt; CompLevel_limited_profile
1219            &amp;&amp; comp_level == cached_comp_level
1220            &amp;&amp; (method-&gt;method_data() == NULL || (method-&gt;method_data() != NULL &amp;&amp; method-&gt;method_data()-&gt;decompile_count() &lt; 10)))
1221    {
1222          if(PrintCacheProfiles) {
1223            tty-&gt;print("CacheProfiles: Use level %d profile for level %d compilation, Hotcount: %d, OSR_BCI: %d :: ",cached_comp_level, comp_level, hot_count,osr_bci);
1224            method-&gt;print_name(tty);
1225            tty-&gt;print_cr(" &lt;");
1226          }
1227          int exit_code = ciCacheProfiles::replay(THREAD,method(),osr_bci,false);
1228          if(exit_code == 0) {
1229            return osr_bci  == InvocationEntryBci ? method-&gt;code() : method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1230          } // else continue and remove profile (and compile normally)
1231          tty-&gt;print_cr("Bailed out of compilation for %s", method()-&gt;name()-&gt;as_utf8());
1232          ciCacheProfiles::clear_cache(method());
1233    }
1234  }
1235  // if it's not in the cache or if we're using CacheProfileMode=2, just compile method base
1236  if(PrintCacheProfiles) {
1237    //tty-&gt;print("CacheProfiles: Not use profile for level %d compilation, Hotcount: %d, OSR_BCI: %d :: ",comp_level, hot_count,osr_bci);
1238    //method-&gt;print_name(tty);
1239    //tty-&gt;print_cr(" &lt;");
1240  }
1241     //bool is_blocking = !directive-&gt;BackgroundCompilationOption || CompileTheWorld || ReplayCompiles;
1242     compile_method_base(method, osr_bci, comp_level, hot_method, hot_count, comment, THREAD);
1243   }
1244 
1245   // return requested nmethod
1246   // We accept a higher level osr method
1247   if (osr_bci == InvocationEntryBci) {
1248     return method-&gt;code();
1249   }
1250   return method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1251 }
1252 
1253 
1254 // ------------------------------------------------------------------
1255 // CompileBroker::compilation_is_complete
1256 //
1257 // See if compilation of this method is already complete.
1258 bool CompileBroker::compilation_is_complete(const methodHandle&amp; method,
1259                                             int                 osr_bci,
1260                                             int                 comp_level) {
1261   bool is_osr = (osr_bci != standard_entry_bci);
1262   if (is_osr) {
1263     if (method-&gt;is_not_osr_compilable(comp_level)) {
1264       return true;
1265     } else {
1266       nmethod* result = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, true);
1267       return (result != NULL);
1268     }
1269   } else {
1270     if (method-&gt;is_not_compilable(comp_level)) {
1271       return true;
1272     } else {
1273       nmethod* result = method-&gt;code();
1274       if (result == NULL) return false;
1275       return comp_level == result-&gt;comp_level();
1276     }
1277   }
1278 }
1279 
1280 
1281 /**
1282  * See if this compilation is already requested.
1283  *
1284  * Implementation note: there is only a single "is in queue" bit
1285  * for each method.  This means that the check below is overly
1286  * conservative in the sense that an osr compilation in the queue
1287  * will block a normal compilation from entering the queue (and vice
1288  * versa).  This can be remedied by a full queue search to disambiguate
1289  * cases.  If it is deemed profitable, this may be done.
1290  */
1291 bool CompileBroker::compilation_is_in_queue(const methodHandle&amp; method) {
1292   return method-&gt;queued_for_compilation();
1293 }
1294 
1295 // ------------------------------------------------------------------
1296 // CompileBroker::compilation_is_prohibited
1297 //
1298 // See if this compilation is not allowed.
1299 bool CompileBroker::compilation_is_prohibited(const methodHandle&amp; method, int osr_bci, int comp_level) {
1300   bool is_native = method-&gt;is_native();
1301   // Some compilers may not support the compilation of natives.
1302   AbstractCompiler *comp = compiler(comp_level);
1303   if (is_native &amp;&amp;
1304       (!CICompileNatives || comp == NULL || !comp-&gt;supports_native())) {
1305     method-&gt;set_not_compilable_quietly(comp_level);
1306     return true;
1307   }
1308 
1309   bool is_osr = (osr_bci != standard_entry_bci);
1310   // Some compilers may not support on stack replacement.
1311   if (is_osr &amp;&amp;
1312       (!CICompileOSR || comp == NULL || !comp-&gt;supports_osr())) {
1313     method-&gt;set_not_osr_compilable(comp_level);
1314     return true;
1315   }
1316 
1317   // Breaking the abstraction - directives are only used inside a compilation otherwise.
1318   DirectiveSet* directive = DirectivesStack::getMatchingDirective(method, comp);
1319   bool excluded = directive-&gt;ExcludeOption;
1320   DirectivesStack::release(directive);
1321 
1322   // The method may be explicitly excluded by the user.
1323   double scale;
1324   if (excluded || (CompilerOracle::has_option_value(method, "CompileThresholdScaling", scale) &amp;&amp; scale == 0)) {
1325     bool quietly = CompilerOracle::should_exclude_quietly();
1326     if (PrintCompilation &amp;&amp; !quietly) {
1327       // This does not happen quietly...
1328       ResourceMark rm;
1329       tty-&gt;print("### Excluding %s:%s",
1330                  method-&gt;is_native() ? "generation of native wrapper" : "compile",
1331                  (method-&gt;is_static() ? " static" : ""));
1332       method-&gt;print_short_name(tty);
1333       tty-&gt;cr();
1334     }
1335     method-&gt;set_not_compilable(comp_level, !quietly, "excluded by CompileCommand");
1336   }
1337 
1338   return false;
1339 }
1340 
1341 /**
1342  * Generate serialized IDs for compilation requests. If certain debugging flags are used
1343  * and the ID is not within the specified range, the method is not compiled and 0 is returned.
1344  * The function also allows to generate separate compilation IDs for OSR compilations.
1345  */
1346 int CompileBroker::assign_compile_id(const methodHandle&amp; method, int osr_bci) {
1347 #ifdef ASSERT
1348   bool is_osr = (osr_bci != standard_entry_bci);
1349   int id;
1350   if (method-&gt;is_native()) {
1351     assert(!is_osr, "can't be osr");
1352     // Adapters, native wrappers and method handle intrinsics
1353     // should be generated always.
1354     return Atomic::add(1, &amp;_compilation_id);
1355   } else if (CICountOSR &amp;&amp; is_osr) {
1356     id = Atomic::add(1, &amp;_osr_compilation_id);
1357     if (CIStartOSR &lt;= id &amp;&amp; id &lt; CIStopOSR) {
1358       return id;
1359     }
1360   } else {
1361     id = Atomic::add(1, &amp;_compilation_id);
1362     if (CIStart &lt;= id &amp;&amp; id &lt; CIStop) {
1363       return id;
1364     }
1365   }
1366 
1367   // Method was not in the appropriate compilation range.
1368   method-&gt;set_not_compilable_quietly();
1369   return 0;
1370 #else
1371   // CICountOSR is a develop flag and set to 'false' by default. In a product built,
1372   // only _compilation_id is incremented.
1373   return Atomic::add(1, &amp;_compilation_id);
1374 #endif
1375 }
1376 
1377 // ------------------------------------------------------------------
1378 // CompileBroker::assign_compile_id_unlocked
1379 //
1380 // Public wrapper for assign_compile_id that acquires the needed locks
1381 uint CompileBroker::assign_compile_id_unlocked(Thread* thread, const methodHandle&amp; method, int osr_bci) {
1382   MutexLocker locker(MethodCompileQueue_lock, thread);
1383   return assign_compile_id(method, osr_bci);
1384 }
1385 
1386 /**
1387  * Should the current thread block until this compilation request
1388  * has been fulfilled?
1389  */
1390 bool CompileBroker::is_compile_blocking() {
1391   assert(!InstanceRefKlass::owns_pending_list_lock(JavaThread::current()), "possible deadlock");
1392   return !BackgroundCompilation;
1393 }
1394 
1395 // ------------------------------------------------------------------
1396 // CompileBroker::preload_classes
1397 void CompileBroker::preload_classes(const methodHandle&amp; method, TRAPS) {
1398   // Move this code over from c1_Compiler.cpp
1399   ShouldNotReachHere();
1400 }
1401 
1402 
1403 // ------------------------------------------------------------------
1404 // CompileBroker::create_compile_task
1405 //
1406 // Create a CompileTask object representing the current request for
1407 // compilation.  Add this task to the queue.
1408 CompileTask* CompileBroker::create_compile_task(CompileQueue*       queue,
1409                                                 int                 compile_id,
1410                                                 const methodHandle&amp; method,
1411                                                 int                 osr_bci,
1412                                                 int                 comp_level,
1413                                                 const methodHandle&amp; hot_method,
1414                                                 int                 hot_count,
1415                                                 const char*         comment,
1416                                                 bool                blocking) {
1417   CompileTask* new_task = CompileTask::allocate();
1418   new_task-&gt;initialize(compile_id, method, osr_bci, comp_level,
1419                        hot_method, hot_count, comment,
1420                        blocking);
1421   queue-&gt;add(new_task);
1422   return new_task;
1423 }
1424 
1425 #if INCLUDE_JVMCI
1426 // The number of milliseconds to wait before checking if
1427 // JVMCI compilation has made progress.
1428 static const long JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE = 500;
1429 
1430 // The number of JVMCI compilation progress checks that must fail
1431 // before unblocking a thread waiting for a blocking compilation.
1432 static const int JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS = 5;
1433 
1434 /**
1435  * Waits for a JVMCI compiler to complete a given task. This thread
1436  * waits until either the task completes or it sees no JVMCI compilation
1437  * progress for N consecutive milliseconds where N is
1438  * JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE *
1439  * JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS.
1440  *
1441  * @return true if this thread needs to free/recycle the task
1442  */
1443 bool CompileBroker::wait_for_jvmci_completion(JVMCICompiler* jvmci, CompileTask* task, JavaThread* thread) {
1444   MutexLocker waiter(task-&gt;lock(), thread);
1445   int progress_wait_attempts = 0;
1446   int methods_compiled = jvmci-&gt;methods_compiled();
1447   while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever() &amp;&amp;
1448          task-&gt;lock()-&gt;wait(!Mutex::_no_safepoint_check_flag, JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE)) {
1449     CompilerThread* jvmci_compiler_thread = task-&gt;jvmci_compiler_thread();
1450 
1451     bool progress;
1452     if (jvmci_compiler_thread != NULL) {
1453       // If the JVMCI compiler thread is not blocked, we deem it to be making progress.
1454       progress = jvmci_compiler_thread-&gt;thread_state() != _thread_blocked;
1455     } else {
1456       // Still waiting on JVMCI compiler queue. This thread may be holding a lock
1457       // that all JVMCI compiler threads are blocked on. We use the counter for
1458       // successful JVMCI compilations to determine whether JVMCI compilation
1459       // is still making progress through the JVMCI compiler queue.
1460       progress = jvmci-&gt;methods_compiled() != methods_compiled;
1461     }
1462 
1463     if (!progress) {
1464       if (++progress_wait_attempts == JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS) {
1465         if (PrintCompilation) {
1466           task-&gt;print(tty, "wait for blocking compilation timed out");
1467         }
1468         break;
1469       }
1470     } else {
1471       progress_wait_attempts = 0;
1472       if (jvmci_compiler_thread == NULL) {
1473         methods_compiled = jvmci-&gt;methods_compiled();
1474       }
1475     }
1476   }
1477   task-&gt;clear_waiter();
1478   return task-&gt;is_complete();
1479 }
1480 #endif
1481 
1482 /**
1483  *  Wait for the compilation task to complete.
1484  */
1485 void CompileBroker::wait_for_completion(CompileTask* task) {
1486   if (CIPrintCompileQueue) {
1487     ttyLocker ttyl;
1488     tty-&gt;print_cr("BLOCKING FOR COMPILE");
1489   }
1490 
1491   assert(task-&gt;is_blocking(), "can only wait on blocking task");
1492 
1493   JavaThread* thread = JavaThread::current();
1494   thread-&gt;set_blocked_on_compilation(true);
1495 
1496   methodHandle method(thread, task-&gt;method());
1497   bool free_task;
1498 #if INCLUDE_JVMCI
1499   AbstractCompiler* comp = compiler(task-&gt;comp_level());
1500   if (comp-&gt;is_jvmci()) {
1501     free_task = wait_for_jvmci_completion((JVMCICompiler*) comp, task, thread);
1502   } else
1503 #endif
1504   {
1505     MutexLocker waiter(task-&gt;lock(), thread);
1506     free_task = true;
1507     while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever()) {
1508       task-&gt;lock()-&gt;wait();
1509     }
1510   }
1511 
1512   thread-&gt;set_blocked_on_compilation(false);
1513   if (free_task) {
1514     if (is_compilation_disabled_forever()) {
1515       CompileTask::free(task);
1516       return;
1517     }
1518 
1519     // It is harmless to check this status without the lock, because
1520     // completion is a stable property (until the task object is recycled).
1521     assert(task-&gt;is_complete(), "Compilation should have completed");
1522     assert(task-&gt;code_handle() == NULL, "must be reset");
1523 
1524     // By convention, the waiter is responsible for recycling a
1525     // blocking CompileTask. Since there is only one waiter ever
1526     // waiting on a CompileTask, we know that no one else will
1527     // be using this CompileTask; we can free it.
1528     CompileTask::free(task);
1529   }
1530 }
1531 
1532 /**
1533  * Initialize compiler thread(s) + compiler object(s). The postcondition
1534  * of this function is that the compiler runtimes are initialized and that
1535  * compiler threads can start compiling.
1536  */
1537 bool CompileBroker::init_compiler_runtime() {
1538   CompilerThread* thread = CompilerThread::current();
1539   AbstractCompiler* comp = thread-&gt;compiler();
1540   // Final sanity check - the compiler object must exist
1541   guarantee(comp != NULL, "Compiler object must exist");
1542 
1543   int system_dictionary_modification_counter;
1544   {
1545     MutexLocker locker(Compile_lock, thread);
1546     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1547   }
1548 
1549   {
1550     // Must switch to native to allocate ci_env
1551     ThreadToNativeFromVM ttn(thread);
1552     ciEnv ci_env(NULL, system_dictionary_modification_counter);
1553     // Cache Jvmti state
1554     ci_env.cache_jvmti_state();
1555     // Cache DTrace flags
1556     ci_env.cache_dtrace_flags();
1557 
1558     // Switch back to VM state to do compiler initialization
1559     ThreadInVMfromNative tv(thread);
1560     ResetNoHandleMark rnhm;
1561 
1562     if (!comp-&gt;is_shark()) {
1563       // Perform per-thread and global initializations
1564       comp-&gt;initialize();
1565     }
1566   }
1567 
1568   if (comp-&gt;is_failed()) {
1569     disable_compilation_forever();
1570     // If compiler initialization failed, no compiler thread that is specific to a
1571     // particular compiler runtime will ever start to compile methods.
1572     shutdown_compiler_runtime(comp, thread);
1573     return false;
1574   }
1575 
1576   // C1 specific check
1577   if (comp-&gt;is_c1() &amp;&amp; (thread-&gt;get_buffer_blob() == NULL)) {
1578     warning("Initialization of %s thread failed (no space to run compilers)", thread-&gt;name());
1579     return false;
1580   }
1581 
1582   return true;
1583 }
1584 
1585 /**
1586  * If C1 and/or C2 initialization failed, we shut down all compilation.
1587  * We do this to keep things simple. This can be changed if it ever turns
1588  * out to be a problem.
1589  */
1590 void CompileBroker::shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread) {
1591   // Free buffer blob, if allocated
1592   if (thread-&gt;get_buffer_blob() != NULL) {
1593     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1594     CodeCache::free(thread-&gt;get_buffer_blob());
1595   }
1596 
1597   if (comp-&gt;should_perform_shutdown()) {
1598     // There are two reasons for shutting down the compiler
1599     // 1) compiler runtime initialization failed
1600     // 2) The code cache is full and the following flag is set: -XX:-UseCodeCacheFlushing
1601     warning("%s initialization failed. Shutting down all compilers", comp-&gt;name());
1602 
1603     // Only one thread per compiler runtime object enters here
1604     // Set state to shut down
1605     comp-&gt;set_shut_down();
1606 
1607     // Delete all queued compilation tasks to make compiler threads exit faster.
1608     if (_c1_compile_queue != NULL) {
1609       _c1_compile_queue-&gt;free_all();
1610     }
1611 
1612     if (_c2_compile_queue != NULL) {
1613       _c2_compile_queue-&gt;free_all();
1614     }
1615 
1616     // Set flags so that we continue execution with using interpreter only.
1617     UseCompiler    = false;
1618     UseInterpreter = true;
1619 
1620     // We could delete compiler runtimes also. However, there are references to
1621     // the compiler runtime(s) (e.g.,  nmethod::is_compiled_by_c1()) which then
1622     // fail. This can be done later if necessary.
1623   }
1624 }
1625 
1626 // ------------------------------------------------------------------
1627 // CompileBroker::compiler_thread_loop
1628 //
1629 // The main loop run by a CompilerThread.
1630 void CompileBroker::compiler_thread_loop() {
1631   CompilerThread* thread = CompilerThread::current();
1632   CompileQueue* queue = thread-&gt;queue();
1633   // For the thread that initializes the ciObjectFactory
1634   // this resource mark holds all the shared objects
1635   ResourceMark rm;
1636 
1637   // First thread to get here will initialize the compiler interface
1638 
1639   if (!ciObjectFactory::is_initialized()) {
1640     ASSERT_IN_VM;
1641     MutexLocker only_one (CompileThread_lock, thread);
1642     if (!ciObjectFactory::is_initialized()) {
1643       ciObjectFactory::initialize();
1644     }
1645   }
1646 
1647   // Open a log.
1648   if (LogCompilation) {
1649     init_compiler_thread_log();
1650   }
1651   CompileLog* log = thread-&gt;log();
1652   if (log != NULL) {
1653     log-&gt;begin_elem("start_compile_thread name='%s' thread='" UINTX_FORMAT "' process='%d'",
1654                     thread-&gt;name(),
1655                     os::current_thread_id(),
1656                     os::current_process_id());
1657     log-&gt;stamp();
1658     log-&gt;end_elem();
1659   }
1660 
1661   // If compiler thread/runtime initialization fails, exit the compiler thread
1662   if (!init_compiler_runtime()) {
1663     return;
1664   }
1665 
1666   // Poll for new compilation tasks as long as the JVM runs. Compilation
1667   // should only be disabled if something went wrong while initializing the
1668   // compiler runtimes. This, in turn, should not happen. The only known case
1669   // when compiler runtime initialization fails is if there is not enough free
1670   // space in the code cache to generate the necessary stubs, etc.
1671   while (!is_compilation_disabled_forever()) {
1672     // We need this HandleMark to avoid leaking VM handles.
1673     HandleMark hm(thread);
1674 
1675     CompileTask* task = queue-&gt;get();
1676     if (task == NULL) {
1677       continue;
1678     }
1679 
1680     // Give compiler threads an extra quanta.  They tend to be bursty and
1681     // this helps the compiler to finish up the job.
1682     if (CompilerThreadHintNoPreempt) {
1683       os::hint_no_preempt();
1684     }
1685 
1686     // Assign the task to the current thread.  Mark this compilation
1687     // thread as active for the profiler.
1688     CompileTaskWrapper ctw(task);
1689     nmethodLocker result_handle;  // (handle for the nmethod produced by this task)
1690     task-&gt;set_code_handle(&amp;result_handle);
1691     methodHandle method(thread, task-&gt;method());
1692 
1693     // Never compile a method if breakpoints are present in it
1694     if (method()-&gt;number_of_breakpoints() == 0) {
1695       // Compile the method.
1696       if ((UseCompiler || AlwaysCompileLoopMethods) &amp;&amp; CompileBroker::should_compile_new_jobs()) {
1697         invoke_compiler_on_method(task);
1698       } else {
1699         // After compilation is disabled, remove remaining methods from queue
1700         method-&gt;clear_queued_for_compilation();
1701         task-&gt;set_failure_reason("compilation is disabled");
1702       }
1703     }
1704   }
1705 
1706   // Shut down compiler runtime
1707   shutdown_compiler_runtime(thread-&gt;compiler(), thread);
1708 }
1709 
1710 // ------------------------------------------------------------------
1711 // CompileBroker::init_compiler_thread_log
1712 //
1713 // Set up state required by +LogCompilation.
1714 void CompileBroker::init_compiler_thread_log() {
1715     CompilerThread* thread = CompilerThread::current();
1716     char  file_name[4*K];
1717     FILE* fp = NULL;
1718     intx thread_id = os::current_thread_id();
1719     for (int try_temp_dir = 1; try_temp_dir &gt;= 0; try_temp_dir--) {
1720       const char* dir = (try_temp_dir ? os::get_temp_directory() : NULL);
1721       if (dir == NULL) {
1722         jio_snprintf(file_name, sizeof(file_name), "hs_c" UINTX_FORMAT "_pid%u.log",
1723                      thread_id, os::current_process_id());
1724       } else {
1725         jio_snprintf(file_name, sizeof(file_name),
1726                      "%s%shs_c" UINTX_FORMAT "_pid%u.log", dir,
1727                      os::file_separator(), thread_id, os::current_process_id());
1728       }
1729 
1730       fp = fopen(file_name, "wt");
1731       if (fp != NULL) {
1732         if (LogCompilation &amp;&amp; Verbose) {
1733           tty-&gt;print_cr("Opening compilation log %s", file_name);
1734         }
1735         CompileLog* log = new(ResourceObj::C_HEAP, mtCompiler) CompileLog(file_name, fp, thread_id);
1736         thread-&gt;init_log(log);
1737 
1738         if (xtty != NULL) {
1739           ttyLocker ttyl;
1740           // Record any per thread log files
1741           xtty-&gt;elem("thread_logfile thread='" INTX_FORMAT "' filename='%s'", thread_id, file_name);
1742         }
1743         return;
1744       }
1745     }
1746     warning("Cannot open log file: %s", file_name);
1747 }
1748 
1749 void CompileBroker::log_metaspace_failure() {
1750   const char* message = "some methods may not be compiled because metaspace "
1751                         "is out of memory";
1752   if (_compilation_log != NULL) {
1753     _compilation_log-&gt;log_metaspace_failure(message);
1754   }
1755   if (PrintCompilation) {
1756     tty-&gt;print_cr("COMPILE PROFILING SKIPPED: %s", message);
1757   }
1758 }
1759 
1760 
1761 // ------------------------------------------------------------------
1762 // CompileBroker::set_should_block
1763 //
1764 // Set _should_block.
1765 // Call this from the VM, with Threads_lock held and a safepoint requested.
1766 void CompileBroker::set_should_block() {
1767   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
1768   assert(SafepointSynchronize::is_at_safepoint(), "must be at a safepoint already");
1769 #ifndef PRODUCT
1770   if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1771     tty-&gt;print_cr("notifying compiler thread pool to block");
1772 #endif
1773   _should_block = true;
1774 }
1775 
1776 // ------------------------------------------------------------------
1777 // CompileBroker::maybe_block
1778 //
1779 // Call this from the compiler at convenient points, to poll for _should_block.
1780 void CompileBroker::maybe_block() {
1781   if (_should_block) {
1782 #ifndef PRODUCT
1783     if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1784       tty-&gt;print_cr("compiler thread " INTPTR_FORMAT " poll detects block request", p2i(Thread::current()));
1785 #endif
1786     ThreadInVMfromNative tivfn(JavaThread::current());
1787   }
1788 }
1789 
1790 // wrapper for CodeCache::print_summary()
1791 static void codecache_print(bool detailed)
1792 {
1793   ResourceMark rm;
1794   stringStream s;
1795   // Dump code cache  into a buffer before locking the tty,
1796   {
1797     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1798     CodeCache::print_summary(&amp;s, detailed);
1799   }
1800   ttyLocker ttyl;
1801   tty-&gt;print("%s", s.as_string());
1802 }
1803 
1804 void CompileBroker::post_compile(CompilerThread* thread, CompileTask* task, EventCompilation&amp; event, bool success, ciEnv* ci_env) {
1805 
1806   if (success) {
1807     task-&gt;mark_success();
1808     if (ci_env != NULL) {
1809       task-&gt;set_num_inlined_bytecodes(ci_env-&gt;num_inlined_bytecodes());
1810     }
1811     if (_compilation_log != NULL) {
1812       nmethod* code = task-&gt;code();
1813       if (code != NULL) {
1814         _compilation_log-&gt;log_nmethod(thread, code);
1815       }
1816     }
1817   }
1818 
1819   // simulate crash during compilation
1820   assert(task-&gt;compile_id() != CICrashAt, "just as planned");
1821   if (event.should_commit()) {
1822     event.set_method(task-&gt;method());
1823     event.set_compileID(task-&gt;compile_id());
1824     event.set_compileLevel(task-&gt;comp_level());
1825     event.set_succeded(task-&gt;is_success());
1826     event.set_isOsr(task-&gt;osr_bci() != CompileBroker::standard_entry_bci);
1827     event.set_codeSize((task-&gt;code() == NULL) ? 0 : task-&gt;code()-&gt;total_size());
1828     event.set_inlinedBytes(task-&gt;num_inlined_bytecodes());
1829     event.commit();
1830   }
1831 }
1832 
1833 int DirectivesStack::_depth = 0;
1834 CompilerDirectives* DirectivesStack::_top = NULL;
1835 CompilerDirectives* DirectivesStack::_bottom = NULL;
1836 
1837 // ------------------------------------------------------------------
1838 // CompileBroker::invoke_compiler_on_method
1839 //
1840 // Compile a method.
1841 //
1842 void CompileBroker::invoke_compiler_on_method(CompileTask* task) {
1843   if (PrintCompilation) {
1844     ResourceMark rm;
1845     task-&gt;print_tty();
1846   }
1847   elapsedTimer time;
1848 
1849   CompilerThread* thread = CompilerThread::current();
1850   ResourceMark rm(thread);
1851 
1852   if (LogEvents) {
1853     _compilation_log-&gt;log_compile(thread, task);
1854   }
1855 
1856   // Common flags.
1857   uint compile_id = task-&gt;compile_id();
1858   int osr_bci = task-&gt;osr_bci();
1859   bool is_osr = (osr_bci != standard_entry_bci);
1860   bool should_log = (thread-&gt;log() != NULL);
1861   bool should_break = false;
1862   int task_level = task-&gt;comp_level();
1863 
1864   DirectiveSet* directive;
1865   {
1866     // create the handle inside it's own block so it can't
1867     // accidentally be referenced once the thread transitions to
1868     // native.  The NoHandleMark before the transition should catch
1869     // any cases where this occurs in the future.
1870     methodHandle method(thread, task-&gt;method());
1871     assert(!method-&gt;is_native(), "no longer compile natives");
1872 
1873     // Look up matching directives
1874     directive = DirectivesStack::getMatchingDirective(method, compiler(task_level));
1875 
1876     // Save information about this method in case of failure.
1877     set_last_compile(thread, method, is_osr, task_level);
1878 
1879     DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, compiler_name(task_level));
1880   }
1881 
1882   should_break = directive-&gt;BreakAtExecuteOption || task-&gt;check_break_at_flags();
1883   if (should_log &amp;&amp; !directive-&gt;LogOption) {
1884     should_log = false;
1885   }
1886 
1887   // Allocate a new set of JNI handles.
1888   push_jni_handle_block();
1889   Method* target_handle = task-&gt;method();
1890   int compilable = ciEnv::MethodCompilable;
1891   const char* failure_reason = NULL;
1892   const char* retry_message = NULL;
1893   AbstractCompiler *comp = compiler(task_level);
1894 
1895   int system_dictionary_modification_counter;
1896   {
1897     MutexLocker locker(Compile_lock, thread);
1898     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1899   }
1900 #if INCLUDE_JVMCI
1901   if (UseJVMCICompiler &amp;&amp; comp != NULL &amp;&amp; comp-&gt;is_jvmci()) {
1902     JVMCICompiler* jvmci = (JVMCICompiler*) comp;
1903 
1904     TraceTime t1("compilation", &amp;time);
1905     EventCompilation event;
1906 
1907     JVMCIEnv env(task, system_dictionary_modification_counter);
1908     methodHandle method(thread, target_handle);
1909     jvmci-&gt;compile_method(method, osr_bci, &amp;env);
1910 
1911     post_compile(thread, task, event, task-&gt;code() != NULL, NULL);
1912 
1913     failure_reason = env.failure_reason();
1914     if (!env.retryable()) {
1915       retry_message = "not retryable";
1916       compilable = ciEnv::MethodCompilable_not_at_tier;
1917     }
1918 
1919   } else
1920 #endif // INCLUDE_JVMCI
1921   {
1922     NoHandleMark  nhm;
1923     ThreadToNativeFromVM ttn(thread);
1924 
1925     ciEnv ci_env(task, system_dictionary_modification_counter);
1926     if (should_break) {
1927       ci_env.set_break_at_compile(true);
1928     }
1929     if (should_log) {
1930       ci_env.set_log(thread-&gt;log());
1931     }
1932     assert(thread-&gt;env() == &amp;ci_env, "set by ci_env");
1933     // The thread-env() field is cleared in ~CompileTaskWrapper.
1934 
1935     // Cache Jvmti state
1936     ci_env.cache_jvmti_state();
1937 
1938     // Cache DTrace flags
1939     ci_env.cache_dtrace_flags();
1940 
1941     ciMethod* target = ci_env.get_method_from_handle(target_handle);
1942 
1943     TraceTime t1("compilation", &amp;time);
1944     EventCompilation event;
1945 
1946     if (comp == NULL) {
1947       ci_env.record_method_not_compilable("no compiler", !TieredCompilation);
1948     } else {
1949       if (WhiteBoxAPI &amp;&amp; WhiteBox::compilation_locked) {
1950         MonitorLockerEx locker(Compilation_lock, Mutex::_no_safepoint_check_flag);
1951         while (WhiteBox::compilation_locked) {
1952           locker.wait(Mutex::_no_safepoint_check_flag);
1953         }
1954       }
1955       comp-&gt;compile_method(&amp;ci_env, target, osr_bci, directive);
1956     }
1957 
1958     if (!ci_env.failing() &amp;&amp; task-&gt;code() == NULL) {
1959       //assert(false, "compiler should always document failure");
1960       // The compiler elected, without comment, not to register a result.
1961       // Do not attempt further compilations of this method.
1962       ci_env.record_method_not_compilable("compile failed", !TieredCompilation);
1963     }
1964 
1965     // Copy this bit to the enclosing block:
1966     compilable = ci_env.compilable();
1967 
1968     if (ci_env.failing()) {
1969       failure_reason = ci_env.failure_reason();
1970       retry_message = ci_env.retry_message();
1971       ci_env.report_failure(failure_reason);
1972     }
1973 
1974     post_compile(thread, task, event, !ci_env.failing(), &amp;ci_env);
1975   }
1976   // Remove the JNI handle block after the ciEnv destructor has run in
1977   // the previous block.
1978   pop_jni_handle_block();
1979 
1980   if (failure_reason != NULL) {
1981     task-&gt;set_failure_reason(failure_reason);
1982     if (_compilation_log != NULL) {
1983       _compilation_log-&gt;log_failure(thread, task, failure_reason, retry_message);
1984     }
1985     if (PrintCompilation) {
1986       FormatBufferResource msg = retry_message != NULL ?
1987         FormatBufferResource("COMPILE SKIPPED: %s (%s)", failure_reason, retry_message) :
1988         FormatBufferResource("COMPILE SKIPPED: %s",      failure_reason);
1989       task-&gt;print(tty, msg);
1990     }
1991   }
1992 
1993   methodHandle method(thread, task-&gt;method());
1994 
1995   DTRACE_METHOD_COMPILE_END_PROBE(method, compiler_name(task_level), task-&gt;is_success());
1996 
1997   collect_statistics(thread, time, task);
1998 
1999   nmethod* nm = task-&gt;code();
2000   if (nm != NULL) {
2001     nm-&gt;maybe_print_nmethod(directive);
2002   }
2003   DirectivesStack::release(directive);
2004 
2005   if (PrintCompilation &amp;&amp; PrintCompilation2) {
2006     tty-&gt;print("%7d ", (int) tty-&gt;time_stamp().milliseconds());  // print timestamp
2007     tty-&gt;print("%4d ", compile_id);    // print compilation number
2008     tty-&gt;print("%s ", (is_osr ? "%" : " "));
2009     if (task-&gt;code() != NULL) {
2010       tty-&gt;print("size: %d(%d) ", task-&gt;code()-&gt;total_size(), task-&gt;code()-&gt;insts_size());
2011     }
2012     tty-&gt;print_cr("time: %d inlined: %d bytes", (int)time.milliseconds(), task-&gt;num_inlined_bytecodes());
2013   }
2014 
2015   if (PrintCodeCacheOnCompilation)
2016     codecache_print(/* detailed= */ false);
2017 
2018   // Disable compilation, if required.
2019   switch (compilable) {
2020   case ciEnv::MethodCompilable_never:
2021     if (is_osr)
2022       method-&gt;set_not_osr_compilable_quietly();
2023     else
2024       method-&gt;set_not_compilable_quietly();
2025     break;
2026   case ciEnv::MethodCompilable_not_at_tier:
2027     if (is_osr)
2028       method-&gt;set_not_osr_compilable_quietly(task_level);
2029     else
2030       method-&gt;set_not_compilable_quietly(task_level);
2031     break;
2032   }
2033 
2034   // Note that the queued_for_compilation bits are cleared without
2035   // protection of a mutex. [They were set by the requester thread,
2036   // when adding the task to the compile queue -- at which time the
2037   // compile queue lock was held. Subsequently, we acquired the compile
2038   // queue lock to get this task off the compile queue; thus (to belabour
2039   // the point somewhat) our clearing of the bits must be occurring
2040   // only after the setting of the bits. See also 14012000 above.
2041   method-&gt;clear_queued_for_compilation();
2042 
2043 #ifdef ASSERT
2044   if (CollectedHeap::fired_fake_oom()) {
2045     // The current compile received a fake OOM during compilation so
2046     // go ahead and exit the VM since the test apparently succeeded
2047     tty-&gt;print_cr("*** Shutting down VM after successful fake OOM");
2048     vm_exit(0);
2049   }
2050 #endif
2051 }
2052 
2053 /**
2054  * The CodeCache is full. Print warning and disable compilation.
2055  * Schedule code cache cleaning so compilation can continue later.
2056  * This function needs to be called only from CodeCache::allocate(),
2057  * since we currently handle a full code cache uniformly.
2058  */
2059 void CompileBroker::handle_full_code_cache(int code_blob_type) {
2060   UseInterpreter = true;
2061   if (UseCompiler || AlwaysCompileLoopMethods ) {
2062     if (xtty != NULL) {
2063       ResourceMark rm;
2064       stringStream s;
2065       // Dump code cache state into a buffer before locking the tty,
2066       // because log_state() will use locks causing lock conflicts.
2067       CodeCache::log_state(&amp;s);
2068       // Lock to prevent tearing
2069       ttyLocker ttyl;
2070       xtty-&gt;begin_elem("code_cache_full");
2071       xtty-&gt;print("%s", s.as_string());
2072       xtty-&gt;stamp();
2073       xtty-&gt;end_elem();
2074     }
2075 
2076 #ifndef PRODUCT
2077     if (CompileTheWorld || ExitOnFullCodeCache) {
2078       codecache_print(/* detailed= */ true);
2079       before_exit(JavaThread::current());
2080       exit_globals(); // will delete tty
2081       vm_direct_exit(CompileTheWorld ? 0 : 1);
2082     }
2083 #endif
2084     if (UseCodeCacheFlushing) {
2085       // Since code cache is full, immediately stop new compiles
2086       if (CompileBroker::set_should_compile_new_jobs(CompileBroker::stop_compilation)) {
2087         NMethodSweeper::log_sweep("disable_compiler");
2088       }
2089     } else {
2090       disable_compilation_forever();
2091     }
2092 
2093     CodeCache::report_codemem_full(code_blob_type, should_print_compiler_warning());
2094   }
2095 }
2096 
2097 // ------------------------------------------------------------------
2098 // CompileBroker::set_last_compile
2099 //
2100 // Record this compilation for debugging purposes.
2101 void CompileBroker::set_last_compile(CompilerThread* thread, const methodHandle&amp; method, bool is_osr, int comp_level) {
2102   ResourceMark rm;
2103   char* method_name = method-&gt;name()-&gt;as_C_string();
2104   strncpy(_last_method_compiled, method_name, CompileBroker::name_buffer_length);
2105   _last_method_compiled[CompileBroker::name_buffer_length - 1] = '\0'; // ensure null terminated
2106   char current_method[CompilerCounters::cmname_buffer_length];
2107   size_t maxLen = CompilerCounters::cmname_buffer_length;
2108 
2109   if (UsePerfData) {
2110     const char* class_name = method-&gt;method_holder()-&gt;name()-&gt;as_C_string();
2111 
2112     size_t s1len = strlen(class_name);
2113     size_t s2len = strlen(method_name);
2114 
2115     // check if we need to truncate the string
2116     if (s1len + s2len + 2 &gt; maxLen) {
2117 
2118       // the strategy is to lop off the leading characters of the
2119       // class name and the trailing characters of the method name.
2120 
2121       if (s2len + 2 &gt; maxLen) {
2122         // lop of the entire class name string, let snprintf handle
2123         // truncation of the method name.
2124         class_name += s1len; // null string
2125       }
2126       else {
2127         // lop off the extra characters from the front of the class name
2128         class_name += ((s1len + s2len + 2) - maxLen);
2129       }
2130     }
2131 
2132     jio_snprintf(current_method, maxLen, "%s %s", class_name, method_name);
2133   }
2134 
2135   if (CICountOSR &amp;&amp; is_osr) {
2136     _last_compile_type = osr_compile;
2137   } else {
2138     _last_compile_type = normal_compile;
2139   }
2140   _last_compile_level = comp_level;
2141 
2142   if (UsePerfData) {
2143     CompilerCounters* counters = thread-&gt;counters();
2144     counters-&gt;set_current_method(current_method);
2145     counters-&gt;set_compile_type((jlong)_last_compile_type);
2146   }
2147 }
2148 
2149 
2150 // ------------------------------------------------------------------
2151 // CompileBroker::push_jni_handle_block
2152 //
2153 // Push on a new block of JNI handles.
2154 void CompileBroker::push_jni_handle_block() {
2155   JavaThread* thread = JavaThread::current();
2156 
2157   // Allocate a new block for JNI handles.
2158   // Inlined code from jni_PushLocalFrame()
2159   JNIHandleBlock* java_handles = thread-&gt;active_handles();
2160   JNIHandleBlock* compile_handles = JNIHandleBlock::allocate_block(thread);
2161   assert(compile_handles != NULL &amp;&amp; java_handles != NULL, "should not be NULL");
2162   compile_handles-&gt;set_pop_frame_link(java_handles);  // make sure java handles get gc'd.
2163   thread-&gt;set_active_handles(compile_handles);
2164 }
2165 
2166 
2167 // ------------------------------------------------------------------
2168 // CompileBroker::pop_jni_handle_block
2169 //
2170 // Pop off the current block of JNI handles.
2171 void CompileBroker::pop_jni_handle_block() {
2172   JavaThread* thread = JavaThread::current();
2173 
2174   // Release our JNI handle block
2175   JNIHandleBlock* compile_handles = thread-&gt;active_handles();
2176   JNIHandleBlock* java_handles = compile_handles-&gt;pop_frame_link();
2177   thread-&gt;set_active_handles(java_handles);
2178   compile_handles-&gt;set_pop_frame_link(NULL);
2179   JNIHandleBlock::release_block(compile_handles, thread); // may block
2180 }
2181 
2182 // ------------------------------------------------------------------
2183 // CompileBroker::collect_statistics
2184 //
2185 // Collect statistics about the compilation.
2186 
2187 void CompileBroker::collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task) {
2188   bool success = task-&gt;is_success();
2189   methodHandle method (thread, task-&gt;method());
2190   uint compile_id = task-&gt;compile_id();
2191   bool is_osr = (task-&gt;osr_bci() != standard_entry_bci);
2192   nmethod* code = task-&gt;code();
2193   CompilerCounters* counters = thread-&gt;counters();
2194 
2195   assert(code == NULL || code-&gt;is_locked_by_vm(), "will survive the MutexLocker");
2196   MutexLocker locker(CompileStatistics_lock);
2197 
2198   // _perf variables are production performance counters which are
2199   // updated regardless of the setting of the CITime and CITimeEach flags
2200   //
2201 
2202   // account all time, including bailouts and failures in this counter;
2203   // C1 and C2 counters are counting both successful and unsuccessful compiles
2204   _t_total_compilation.add(time);
2205 
2206   if (!success) {
2207     _total_bailout_count++;
2208     if (UsePerfData) {
2209       _perf_last_failed_method-&gt;set_value(counters-&gt;current_method());
2210       _perf_last_failed_type-&gt;set_value(counters-&gt;compile_type());
2211       _perf_total_bailout_count-&gt;inc();
2212     }
2213     _t_bailedout_compilation.add(time);
2214   } else if (code == NULL) {
2215     if (UsePerfData) {
2216       _perf_last_invalidated_method-&gt;set_value(counters-&gt;current_method());
2217       _perf_last_invalidated_type-&gt;set_value(counters-&gt;compile_type());
2218       _perf_total_invalidated_count-&gt;inc();
2219     }
2220     _total_invalidated_count++;
2221     _t_invalidated_compilation.add(time);
2222   } else {
2223     // Compilation succeeded
2224 
2225     // update compilation ticks - used by the implementation of
2226     // java.lang.management.CompilationMBean
2227     _perf_total_compilation-&gt;inc(time.ticks());
2228     _peak_compilation_time = time.milliseconds() &gt; _peak_compilation_time ? time.milliseconds() : _peak_compilation_time;
2229 
2230     if (CITime) {
2231       int bytes_compiled = method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2232       if (is_osr) {
2233         _t_osr_compilation.add(time);
2234         _sum_osr_bytes_compiled += bytes_compiled;
2235       } else {
2236         _t_standard_compilation.add(time);
2237         _sum_standard_bytes_compiled += method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2238       }
2239 
2240 #if INCLUDE_JVMCI
2241       AbstractCompiler* comp = compiler(task-&gt;comp_level());
2242       if (comp) {
2243         CompilerStatistics* stats = comp-&gt;stats();
2244         if (stats) {
2245           if (is_osr) {
2246             stats-&gt;_osr.update(time, bytes_compiled);
2247           } else {
2248             stats-&gt;_standard.update(time, bytes_compiled);
2249           }
2250           stats-&gt;_nmethods_size += code-&gt;total_size();
2251           stats-&gt;_nmethods_code_size += code-&gt;insts_size();
2252         } else { // if (!stats)
2253           assert(false, "Compiler statistics object must exist");
2254         }
2255       } else { // if (!comp)
2256         assert(false, "Compiler object must exist");
2257       }
2258 #endif // INCLUDE_JVMCI
2259     }
2260 
2261     if (UsePerfData) {
2262       // save the name of the last method compiled
2263       _perf_last_method-&gt;set_value(counters-&gt;current_method());
2264       _perf_last_compile_type-&gt;set_value(counters-&gt;compile_type());
2265       _perf_last_compile_size-&gt;set_value(method-&gt;code_size() +
2266                                          task-&gt;num_inlined_bytecodes());
2267       if (is_osr) {
2268         _perf_osr_compilation-&gt;inc(time.ticks());
2269         _perf_sum_osr_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2270       } else {
2271         _perf_standard_compilation-&gt;inc(time.ticks());
2272         _perf_sum_standard_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2273       }
2274     }
2275 
2276     if (CITimeEach) {
2277       float bytes_per_sec = 1.0 * (method-&gt;code_size() + task-&gt;num_inlined_bytecodes()) / time.seconds();
2278       tty-&gt;print_cr("%3d   seconds: %f bytes/sec : %f (bytes %d + %d inlined)",
2279                     compile_id, time.seconds(), bytes_per_sec, method-&gt;code_size(), task-&gt;num_inlined_bytecodes());
2280     }
2281 
2282     // Collect counts of successful compilations
2283     _sum_nmethod_size      += code-&gt;total_size();
2284     _sum_nmethod_code_size += code-&gt;insts_size();
2285     _total_compile_count++;
2286 
2287     if (UsePerfData) {
2288       _perf_sum_nmethod_size-&gt;inc(     code-&gt;total_size());
2289       _perf_sum_nmethod_code_size-&gt;inc(code-&gt;insts_size());
2290       _perf_total_compile_count-&gt;inc();
2291     }
2292 
2293     if (is_osr) {
2294       if (UsePerfData) _perf_total_osr_compile_count-&gt;inc();
2295       _total_osr_compile_count++;
2296     } else {
2297       if (UsePerfData) _perf_total_standard_compile_count-&gt;inc();
2298       _total_standard_compile_count++;
2299     }
2300   }
2301   // set the current method for the thread to null
2302   if (UsePerfData) counters-&gt;set_current_method("");
2303 }
2304 
2305 const char* CompileBroker::compiler_name(int comp_level) {
2306   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
2307   if (comp == NULL) {
2308     return "no compiler";
2309   } else {
2310     return (comp-&gt;name());
2311   }
2312 }
2313 
2314 #if INCLUDE_JVMCI
2315 void CompileBroker::print_times(AbstractCompiler* comp) {
2316   CompilerStatistics* stats = comp-&gt;stats();
2317   if (stats) {
2318     tty-&gt;print_cr("  %s {speed: %d bytes/s; standard: %6.3f s, %d bytes, %d methods; osr: %6.3f s, %d bytes, %d methods; nmethods_size: %d bytes; nmethods_code_size: %d bytes}",
2319                 comp-&gt;name(), stats-&gt;bytes_per_second(),
2320                 stats-&gt;_standard._time.seconds(), stats-&gt;_standard._bytes, stats-&gt;_standard._count,
2321                 stats-&gt;_osr._time.seconds(), stats-&gt;_osr._bytes, stats-&gt;_osr._count,
2322                 stats-&gt;_nmethods_size, stats-&gt;_nmethods_code_size);
2323   } else { // if (!stats)
2324     assert(false, "Compiler statistics object must exist");
2325   }
2326   comp-&gt;print_timers();
2327 }
2328 #endif // INCLUDE_JVMCI
2329 
2330 void CompileBroker::print_times(bool per_compiler, bool aggregate) {
2331 #if INCLUDE_JVMCI
2332   elapsedTimer standard_compilation;
2333   elapsedTimer total_compilation;
2334   elapsedTimer osr_compilation;
2335 
2336   int standard_bytes_compiled = 0;
2337   int osr_bytes_compiled = 0;
2338 
2339   int standard_compile_count = 0;
2340   int osr_compile_count = 0;
2341   int total_compile_count = 0;
2342 
2343   int nmethods_size = 0;
2344   int nmethods_code_size = 0;
2345   bool printedHeader = false;
2346 
2347   for (unsigned int i = 0; i &lt; sizeof(_compilers) / sizeof(AbstractCompiler*); i++) {
2348     AbstractCompiler* comp = _compilers[i];
2349     if (comp != NULL) {
2350       if (per_compiler &amp;&amp; aggregate &amp;&amp; !printedHeader) {
2351         printedHeader = true;
2352         tty-&gt;cr();
2353         tty-&gt;print_cr("Individual compiler times (for compiled methods only)");
2354         tty-&gt;print_cr("------------------------------------------------");
2355         tty-&gt;cr();
2356       }
2357       CompilerStatistics* stats = comp-&gt;stats();
2358 
2359       if (stats) {
2360         standard_compilation.add(stats-&gt;_standard._time);
2361         osr_compilation.add(stats-&gt;_osr._time);
2362 
2363         standard_bytes_compiled += stats-&gt;_standard._bytes;
2364         osr_bytes_compiled += stats-&gt;_osr._bytes;
2365 
2366         standard_compile_count += stats-&gt;_standard._count;
2367         osr_compile_count += stats-&gt;_osr._count;
2368 
2369         nmethods_size += stats-&gt;_nmethods_size;
2370         nmethods_code_size += stats-&gt;_nmethods_code_size;
2371       } else { // if (!stats)
2372         assert(false, "Compiler statistics object must exist");
2373       }
2374 
2375       if (per_compiler) {
2376         print_times(comp);
2377       }
2378     }
2379   }
2380   total_compile_count = osr_compile_count + standard_compile_count;
2381   total_compilation.add(osr_compilation);
2382   total_compilation.add(standard_compilation);
2383 
2384   // In hosted mode, print the JVMCI compiler specific counters manually.
2385   if (!UseJVMCICompiler) {
2386     JVMCICompiler::print_compilation_timers();
2387   }
2388 #else // INCLUDE_JVMCI
2389   elapsedTimer standard_compilation = CompileBroker::_t_standard_compilation;
2390   elapsedTimer osr_compilation = CompileBroker::_t_osr_compilation;
2391   elapsedTimer total_compilation = CompileBroker::_t_total_compilation;
2392 
2393   int standard_bytes_compiled = CompileBroker::_sum_standard_bytes_compiled;
2394   int osr_bytes_compiled = CompileBroker::_sum_osr_bytes_compiled;
2395 
2396   int standard_compile_count = CompileBroker::_total_standard_compile_count;
2397   int osr_compile_count = CompileBroker::_total_osr_compile_count;
2398   int total_compile_count = CompileBroker::_total_compile_count;
2399 
2400   int nmethods_size = CompileBroker::_sum_nmethod_code_size;
2401   int nmethods_code_size = CompileBroker::_sum_nmethod_size;
2402 #endif // INCLUDE_JVMCI
2403 
2404   if (!aggregate) {
2405     return;
2406   }
2407   tty-&gt;cr();
2408   tty-&gt;print_cr("Accumulated compiler times");
2409   tty-&gt;print_cr("----------------------------------------------------------");
2410                //0000000000111111111122222222223333333333444444444455555555556666666666
2411                //0123456789012345678901234567890123456789012345678901234567890123456789
2412   tty-&gt;print_cr("  Total compilation time   : %7.3f s", total_compilation.seconds());
2413   tty-&gt;print_cr("    Standard compilation   : %7.3f s, Average : %2.3f s",
2414                 standard_compilation.seconds(),
2415                 standard_compilation.seconds() / standard_compile_count);
2416   tty-&gt;print_cr("    Bailed out compilation : %7.3f s, Average : %2.3f s",
2417                 CompileBroker::_t_bailedout_compilation.seconds(),
2418                 CompileBroker::_t_bailedout_compilation.seconds() / CompileBroker::_total_bailout_count);
2419   tty-&gt;print_cr("    On stack replacement   : %7.3f s, Average : %2.3f s",
2420                 osr_compilation.seconds(),
2421                 osr_compilation.seconds() / osr_compile_count);
2422   tty-&gt;print_cr("    Invalidated            : %7.3f s, Average : %2.3f s",
2423                 CompileBroker::_t_invalidated_compilation.seconds(),
2424                 CompileBroker::_t_invalidated_compilation.seconds() / CompileBroker::_total_invalidated_count);
2425 
2426   AbstractCompiler *comp = compiler(CompLevel_simple);
2427   if (comp != NULL) {
2428     tty-&gt;cr();
2429     comp-&gt;print_timers();
2430   }
2431   comp = compiler(CompLevel_full_optimization);
2432   if (comp != NULL) {
2433     tty-&gt;cr();
2434     comp-&gt;print_timers();
2435   }
2436   tty-&gt;cr();
2437   tty-&gt;print_cr("  Total compiled methods    : %8d methods", total_compile_count);
2438   tty-&gt;print_cr("    Standard compilation    : %8d methods", standard_compile_count);
2439   tty-&gt;print_cr("    On stack replacement    : %8d methods", osr_compile_count);
2440   int tcb = osr_bytes_compiled + standard_bytes_compiled;
2441   tty-&gt;print_cr("  Total compiled bytecodes  : %8d bytes", tcb);
2442   tty-&gt;print_cr("    Standard compilation    : %8d bytes", standard_bytes_compiled);
2443   tty-&gt;print_cr("    On stack replacement    : %8d bytes", osr_bytes_compiled);
2444   double tcs = total_compilation.seconds();
2445   int bps = tcs == 0.0 ? 0 : (int)(tcb / tcs);
2446   tty-&gt;print_cr("  Average compilation speed : %8d bytes/s", bps);
2447   tty-&gt;cr();
2448   tty-&gt;print_cr("  nmethod code size         : %8d bytes", nmethods_code_size);
2449   tty-&gt;print_cr("  nmethod total size        : %8d bytes", nmethods_size);
2450 }
2451 
2452 // Debugging output for failure
2453 void CompileBroker::print_last_compile() {
2454   if ( _last_compile_level != CompLevel_none &amp;&amp;
2455        compiler(_last_compile_level) != NULL &amp;&amp;
2456        _last_method_compiled != NULL &amp;&amp;
2457        _last_compile_type != no_compile) {
2458     if (_last_compile_type == osr_compile) {
2459       tty-&gt;print_cr("Last parse:  [osr]%d+++(%d) %s",
2460                     _osr_compilation_id, _last_compile_level, _last_method_compiled);
2461     } else {
2462       tty-&gt;print_cr("Last parse:  %d+++(%d) %s",
2463                     _compilation_id, _last_compile_level, _last_method_compiled);
2464     }
2465   }
2466 }
2467 
</pre></body></html>
